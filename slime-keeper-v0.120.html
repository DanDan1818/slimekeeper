<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slime Keeper v0.120</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Comic Sans MS', cursive;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
        }
        
        /* Main Game Container */
        #game-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            height: 100vh;
            margin: 0 auto;
            background: #f0f0f0;
            overflow: hidden;
        }
        
        /* Top UI Bar */
        #top-ui {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 700px;
            height: 60px;
            background: rgba(255,255,255,0.95);
            border-bottom: 3px solid #333;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 500;
            padding: 0 10px;
        }
        
        .stat-display {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 11px;
            color: #666;
        }
        
        /* Main Content Area */
        #main-area {
            position: absolute;
            top: 60px;
            bottom: 72px;
            width: 100%;
            overflow: hidden;
        }
        
        /* Rooms */
        .room {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
        
        .room.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* Home Room - Slime Display */
        #slime-square {
            width: 200px;
            height: 200px;
            background: #4dd0e1;
            border-radius: 20px;
            position: relative;
        }
        
        /* Bottom Navigation */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 700px;
            height: 72px;
            background: rgba(255,255,255,0.95);
            border-top: 3px solid #333;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 500;
        }
        
        .nav-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 10px 20px;
            transition: transform 0.1s;
            position: relative;
            z-index: 9999;
        }
        
        .nav-btn:active {
            transform: scale(0.95);
        }
        
        /* Basket Container - Physics Canvas */
        .basket-container {
            position: fixed;
            bottom: 72px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 700px;
            height: 1200px;
            z-index: 140;
            display: none;
            pointer-events: none;
        }
        
        .basket-container.active {
            display: block;
        }
        
        .basket-container canvas {
            pointer-events: auto;
        }
        
        /* Basket Close Button */
        .basket-close-btn {
            position: absolute;
            left: 230px;
            top: 1185px;
            width: 30px;
            height: 30px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #444;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            pointer-events: auto;
        }
        
        .basket-close-btn:active {
            background: #ccc;
            transform: scale(0.95);
        }
        
        /* Slime Mouth - Eating Indicator */
        #slime-mouth {
            position: absolute;
            left: 350px;
            top: 750px;
            width: 40px;
            height: 40px;
            background: #000;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        /* Notifications */
        #notifications {
            position: fixed;
            top: 80px;
            left: 10px;
            width: 300px;
            z-index: 999;
            pointer-events: none;
        }
        
        .notification {
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 14px;
            animation: slideIn 0.3s, fadeOut 0.3s 2.7s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; }
        }
        
        /* Inventory Counter */
        #inventory-counter {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            z-index: 201;
            pointer-events: none;
        }
        
        /* Mouse Coordinates Debug */
        #mouse-coords {
            position: fixed;
            bottom: 80px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 8px;
            font-size: 12px;
            z-index: 9999;
            border-radius: 4px;
            font-family: monospace;
        }
        
        /* Fishing Minigame */
        #fishing-game-pond,
        #fishing-game-river {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        /* River timing minigame */
        #fishing-bar-container-river {
            position: relative;
            width: 300px;
            height: 40px;
            background: #ddd;
            border: 3px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #fishing-bar-river {
            position: absolute;
            left: 0;
            top: 0;
            width: 30px;
            height: 100%;
            background: #4dd0e1;
            border-right: 3px solid #333;
        }
        
        #fishing-target-river {
            position: absolute;
            width: 80px;
            height: 100%;
            background: rgba(76, 175, 80, 0.5);
            border: 3px solid #4caf50;
        }
        
        #fishing-timer-river {
            font-size: 24px;
            font-weight: bold;
            min-height: 30px;
        }
        
        
        /* Sell Basket (Shop) */
        .sell-basket-container {
            position: fixed;
            bottom: 72px;
            right: 0;
            width: 350px;
            height: 600px;
            z-index: 130;
            display: none;
            pointer-events: none;
        }
        
        .sell-basket-container.active {
            display: block;
        }
        
        .sell-basket-container canvas {
            pointer-events: auto;
        }
        
        /* Buttons */
        button {
            padding: 12px 24px;
            font-size: 16px;
            background: #4dd0e1;
            border: 3px solid #333;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
            transition: all 0.1s;
            position: relative;
            z-index: 9999;
        }
        
        button:hover {
            background: #26c6da;
        }
        
        button:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- Top UI Stats -->
    <div id="top-ui">
        <div class="stat-display">
            <div class="stat-label">HUNGER</div>
            <div id="hunger-display">100</div>
        </div>
        <div class="stat-display">
            <div class="stat-label">LEVEL</div>
            <div id="level-display">1</div>
        </div>
    </div>
    
    <!-- Main Game Area -->
    <div id="game-container">
        <div id="main-area">
            <!-- Home Room -->
            <div class="room active" id="home-room">
                <div id="slime-square"></div>
                <button id="hatch-btn">ü•ö Hatch Slime</button>
            </div>
            
            <!-- Area Room - Activities Menu -->
            <div class="room" id="area-room">
                <h2>Activities</h2>
                <button id="goto-fishing-menu">üé£ Fishing</button>
                <button id="goto-farming-menu">üåæ Farming</button>
                <button id="goto-cooking-menu">üç≥ Cooking</button>
            </div>
            
            <!-- Fishing Menu - Select Area -->
            <div class="room" id="fishing-menu-room">
                <h2>üé£ Fishing Areas</h2>
                <button id="goto-pond">ü™∑ The Pond</button>
                <button id="goto-river">üåä The River</button>
                <button id="back-to-area" style="background:#999;">‚Üê Back</button>
            </div>
            
            <!-- Fishing Minigame - The Pond -->
            <div class="room" id="fishing-pond-room">
                <h2>ü™∑ The Pond</h2>
                <div id="fishing-game-pond">
                    <div id="fishing-progress-pond" style="width:200px;height:30px;background:#ddd;border:3px solid #333;border-radius:8px;position:relative;overflow:hidden;">
                        <div id="fishing-bar-pond" style="width:0%;height:100%;background:#4dd0e1;transition:width 0.1s;"></div>
                    </div>
                    <button id="fish-pond-btn">üé£ Fish (Hold)</button>
                    <div id="fishing-result-pond" style="min-height:30px;font-size:18px;font-weight:bold;"></div>
                </div>
                <button id="leave-pond" style="background:#999;">‚Üê Leave</button>
            </div>
            
            <!-- Fishing Minigame - The River -->
            <div class="room" id="fishing-river-room">
                <h2>üåä The River</h2>
                <div id="fishing-game-river">
                    <div id="fishing-bar-container-river">
                        <div id="fishing-bar-river"></div>
                        <div id="fishing-target-river"></div>
                    </div>
                    <button id="cast-river">üé£ Cast Line (Hold)</button>
                    <div id="fishing-timer-river"></div>
                </div>
                <button id="leave-river" style="background:#999;">‚Üê Leave</button>
            </div>
            
            
            <!-- Farming Menu - Select Area -->
            <div class="room" id="farming-menu-room">
                <h2>üåæ Farming Areas</h2>
                <button id="goto-garden">üåª The Garden</button>
                <button id="goto-field">üåæ The Field</button>
                <button id="back-to-area-farm" style="background:#999;">‚Üê Back</button>
            </div>
            
            <!-- Farming - The Garden (Rapid Tap) -->
            <div class="room" id="farming-garden-room">
                <h2>üåª The Garden</h2>
                <div id="farming-game-garden">
                    <div style="font-size:18px;margin-bottom:10px;">Tap quickly to pull weeds!</div>
                    <div id="garden-taps-display" style="font-size:24px;font-weight:bold;margin:10px;">Taps: 0 / 20</div>
                    <div id="garden-timer-display" style="font-size:20px;margin:10px;">Time: 5.0s</div>
                    <button id="tap-garden-btn" style="width:200px;height:200px;font-size:48px;">üå±<br>TAP!</button>
                    <div id="garden-result" style="min-height:30px;font-size:18px;font-weight:bold;margin-top:10px;"></div>
                </div>
                <button id="leave-garden" style="background:#999;">‚Üê Leave</button>
            </div>
            
            <!-- Farming - The Field (Pattern Match) -->
            <div class="room" id="farming-field-room">
                <h2>üåæ The Field</h2>
                <div id="farming-game-field">
                    <div style="font-size:18px;margin-bottom:10px;">Plant in the correct order!</div>
                    <div id="field-pattern-display" style="font-size:32px;margin:15px;letter-spacing:10px;"></div>
                    <div id="field-input-display" style="font-size:32px;margin:15px;letter-spacing:10px;min-height:45px;"></div>
                    <div style="display:flex;gap:10px;margin:15px;">
                        <button class="plant-btn" data-plant="üåΩ" style="font-size:40px;width:70px;height:70px;">üåΩ</button>
                        <button class="plant-btn" data-plant="ü•ï" style="font-size:40px;width:70px;height:70px;">ü•ï</button>
                        <button class="plant-btn" data-plant="ü•î" style="font-size:40px;width:70px;height:70px;">ü•î</button>
                    </div>
                    <button id="reset-field-btn" style="background:#ff9800;">Reset</button>
                    <div id="field-result" style="min-height:30px;font-size:18px;font-weight:bold;margin-top:10px;"></div>
                </div>
                <button id="leave-field" style="background:#999;">‚Üê Leave</button>
            </div>
            
            <!-- Cooking Menu - Select Area -->
            <div class="room" id="cooking-menu-room">
                <h2>üç≥ Cooking Areas</h2>
                <button id="goto-kitchen">üî• The Kitchen</button>
                <button id="goto-grill">üçñ The Grill</button>
                <button id="back-to-area-cook" style="background:#999;">‚Üê Back</button>
            </div>
            
            <!-- Cooking - The Kitchen (Rhythm Game) -->
            <div class="room" id="cooking-kitchen-room">
                <h2>üî• The Kitchen</h2>
                <div id="cooking-game-kitchen">
                    <div style="font-size:18px;margin-bottom:10px;">Stir when the spoon flashes!</div>
                    <div id="kitchen-spoon" style="font-size:80px;margin:20px;transition:transform 0.1s;">ü•Ñ</div>
                    <div id="kitchen-score-display" style="font-size:24px;font-weight:bold;margin:10px;">Score: 0 / 5</div>
                    <button id="stir-kitchen-btn" style="width:200px;height:80px;font-size:24px;">ü•Ñ STIR!</button>
                    <div id="kitchen-result" style="min-height:30px;font-size:18px;font-weight:bold;margin-top:10px;"></div>
                </div>
                <button id="leave-kitchen" style="background:#999;">‚Üê Leave</button>
            </div>
            
            <!-- Cooking - The Grill (Temperature Control) -->
            <div class="room" id="cooking-grill-room">
                <h2>üçñ The Grill</h2>
                <div id="cooking-game-grill">
                    <div style="font-size:18px;margin-bottom:10px;">Keep temperature in the green zone!</div>
                    <div id="grill-temp-container" style="width:300px;height:50px;background:#ddd;border:3px solid #333;border-radius:8px;position:relative;margin:20px auto;">
                        <div id="grill-temp-bar" style="position:absolute;left:0;height:100%;width:50%;background:#ff6b6b;transition:width 0.3s;"></div>
                        <div id="grill-temp-green" style="position:absolute;left:40%;width:20%;height:100%;background:rgba(76,175,80,0.5);border:2px solid #4caf50;"></div>
                    </div>
                    <div id="grill-temp-display" style="font-size:24px;font-weight:bold;margin:10px;">Temp: 50%</div>
                    <div style="display:flex;gap:10px;justify-content:center;margin:15px;">
                        <button id="grill-heat-up" style="width:120px;background:#ff5722;">üî• Heat Up</button>
                        <button id="grill-cool-down" style="width:120px;background:#2196f3;">‚ùÑÔ∏è Cool Down</button>
                    </div>
                    <div id="grill-timer-display" style="font-size:20px;margin:10px;">Time: 10.0s</div>
                    <div id="grill-result" style="min-height:30px;font-size:18px;font-weight:bold;margin-top:10px;"></div>
                </div>
                <button id="leave-grill" style="background:#999;">‚Üê Leave</button>
            </div>
            <!-- Shop Room -->
            <div class="room" id="shop-room">
                <h2>Shop</h2>
                <button id="buy-fish">Buy Fish - 10 coins</button>
                <button id="buy-carrot">Buy Carrot - 5 coins</button>
            </div>
            
            <!-- Debug Room -->
            <div class="room" id="debug-room">
                <h2>Debug Tools</h2>
                <button id="fill-bag">Fill Inventory</button>
                <button id="clear-bag">Clear Inventory</button>
            </div>
        </div>
        
        <!-- Basket Physics Container -->
        <div class="basket-container" id="basket-container">
            <canvas id="basket-canvas" width="700" height="1200"></canvas>
            <button class="basket-close-btn" id="basket-close">√ó</button>
            <div id="slime-mouth"></div>
            <div id="inventory-counter">0/6</div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div id="bottom-nav">
        <button class="nav-btn" id="nav-home">üè†</button>
        <button class="nav-btn" id="nav-area">üéÆ</button>
        <button class="nav-btn" id="nav-shop">üõí</button>
        <button class="nav-btn" id="nav-bag">üéí</button>
        <button class="nav-btn" id="nav-debug">üîß</button>
    </div>
    
    
        <!-- Sell Basket Container (Shop only) -->
        <div class="sell-basket-container" id="sell-basket-container">
            <canvas id="sell-basket-canvas" width="350" height="600"></canvas>
            <div id="sell-basket-label" style="position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:#fff;padding:8px 16px;border-radius:20px;font-size:16px;font-weight:bold;z-index:201;pointer-events:none;">üí∞ Sell Basket</div>
        </div>
    <!-- Notifications -->
    <div id="notifications"></div>
    
    <!-- Mouse Coordinates -->
    <div id="mouse-coords">0, 0</div>
    
    <script>
        // ===== GAME STATE =====
        const gs = {
            hatched: false,
            hunger: 100,
            level: 1,
            coins: 100,
            inventory: {}, // Format: { 'fish_0': 1, 'carrot_1': 1 }
            itemCounter: 0 // For unique item keys
        };
        
        // ===== CONSTANTS =====
        const MAX_INVENTORY = 6;
        
        const ITEM_COLORS = {
            'fish': '#4dd0e1',
            'carrot': '#ffaa44',
            'food': '#ff6b9d'
        };
        
        // ===== BASKET PHYSICS =====
        const { Engine, Render, Bodies, World, Mouse, MouseConstraint, Events, Runner } = Matter;
        
        let basketEngine = null;
        let basketRender = null;
        let basketRunner = null;
        let basketBodies = [];
        
        // Sell basket
        let sellBasketEngine = null;
        let sellBasketRender = null;
        let sellBasketRunner = null;
        let sellBasketBodies = [];
        let sellBasketMouseConstraint = null;
        let mouseConstraint = null;
        
        // ===== UTILITY FUNCTIONS =====
        function notify(message) {
            const container = document.getElementById('notifications');
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            container.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }
        
        function save() {
            localStorage.setItem('slimeKeeper', JSON.stringify(gs));
        }
        
        function load() {
            const saved = localStorage.getItem('slimeKeeper');
            if (saved) {
                Object.assign(gs, JSON.parse(saved));
                updateUI();
            }
        }
        
        function updateInventoryCounter() {
            const counter = document.getElementById('inventory-counter');
            if (counter) {
                const count = Object.keys(gs.inventory).length;
                counter.textContent = count + '/' + MAX_INVENTORY;
            }
        }
        
        function updateUI() {
            document.getElementById('hunger-display').textContent = gs.hunger;
            document.getElementById('level-display').textContent = gs.level;
            
            // Show/hide hatch button
            const hatchBtn = document.getElementById('hatch-btn');
            hatchBtn.style.display = gs.hatched ? 'none' : 'block';
        }
        
        function addItem(itemId, quantity = 1) {
            const currentCount = Object.keys(gs.inventory).length;
            const spaceLeft = MAX_INVENTORY - currentCount;
            
            if (spaceLeft <= 0) {
                notify('Inventory full! (6/6)');
                return;
            }
            
            const toAdd = Math.min(quantity, spaceLeft);
            for (let i = 0; i < toAdd; i++) {
                const key = itemId + '_' + gs.itemCounter++;
                gs.inventory[key] = 1;
            }
            save();
            
            if (toAdd < quantity) {
                notify(`+${toAdd} ${itemId} (inventory full!)`);
            } else {
                notify(`+${toAdd} ${itemId}`);
            }
            
            updateInventoryCounter();
            
            // Only spawn new items in basket if basket is open
            const container = document.getElementById('basket-container');
            if (container && container.classList.contains('active') && basketEngine) {
                // Spawn only the newly added items
                for (let i = 0; i < toAdd; i++) {
                    const key = itemId + '_' + (gs.itemCounter - toAdd + i);
                    spawnSingleItem(key);
                }
            }
        }
        
        // ===== NAVIGATION =====
        function switchRoom(roomId) {
            document.querySelectorAll('.room').forEach(r => r.classList.remove('active'));
            document.getElementById(roomId).classList.add('active');
            
            // Show sell basket in shop, hide elsewhere
            const sellContainer = document.getElementById('sell-basket-container');
            if (roomId === 'shop-room') {
                sellContainer.classList.add('active');
                if (!sellBasketEngine) initSellBasket();
                else populateSellBasket();
            } else {
                sellContainer.classList.remove('active');
                stopSellBasket();
            }
        }
        
        document.getElementById('nav-home').onclick = () => switchRoom('home-room');
        document.getElementById('nav-area').onclick = () => switchRoom('area-room');
        document.getElementById('nav-shop').onclick = () => switchRoom('shop-room');
        document.getElementById('nav-debug').onclick = () => switchRoom('debug-room');
        
        document.getElementById('nav-bag').onclick = () => {
            const container = document.getElementById('basket-container');
            if (container.classList.contains('active')) {
                container.classList.remove('active');
                stopBasket();
            } else {
                container.classList.add('active');
                if (!basketEngine) initBasket();
                else populateBasket();
            }
        };
        
        // ===== BASKET SYSTEM =====
        function initBasket() {
            const canvas = document.getElementById('basket-canvas');
            if (!canvas) return;
            
            // Create engine
            basketEngine = Engine.create();
            basketEngine.world.bounds = { min: { x: -1000, y: -1000 }, max: { x: 1700, y: 1700 } };
            basketEngine.gravity.y = 0.5;
            
            // Create renderer
            basketRender = Render.create({
                canvas: canvas,
                engine: basketEngine,
                options: {
                    width: 700,
                    height: 1200,
                    wireframes: false,
                    background: 'transparent'
                }
            });
            
            // Create basket walls (no top)
            const basketCenterX = 150;
            const basketBottom = 1194;
            const basketWidth = 180;
            const wallHeight = 112;
            const wallThickness = 6;
            
            const leftWall = Bodies.rectangle(
                basketCenterX - basketWidth/2 + wallThickness/2,
                basketBottom - wallHeight/2,
                wallThickness,
                wallHeight,
                { isStatic: true, render: { fillStyle: '#444' } }
            );
            
            const rightWall = Bodies.rectangle(
                basketCenterX + basketWidth/2 - wallThickness/2,
                basketBottom - wallHeight/2,
                wallThickness,
                wallHeight,
                { isStatic: true, render: { fillStyle: '#444' } }
            );
            
            const bottom = Bodies.rectangle(
                basketCenterX,
                basketBottom - 10,
                basketWidth,
                20,
                { isStatic: true, render: { fillStyle: '#444' } }
            );
            
            // Invisible floor at canvas bottom
            const invisibleFloor = Bodies.rectangle(
                350, 1230, 1000, 100,
                { isStatic: true, render: { visible: false } }
            );
            
            World.add(basketEngine.world, [leftWall, rightWall, bottom, invisibleFloor]);
            
            // Velocity limiter
            Events.on(basketEngine, 'beforeUpdate', () => {
                basketBodies.forEach(body => {
                    const maxSpeed = 21.5;
                    const speed = Math.sqrt(body.velocity.x ** 2 + body.velocity.y ** 2);
                    
                    if (speed > maxSpeed) {
                        const scale = maxSpeed / speed;
                        Matter.Body.setVelocity(body, {
                            x: body.velocity.x * scale,
                            y: body.velocity.y * scale
                        });
                    }
                });
            });
            
            // Return forces for items outside basket
            Events.on(basketEngine, 'afterUpdate', () => {
                const basketLeft = 65;
                const basketRight = 235;
                const basketTop = 1080;
                
                basketBodies.forEach(body => {
                    const nearFloor = body.position.y > 1150;
                    const aboveBasket = body.position.y < basketTop;
                    
                    if (body.position.x < basketLeft) {
                        const pullStrength = nearFloor ? 0.06 : 0.00002;
                        const upForce = nearFloor ? -0.07 : 0;
                        Matter.Body.applyForce(body, body.position, { x: pullStrength, y: upForce });
                    } else if (body.position.x > basketRight) {
                        const pullStrength = nearFloor ? 0.06 : 0.00002;
                        const upForce = nearFloor ? -0.07 : 0;
                        Matter.Body.applyForce(body, body.position, { x: -pullStrength, y: upForce });
                    }
                    
                    if (aboveBasket && body.position.x > basketLeft && body.position.x < basketRight) {
                        Matter.Body.applyForce(body, body.position, { x: 0, y: 0.01 });
                    }
                });
            });
            
            // Eating mechanic - only on home screen
            Events.on(basketEngine, 'beforeUpdate', () => {
                if (!gs.hatched) return;
                
                const homeRoom = document.getElementById('home-room');
                const isHome = homeRoom && homeRoom.classList.contains('active');
                
                const slimeX = 350;
                const slimeY = 750;
                const mouth = document.getElementById('slime-mouth');
                
                // Show/hide mouth based on screen
                if (mouth) {
                    mouth.style.display = isHome ? 'block' : 'none';
                }
                
                if (!isHome) return;
                
                let foodNearby = false;
                
                for (let i = basketBodies.length - 1; i >= 0; i--) {
                    const b = basketBodies[i];
                    if (!b || !b.itemId) continue;
                    
                    if (b.itemId === 'fish' || b.itemId === 'carrot') {
                        const dist = Math.sqrt((b.position.x - slimeX)**2 + (b.position.y - slimeY)**2);
                        
                        if (dist < 80) {
                            foodNearby = true;
                        }
                        
                        if (dist < 40) {
                            World.remove(basketEngine.world, b);
                            basketBodies.splice(i, 1);
                            delete gs.inventory[b.itemKey];
                            gs.hunger = Math.min(100, gs.hunger + 10);
                            notify('+10 hunger!');
                            save();
                            updateUI();
                            updateInventoryCounter();
                        }
                    }
                }
                
                if (mouth) {
                    mouth.style.opacity = foodNearby ? '1' : '0';
                }
            });
            
            // Mouse control
            const mouse = Mouse.create(canvas);
            mouseConstraint = MouseConstraint.create(basketEngine, {
                mouse: mouse,
                constraint: {
                    stiffness: 1.9,
                    render: { visible: false }
                }
            });
            World.add(basketEngine.world, mouseConstraint);
            
            // Mouse coordinates debug
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const coordsDiv = document.getElementById('mouse-coords');
                if (coordsDiv) {
                    coordsDiv.textContent = Math.round(x) + ', ' + Math.round(y);
                }
            });
            
            // Populate with items
            populateBasket();
            
            // Run engine
            basketRunner = Runner.create();
            Runner.run(basketRunner, basketEngine);
            Render.run(basketRender);
        }
        
        function spawnSingleItem(key) {
            if (!basketEngine) return;
            const { Bodies, World } = Matter;
            
            const itemId = key.split('_')[0];
            const color = ITEM_COLORS[itemId] || '#ff6b9d';
            
            // Spawn at top-center
            const x = 80 + Math.random() * 140;
            const y = -50;
            
            const box = Bodies.rectangle(x, y, 40, 40, {
                restitution: 0.4,
                friction: 0.8,
                render: { fillStyle: color },
                itemKey: key,
                itemId: itemId
            });
            
            World.add(basketEngine.world, box);
            basketBodies.push(box);
        }
        
        function populateBasket() {
            if (!basketEngine) return;
            
            // Clear existing items
            basketBodies.forEach(body => World.remove(basketEngine.world, body));
            basketBodies = [];
            
            // Add items from inventory
            const items = Object.keys(gs.inventory);
            items.forEach((key, idx) => {
                const itemId = key.split('_')[0];
                const color = ITEM_COLORS[itemId] || '#ff6b9d';
                
                const x = 80 + Math.random() * 140;
                const y = -50 - (idx * 45);
                
                const box = Bodies.rectangle(x, y, 40, 40, {
                    restitution: 0.4,
                    friction: 0.8,
                    render: { fillStyle: color },
                    itemKey: key,
                    itemId: itemId
                });
                
                World.add(basketEngine.world, box);
                basketBodies.push(box);
            });
            
            updateInventoryCounter();
        }
        
        
        function initSellBasket() {
            const canvas = document.getElementById('sell-basket-canvas');
            if (!canvas) return;
            
            // Create engine
            sellBasketEngine = Engine.create();
            sellBasketEngine.world.bounds = { min: { x: -500, y: -500 }, max: { x: 850, y: 1100 } };
            sellBasketEngine.gravity.y = 0.5;
            
            // Create renderer
            sellBasketRender = Render.create({
                canvas: canvas,
                engine: sellBasketEngine,
                options: {
                    width: 350,
                    height: 600,
                    wireframes: false,
                    background: 'transparent'
                }
            });
            
            // Create sell basket walls (centered in 350px width)
            const basketCenterX = 175;
            const basketBottom = 580;
            const basketWidth = 180;
            const wallHeight = 112;
            const wallThickness = 6;
            
            const leftWall = Bodies.rectangle(
                basketCenterX - basketWidth/2 + wallThickness/2,
                basketBottom - wallHeight/2,
                wallThickness,
                wallHeight,
                { isStatic: true, render: { fillStyle: '#888' } }
            );
            
            const rightWall = Bodies.rectangle(
                basketCenterX + basketWidth/2 - wallThickness/2,
                basketBottom - wallHeight/2,
                wallThickness,
                wallHeight,
                { isStatic: true, render: { fillStyle: '#888' } }
            );
            
            const bottom = Bodies.rectangle(
                basketCenterX,
                basketBottom - 10,
                basketWidth,
                20,
                { isStatic: true, render: { fillStyle: '#888' } }
            );
            
            const invisibleFloor = Bodies.rectangle(
                175, 620, 400, 100,
                { isStatic: true, render: { visible: false } }
            );
            
            World.add(sellBasketEngine.world, [leftWall, rightWall, bottom, invisibleFloor]);
            
            // Velocity limiter
            Events.on(sellBasketEngine, 'beforeUpdate', () => {
                sellBasketBodies.forEach(body => {
                    const maxSpeed = 21.5;
                    const speed = Math.sqrt(body.velocity.x ** 2 + body.velocity.y ** 2);
                    
                    if (speed > maxSpeed) {
                        const scale = maxSpeed / speed;
                        Matter.Body.setVelocity(body, {
                            x: body.velocity.x * scale,
                            y: body.velocity.y * scale
                        });
                    }
                });
            });
            
            // Return forces
            Events.on(sellBasketEngine, 'afterUpdate', () => {
                const basketLeft = 90;
                const basketRight = 260;
                const basketTop = 468;
                
                sellBasketBodies.forEach(body => {
                    const nearFloor = body.position.y > 540;
                    const aboveBasket = body.position.y < basketTop;
                    
                    if (body.position.x < basketLeft) {
                        const pullStrength = nearFloor ? 0.06 : 0.00002;
                        const upForce = nearFloor ? -0.07 : 0;
                        Matter.Body.applyForce(body, body.position, { x: pullStrength, y: upForce });
                    } else if (body.position.x > basketRight) {
                        const pullStrength = nearFloor ? 0.06 : 0.00002;
                        const upForce = nearFloor ? -0.07 : 0;
                        Matter.Body.applyForce(body, body.position, { x: -pullStrength, y: upForce });
                    }
                    
                    if (aboveBasket && body.position.x > basketLeft && body.position.x < basketRight) {
                        Matter.Body.applyForce(body, body.position, { x: 0, y: 0.01 });
                    }
                });
            });
            
            // Selling detection - items at bottom get sold
            Events.on(sellBasketEngine, 'beforeUpdate', () => {
                for (let i = sellBasketBodies.length - 1; i >= 0; i--) {
                    const body = sellBasketBodies[i];
                    if (!body || !body.itemId) continue;
                    
                    // If item is settled at bottom (not moving much)
                    const speed = Math.sqrt(body.velocity.x ** 2 + body.velocity.y ** 2);
                    if (body.position.y > 540 && speed < 0.5) {
                        // Sell the item
                        const sellPrice = getSellPrice(body.itemId);
                        gs.coins += sellPrice;
                        
                        notify(`Sold ${body.itemId} for ${sellPrice} coins!`);
                        
                        // Remove from physics and inventory
                        World.remove(sellBasketEngine.world, body);
                        sellBasketBodies.splice(i, 1);
                        
                        // Remove from main inventory too
                        delete gs.inventory[body.itemKey];
                        
                        // Remove from main basket if it exists
                        const mainIdx = basketBodies.findIndex(b => b.itemKey === body.itemKey);
                        if (mainIdx !== -1) {
                            if (basketEngine) World.remove(basketEngine.world, basketBodies[mainIdx]);
                            basketBodies.splice(mainIdx, 1);
                        }
                        
                        save();
                        updateUI();
                        updateInventoryCounter();
                    }
                }
            });
            
            // Mouse control
            const mouse = Mouse.create(canvas);
            sellBasketMouseConstraint = MouseConstraint.create(sellBasketEngine, {
                mouse: mouse,
                constraint: {
                    stiffness: 1.9,
                    render: { visible: false }
                }
            });
            World.add(sellBasketEngine.world, sellBasketMouseConstraint);
            
            // Populate with items from main inventory
            populateSellBasket();
            
            // Run engine
            sellBasketRunner = Runner.create();
            Runner.run(sellBasketRunner, sellBasketEngine);
            Render.run(sellBasketRender);
        }
        
        function populateSellBasket() {
            if (!sellBasketEngine) return;
            
            // Clear existing
            sellBasketBodies.forEach(body => World.remove(sellBasketEngine.world, body));
            sellBasketBodies = [];
            
            // Add items from inventory
            const items = Object.keys(gs.inventory);
            items.forEach((key, idx) => {
                const itemId = key.split('_')[0];
                const color = ITEM_COLORS[itemId] || '#ff6b9d';
                
                const x = 105 + Math.random() * 140;
                const y = -50 - (idx * 45);
                
                const box = Bodies.rectangle(x, y, 40, 40, {
                    restitution: 0.4,
                    friction: 0.8,
                    render: { fillStyle: color },
                    itemKey: key,
                    itemId: itemId
                });
                
                World.add(sellBasketEngine.world, box);
                sellBasketBodies.push(box);
            });
        }
        
        function stopSellBasket() {
            if (sellBasketEngine) {
                Runner.stop(sellBasketRunner);
                Render.stop(sellBasketRender);
                Engine.clear(sellBasketEngine);
                sellBasketEngine = null;
                sellBasketRender = null;
                sellBasketRunner = null;
                sellBasketBodies = [];
            }
        }
        
        function getSellPrice(itemId) {
            const prices = {
                'fish': 5,
                'carrot': 3,
                'food': 8
            };
            return prices[itemId] || 1;
        }
        
function stopBasket() {
            if (basketEngine) {
                Runner.stop(basketRunner);
                Render.stop(basketRender);
                Engine.clear(basketEngine);
                basketEngine = null;
                basketRender = null;
                basketRunner = null;
                basketBodies = [];
            }
        }
        
        // Close basket button
        document.getElementById('basket-close').onclick = () => {
            document.getElementById('basket-container').classList.remove('active');
            stopBasket();
        };
        
        
        // ===== FISHING MINIGAME =====
        // Pond: Click-and-hold
        let fishingProgress = 0;
        let fishingInterval = null;
        let fishingArea = 'pond';
        
        function startFishing(area) {
            fishingArea = area;
            fishingProgress = 0;
            updateFishingBar();
            
            const btn = document.getElementById('fish-' + area + '-btn');
            const result = document.getElementById('fishing-result-' + area);
            
            result.textContent = '';
            
            fishingInterval = setInterval(() => {
                fishingProgress += 2;
                updateFishingBar();
                
                if (fishingProgress >= 100) {
                    completeFishing(true);
                }
            }, 50);
        }
        
        function stopFishing() {
            if (fishingInterval) {
                clearInterval(fishingInterval);
                fishingInterval = null;
                
                if (fishingProgress < 100) {
                    completeFishing(false);
                }
            }
        }
        
        function updateFishingBar() {
            const bar = document.getElementById('fishing-bar-' + fishingArea);
            if (bar) {
                bar.style.width = fishingProgress + '%';
            }
        }
        
        // River: Timing minigame
        let riverFishingInterval = null;
        let riverBarPos = 0;
        let riverTargetPos = 150;
        let riverActive = false;
        
        function startRiverFishing() {
            if (riverActive) return;
            
            const bar = document.getElementById('fishing-bar-river');
            const target = document.getElementById('fishing-target-river');
            const timer = document.getElementById('fishing-timer-river');
            const castBtn = document.getElementById('cast-river');
            
            riverActive = true;
            riverBarPos = 0;
            riverTargetPos = Math.random() * 200 + 20;
            
            target.style.left = riverTargetPos + 'px';
            timer.textContent = 'Release in green!';
            
            // Start bar movement immediately
            riverFishingInterval = setInterval(() => {
                riverBarPos += 5;
                bar.style.left = riverBarPos + 'px';
                
                if (riverBarPos >= 270) {
                    endRiverFishing(false);
                }
            }, 30);
        }
        
        function stopRiverBar() {
            if (!riverActive) return;
            
            const bar = document.getElementById('fishing-bar-river');
            clearInterval(riverFishingInterval);
            
            const barLeft = parseInt(bar.style.left) || 0;
            const targetLeft = riverTargetPos;
            const targetRight = targetLeft + 80;
            
            const hit = barLeft >= targetLeft && barLeft <= targetRight;
            endRiverFishing(hit);
        }
        
        function endRiverFishing(success) {
            riverActive = false;
            clearInterval(riverFishingInterval);
            
            const bar = document.getElementById('fishing-bar-river');
            const timer = document.getElementById('fishing-timer-river');
            const castBtn = document.getElementById('cast-river');
            
            if (success) {
                timer.textContent = 'üéâ Success!';
                addItem('fish', 1);
            } else {
                timer.textContent = '‚ùå Missed!';
            }
            
            setTimeout(() => {
                riverBarPos = 0;
                bar.style.left = '0px';
                timer.textContent = '';
            }, 1500);
        }
        
        function completeFishing(success) {
            clearInterval(fishingInterval);
            fishingInterval = null;
            
            const result = document.getElementById('fishing-result-' + fishingArea);
            
            if (success) {
                result.textContent = 'üé£ Caught a fish!';
                addItem('fish', 1);
            } else {
                result.textContent = '‚ùå It got away!';
            }
            
            setTimeout(() => {
                fishingProgress = 0;
                updateFishingBar();
                result.textContent = '';
            }, 1500);
        }
        
        
        // ===== FARMING MINIGAMES =====
        let gardenTaps = 0;
        let gardenActive = false;
        let gardenTimer = null;
        let gardenTimeLeft = 5.0;
        
        function initGardenGame() {
            gardenTaps = 0;
            gardenTimeLeft = 5.0;
            gardenActive = false;
            document.getElementById('garden-taps-display').textContent = 'Taps: 0 / 20';
            document.getElementById('garden-timer-display').textContent = 'Time: 5.0s';
            document.getElementById('garden-result').textContent = '';
        }
        
        function startGardenGame() {
            if (gardenActive) return;
            gardenActive = true;
            gardenTaps = 0;
            gardenTimeLeft = 5.0;
            document.getElementById('garden-result').textContent = '';
            
            gardenTimer = setInterval(() => {
                gardenTimeLeft -= 0.1;
                document.getElementById('garden-timer-display').textContent = 'Time: ' + gardenTimeLeft.toFixed(1) + 's';
                if (gardenTimeLeft <= 0) endGardenGame();
            }, 100);
        }
        
        function tapGarden() {
            if (!gardenActive) startGardenGame();
            if (gardenActive) {
                gardenTaps++;
                document.getElementById('garden-taps-display').textContent = 'Taps: ' + gardenTaps + ' / 20';
                if (gardenTaps >= 20) endGardenGame();
            }
        }
        
        function endGardenGame() {
            clearInterval(gardenTimer);
            gardenActive = false;
            const result = document.getElementById('garden-result');
            if (gardenTaps >= 20) {
                result.textContent = 'üéâ Garden cleared! +1 Carrot';
                addItem('carrot', 1);
            } else {
                result.textContent = '‚ùå Not enough taps! (' + gardenTaps + '/20)';
            }
            setTimeout(() => initGardenGame(), 2000);
        }
        
        function stopGardenGame() {
            clearInterval(gardenTimer);
            gardenActive = false;
        }
        
        let fieldPattern = [];
        let fieldInput = [];
        let fieldActive = false;
        
        function initFieldGame() {
            fieldActive = true;
            fieldPattern = generateFieldPattern();
            fieldInput = [];
            document.getElementById('field-pattern-display').textContent = fieldPattern.join(' ');
            document.getElementById('field-input-display').textContent = '';
            document.getElementById('field-result').textContent = '';
        }
        
        function generateFieldPattern() {
            const plants = ['üåΩ', 'ü•ï', 'ü•î'];
            const pattern = [];
            for (let i = 0; i < 4; i++) {
                pattern.push(plants[Math.floor(Math.random() * plants.length)]);
            }
            return pattern;
        }
        
        function plantInField(plant) {
            if (!fieldActive) return;
            fieldInput.push(plant);
            document.getElementById('field-input-display').textContent = fieldInput.join(' ');
            
            for (let i = 0; i < fieldInput.length; i++) {
                if (fieldInput[i] !== fieldPattern[i]) {
                    const result = document.getElementById('field-result');
                    result.textContent = '‚ùå Wrong order! Try again';
                    setTimeout(() => {
                        fieldInput = [];
                        document.getElementById('field-input-display').textContent = '';
                        result.textContent = '';
                    }, 1500);
                    return;
                }
            }
            
            if (fieldInput.length === fieldPattern.length) {
                const result = document.getElementById('field-result');
                result.textContent = 'üéâ Perfect planting! +1 Carrot';
                addItem('carrot', 1);
                setTimeout(() => initFieldGame(), 2000);
            }
        }
        
        function resetField() {
            fieldInput = [];
            document.getElementById('field-input-display').textContent = '';
            document.getElementById('field-result').textContent = '';
        }
        
        function stopFieldGame() {
            fieldActive = false;
        }
        

        // ===== COOKING MINIGAMES =====
        // Kitchen: Rhythm game - click when spoon flashes
        let kitchenScore = 0;
        let kitchenActive = false;
        let kitchenInterval = null;
        let kitchenFlashing = false;
        
        function initKitchenGame() {
            kitchenScore = 0;
            kitchenActive = false;
            kitchenFlashing = false;
            document.getElementById('kitchen-score-display').textContent = 'Score: 0 / 5';
            document.getElementById('kitchen-result').textContent = '';
            document.getElementById('kitchen-spoon').style.transform = 'scale(1)';
            startKitchenGame();
        }
        
        function startKitchenGame() {
            kitchenActive = true;
            kitchenScore = 0;
            scheduleKitchenFlash();
        }
        
        function scheduleKitchenFlash() {
            if (!kitchenActive) return;
            
            const delay = 1000 + Math.random() * 2000; // 1-3 seconds
            setTimeout(() => {
                if (!kitchenActive) return;
                kitchenFlashing = true;
                const spoon = document.getElementById('kitchen-spoon');
                spoon.style.transform = 'scale(1.5)';
                spoon.style.filter = 'brightness(1.5)';
                
                setTimeout(() => {
                    kitchenFlashing = false;
                    spoon.style.transform = 'scale(1)';
                    spoon.style.filter = 'brightness(1)';
                    
                    if (kitchenActive && kitchenScore < 5) {
                        scheduleKitchenFlash();
                    }
                }, 800);
            }, delay);
        }
        
        function stirKitchen() {
            if (!kitchenActive) return;
            
            if (kitchenFlashing) {
                kitchenScore++;
                document.getElementById('kitchen-score-display').textContent = 'Score: ' + kitchenScore + ' / 5';
                
                if (kitchenScore >= 5) {
                    endKitchenGame(true);
                }
            } else {
                endKitchenGame(false);
            }
        }
        
        function endKitchenGame(success) {
            kitchenActive = false;
            kitchenFlashing = false;
            const result = document.getElementById('kitchen-result');
            
            if (success) {
                result.textContent = 'üéâ Perfect dish! +1 Food';
                addItem('food', 1);
            } else {
                result.textContent = '‚ùå Burned! Wrong timing!';
            }
            
            setTimeout(() => initKitchenGame(), 2000);
        }
        
        function stopKitchenGame() {
            kitchenActive = false;
            kitchenFlashing = false;
        }
        
        // Grill: Temperature control - keep temp in green zone
        let grillTemp = 50;
        let grillActive = false;
        let grillTimer = null;
        let grillTimeLeft = 10.0;
        let grillGoodTime = 0;
        
        function initGrillGame() {
            grillTemp = 50;
            grillActive = false;
            grillTimeLeft = 10.0;
            grillGoodTime = 0;
            updateGrillDisplay();
            document.getElementById('grill-result').textContent = '';
            document.getElementById('grill-timer-display').textContent = 'Time: 10.0s';
            startGrillGame();
        }
        
        function startGrillGame() {
            grillActive = true;
            grillTimeLeft = 10.0;
            grillGoodTime = 0;
            
            grillTimer = setInterval(() => {
                grillTimeLeft -= 0.1;
                document.getElementById('grill-timer-display').textContent = 'Time: ' + grillTimeLeft.toFixed(1) + 's';
                
                // Temperature naturally drops
                grillTemp = Math.max(0, grillTemp - 0.5);
                updateGrillDisplay();
                
                // Check if in green zone (40-60%)
                if (grillTemp >= 40 && grillTemp <= 60) {
                    grillGoodTime += 0.1;
                }
                
                if (grillTimeLeft <= 0) {
                    endGrillGame();
                }
            }, 100);
        }
        
        function grillHeatUp() {
            if (!grillActive) return;
            grillTemp = Math.min(100, grillTemp + 5);
            updateGrillDisplay();
        }
        
        function grillCoolDown() {
            if (!grillActive) return;
            grillTemp = Math.max(0, grillTemp - 5);
            updateGrillDisplay();
        }
        
        function updateGrillDisplay() {
            const bar = document.getElementById('grill-temp-bar');
            const display = document.getElementById('grill-temp-display');
            bar.style.width = grillTemp + '%';
            display.textContent = 'Temp: ' + Math.round(grillTemp) + '%';
            
            // Color based on temp
            if (grillTemp >= 40 && grillTemp <= 60) {
                bar.style.background = '#4caf50';
            } else if (grillTemp > 60) {
                bar.style.background = '#ff6b6b';
            } else {
                bar.style.background = '#2196f3';
            }
        }
        
        function endGrillGame() {
            clearInterval(grillTimer);
            grillActive = false;
            const result = document.getElementById('grill-result');
            
            if (grillGoodTime >= 7.0) {
                result.textContent = 'üéâ Perfectly grilled! +1 Food';
                addItem('food', 1);
            } else {
                result.textContent = '‚ùå Over/undercooked! (' + grillGoodTime.toFixed(1) + 's/7s in zone)';
            }
            
            setTimeout(() => initGrillGame(), 2500);
        }
        
        function stopGrillGame() {
            clearInterval(grillTimer);
            grillActive = false;
        }
        
// ===== GAME ACTIONS =====
        document.getElementById('hatch-btn').onclick = () => {
            gs.hatched = true;
            notify('üéâ Your slime has hatched!');
            save();
            updateUI();
        };
        
        // Navigation - Fishing menu
        document.getElementById('goto-fishing-menu').onclick = () => switchRoom('fishing-menu-room');
        document.getElementById('back-to-area').onclick = () => switchRoom('area-room');
        document.getElementById('goto-pond').onclick = () => switchRoom('fishing-pond-room');
        document.getElementById('goto-river').onclick = () => switchRoom('fishing-river-room');
        document.getElementById('leave-pond').onclick = () => {
            stopFishing();
            switchRoom('fishing-menu-room');
        };
        document.getElementById('leave-river').onclick = () => {
            stopFishing();
            riverActive = false;
            clearInterval(riverFishingInterval);
            switchRoom('fishing-menu-room');
        };
        
        // Fishing buttons
        // Pond: hold to fish
        const pondBtn = document.getElementById('fish-pond-btn');
        pondBtn.addEventListener('mousedown', () => startFishing('pond'));
        pondBtn.addEventListener('mouseup', stopFishing);
        pondBtn.addEventListener('mouseleave', stopFishing);
        pondBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startFishing('pond'); });
        pondBtn.addEventListener('touchend', stopFishing);
        
        // River: hold to start, release to stop
        const riverBtn = document.getElementById('cast-river');
        
        riverBtn.addEventListener('mousedown', startRiverFishing);
        riverBtn.addEventListener('mouseup', stopRiverBar);
        riverBtn.addEventListener('mouseleave', () => {
            if (riverActive) stopRiverBar();
        });
        
        riverBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startRiverFishing();
        });
        riverBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            stopRiverBar();
        });
        
        
        document.getElementById('goto-farming-menu').onclick = () => switchRoom('farming-menu-room');
        document.getElementById('back-to-area-farm').onclick = () => switchRoom('area-room');
        document.getElementById('goto-garden').onclick = () => {
            switchRoom('farming-garden-room');
            initGardenGame();
        };
        document.getElementById('goto-field').onclick = () => {
            switchRoom('farming-field-room');
            initFieldGame();
        };
        document.getElementById('leave-garden').onclick = () => {
            stopGardenGame();
            switchRoom('farming-menu-room');
        };
        document.getElementById('leave-field').onclick = () => {
            stopFieldGame();
            switchRoom('farming-menu-room');
        };
        
        document.getElementById('buy-fish').onclick = () => {
            if (gs.coins >= 10) {
                gs.coins -= 10;
                addItem('fish', 1);
                save();
            } else {
                notify('Not enough coins!');
            }
        };
        
        document.getElementById('buy-carrot').onclick = () => {
            if (gs.coins >= 5) {
                gs.coins -= 5;
                addItem('carrot', 1);
                save();
            } else {
                notify('Not enough coins!');
            }
        };
        
        // Debug functions
        document.getElementById('fill-bag').onclick = () => {
            addItem('fish', 5);
            addItem('carrot', 5);
            addItem('food', 5);
        };
        
        document.getElementById('clear-bag').onclick = () => {
            gs.inventory = {};
            save();
            notify('Inventory cleared');
            updateInventoryCounter();
            if (basketEngine) populateBasket();
        };
        
        
        document.getElementById('tap-garden-btn').onclick = tapGarden;
        document.querySelectorAll('.plant-btn').forEach(btn => {
            btn.onclick = () => plantInField(btn.dataset.plant);
        });
        document.getElementById('reset-field-btn').onclick = resetField;
        

        document.getElementById('goto-cooking-menu').onclick = () => switchRoom('cooking-menu-room');
        document.getElementById('back-to-area-cook').onclick = () => switchRoom('area-room');
        document.getElementById('goto-kitchen').onclick = () => {
            switchRoom('cooking-kitchen-room');
            initKitchenGame();
        };
        document.getElementById('goto-grill').onclick = () => {
            switchRoom('cooking-grill-room');
            initGrillGame();
        };
        document.getElementById('leave-kitchen').onclick = () => {
            stopKitchenGame();
            switchRoom('cooking-menu-room');
        };
        document.getElementById('leave-grill').onclick = () => {
            stopGrillGame();
            switchRoom('cooking-menu-room');
        };

        
        document.getElementById('stir-kitchen-btn').onclick = stirKitchen;
        document.getElementById('grill-heat-up').onclick = grillHeatUp;
        document.getElementById('grill-cool-down').onclick = grillCoolDown;
        
// ===== INIT =====
        load();
        updateUI();
    </script>
</body>
</html>