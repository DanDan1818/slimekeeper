<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlimeHearth v0.403</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
        }
        
        /* Main Game Container */
        #game-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            height: 100vh;
            margin: 0 auto;
            background: #f0f0f0;
            overflow: hidden;
        }
        
        /* Top UI Bar */
        #top-ui {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 700px;
            height: 60px;
            background: rgba(255,255,255,0.95);
            border-bottom: 3px solid #333;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 500;
            padding: 0 10px;
        }
        
        .stat-display {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 11px;
            color: #666;
        }
        
        /* Main Content Area */
        #main-area {
            position: absolute;
            top: 60px;
            bottom: 72px;
            width: 100%;
            overflow: hidden;
        }
        
        /* Rooms */
        .room {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .room.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #shop-room.active {
            justify-content: flex-start;
            padding-top: 10px;
        }
        
        #area-room.active {
            justify-content: flex-start;
            padding-top: 40px;
        }
        
        /* Room Backgrounds */
        #shop-room {
            background-image: url('./slimehearth-assets/images/shop-background.png');
        }
        
        #shack-room {
            background-image: url('./slimehearth-assets/images/shack-background.png');
        }
        
        #fishing-pond-room {
            background-image: url('./slimehearth-assets/images/pond-background.png');
        }
        
        #cooking-menu-room {
            background-image: url('./slimehearth-assets/images/hearth-background.png');
        }
        
        #farming-garden-room, #farming-field-room {
            background-image: url('./slimehearth-assets/images/farm-background.png');
        }
        
        /* Home Room - Slime Display */
        #slime-square {
            width: 150px;
            height: 150px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            animation: slimeBounce 2s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            pointer-events: none;
            z-index: 50;
        }
        
        #slime-square.visible {
            display: block;
        }
        
        @keyframes slimeBounce {
            0%, 100% { transform: translate(-50%, -50%) translateY(0) scale(1, 1); }
            50% { transform: translate(-50%, -50%) translateY(-3px) scale(1.05, 0.95); }
        }
        
        /* Bottom Navigation */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 700px;
            height: 72px;
            background: rgba(255,255,255,0.95);
            border-top: 3px solid #333;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 500;
            overflow-x: auto;
            overflow-y: hidden;
        }
        
        .nav-btn {
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            padding: 8px 12px;
            transition: transform 0.1s;
            position: relative;
            z-index: 9999;
            flex-shrink: 0;
            min-width: 50px;
        }
        
        .nav-btn:active {
            transform: scale(0.95);
        }
        
        /* Floating Bag Button */
        #floating-bag-btn:active {
            transform: translateX(-50%) scale(0.95);
        }
        
        /* Basket Container - Physics Canvas */
        .basket-container {
            position: fixed;
            bottom: 72px;
            left: calc(50% - 340px);  /* Align with bag button */
            transform: scale(0.8);
            transform-origin: left bottom;  /* Scale from left bottom */
            width: 100%;
            max-width: 820px;
            height: 1200px;
            z-index: 140;
            display: none;
            pointer-events: none;
        }
        
        .basket-container.active {
            display: block;
        }
        
        .basket-container canvas {
            pointer-events: auto;
            position: relative;
            z-index: 10;
        }
        
        /* Basket Close Button - HIDDEN (bag button closes it now) */
        .basket-close-btn {
            display: none !important;
        }
        
        /* Slime Mouth - Eating Indicator */
        #slime-mouth {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 15px;
            height: 15px;
            background: #000;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        /* Skills Overlay */
        #skills-overlay {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(180px);
            background: rgba(255,255,255,0.95);
            border: 2px solid #9c27b0;
            border-radius: 6px;
            padding: 6px;
            z-index: 600;
            width: 140px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        /* Notifications */
        #notifications {
            position: fixed;
            top: 70px;
            left: calc(50% - 340px);
            width: 200px;
            z-index: 999;
            pointer-events: none;
        }
        
        @media (max-width: 700px) {
            #notifications {
                left: 10px;
            }
            
            .basket-container {
                left: 10px;  /* Simple left position on mobile */
            }
            
            #skills-overlay {
                left: 10px;
                right: 10px;
                transform: none;
                width: auto;
                max-width: calc(100vw - 20px);
            }
        }
        
        .notification {
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 6px 10px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 11px;
            animation: fadeOut 0.3s 2.7s;
        }
        
        .notification.warning {
            background: rgba(245, 158, 11, 0.9);
            color: #fff;
            font-weight: bold;
        }
        
        .notification.levelup {
            background: rgba(34, 197, 94, 0.9);
            color: #fff;
            font-weight: bold;
            font-size: 12px;
        }
        
        .notification.achievement {
            background: rgba(168, 85, 247, 0.9);
            color: #fff;
            font-weight: bold;
            font-size: 12px;
        }
        
        @keyframes fadeOut {
            to { opacity: 0; }
        }
        
        /* Special Notifications (Level Up / Achievements) - Top Center */
        #special-notifications {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            pointer-events: none;
        }
        
        .special-notification {
            background: rgba(34, 197, 94, 0.95);
            color: #fff;
            padding: 15px 30px;
            margin-bottom: 10px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 3px solid rgba(255,255,255,0.3);
            animation: popIn 0.3s ease-out, fadeOut 0.3s 2.7s;
            min-width: 200px;
        }
        
        .special-notification.achievement {
            background: rgba(168, 85, 247, 0.95);
        }
        
        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Item Beam Effects (Diablo-style) */
        .item-beam {
            position: absolute;
            pointer-events: none;
            z-index: 150;
            animation: beamRise 0.8s ease-out forwards;
        }
        
        @keyframes beamRise {
            0% {
                opacity: 1;
                height: 0%;
                bottom: 0;
                filter: blur(0px);
            }
            40% {
                opacity: 1;
                height: 100%;
                bottom: 0;
                filter: blur(3px);
            }
            100% {
                opacity: 0;
                height: 100%;
                bottom: 0;
                filter: blur(8px);
            }
        }
        
        /* Inventory Counter */
        #inventory-counter {
            position: absolute;
            bottom: 6px;
            left: 150px;
            transform: translateX(-50%);
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            z-index: 211;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
        }
        
        /* Mouse Coordinates Debug */
        #mouse-coords {
            position: fixed;
            bottom: 80px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 8px;
            font-size: 12px;
            z-index: 9999;
            border-radius: 4px;
            font-family: monospace;
        }
        
        /* Fishing Minigame */
        #fishing-game-pond,
        #fishing-game-river {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        /* River timing minigame */
        #fishing-bar-container-river {
            position: relative;
            width: 300px;
            height: 40px;
            background: #ddd;
            border: 3px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #fishing-bar-river {
            position: absolute;
            left: 0;
            top: 0;
            width: 30px;
            height: 100%;
            background: #4dd0e1;
            border-right: 3px solid #333;
        }
        
        #fishing-target-river {
            position: absolute;
            width: 80px;
            height: 100%;
            background: rgba(76, 175, 80, 0.5);
            border: 3px solid #4caf50;
        }
        
        #fishing-timer-river {
            font-size: 24px;
            font-weight: bold;
            min-height: 30px;
        }
        
        
        /* Sell Basket (Shop) */
        .sell-basket-container {
            position: fixed;
            bottom: 72px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 700px;
            height: 1200px;
            z-index: 130;
            display: none;
            pointer-events: none;
        }
        
        .sell-basket-container.active {
            display: block;
        }
        
        .sell-basket-container-REMOVED {
            pointer-events: auto;
            position: absolute;
            right: 0;
            bottom: 0;
            width: 350px;
            height: 600px;
        }
        
        .skill-display {
            background: rgba(255,255,255,0.9);
            padding: 8px;
            border-radius: 6px;
            border: 2px solid #333;
        }
        
        /* Buttons */
        button {
            padding: 8px 16px;
            font-size: 14px;
            background: #4dd0e1;
            border: 2px solid #333;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.1s;
            position: relative;
            z-index: 9999;
        }
        
        button:hover {
            background: #26c6da;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        /* Hatch Button - Extra large for mobile */
        #hatch-btn {
            font-size: 20px;
            padding: 16px 32px;
            min-width: 180px;
            min-height: 55px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Mobile adjustments */
        @media (max-width: 700px) {
            #floating-bag-btn {
                left: 10px !important;
            }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.05); }
        }
        
        .pulse-text {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    
    <!-- Title Screen Overlay (Simple) -->
    <div id="title-overlay" 
         style="position:fixed;top:0;left:0;width:100%;height:100%;background-image:url('./slimehearth-assets/images/titlescreen-background.png');background-size:cover;background-position:center;background-repeat:no-repeat;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;touch-action:manipulation;-webkit-tap-highlight-color:transparent;"
         onclick="document.getElementById('title-overlay').style.display='none';document.getElementById('hatch-overlay').style.display='flex';"
         ontouchend="document.getElementById('title-overlay').style.display='none';document.getElementById('hatch-overlay').style.display='flex';event.preventDefault();">
        <p class="pulse-text" style="font-size:24px;color:rgba(255,255,255,0.9);margin-top:280px;text-shadow:2px 2px 4px rgba(0,0,0,0.3);pointer-events:none;">Tap anywhere to start</p>
        <div style="position:absolute;bottom:20px;color:rgba(255,255,255,0.7);font-size:14px;pointer-events:none;">v0.403</div>
    </div>
    
    <!-- Hatch Screen Overlay (Simple) -->
    <div id="hatch-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);z-index:99998;display:none;flex-direction:column;align-items:center;justify-content:center;">
        <div style="text-align:center;">
            <h2 id="hatch-instruction" style="font-size:32px;color:#333;margin-bottom:30px;">ü•ö Tap the egg to hatch!</h2>
            
            <!-- Tappable Egg -->
            <div id="hatch-egg" style="font-size:120px;cursor:pointer;user-select:none;transition:transform 0.1s;-webkit-tap-highlight-color:transparent;touch-action:manipulation;">
                ü•ö
            </div>
            
            <!-- Tap Counter -->
            <div id="tap-counter" style="font-size:24px;color:#333;margin-top:20px;font-weight:bold;">
                <span id="tap-count">0</span> / 10 taps
            </div>
        </div>
    </div>
    
    <script>
        // Egg hatching logic
        (function() {
            const hatchOverlay = document.getElementById('hatch-overlay');
            const hatchEgg = document.getElementById('hatch-egg');
            const tapCountDisplay = document.getElementById('tap-count');
            const hatchInstruction = document.getElementById('hatch-instruction');
            let tapCount = 0;
            
            function tapEgg() {
                tapCount++;
                tapCountDisplay.textContent = tapCount;
                
                // Egg shake animation
                hatchEgg.style.transform = 'scale(1.1) rotate(' + (Math.random() * 20 - 10) + 'deg)';
                setTimeout(() => {
                    hatchEgg.style.transform = 'scale(1) rotate(0deg)';
                }, 100);
                
                // Crack effects at milestones
                if (tapCount === 5) {
                    hatchInstruction.textContent = 'ü•ö Keep tapping! It\'s cracking!';
                } else if (tapCount === 8) {
                    hatchInstruction.textContent = 'ü•ö Almost there!';
                }
                
                // Hatch at 10 taps
                if (tapCount >= 10) {
                    hatchInstruction.textContent = '‚ú® Hatching!';
                    hatchEgg.style.transform = 'scale(1.5)';
                    hatchEgg.textContent = 'üí•';
                    
                    setTimeout(() => {
                        hatchOverlay.style.display = 'none';
                        
                        // Start music
                        const bgMusic = document.getElementById('bg-music');
                        if (bgMusic) {
                            bgMusic.volume = 0.3;
                            bgMusic.play().catch(function(){});
                        }
                        
                        // Hatch the slime
                        if (typeof window.hatchSlime === 'function') {
                            window.hatchSlime();
                        }
                    }, 500);
                }
            }
            
            hatchEgg.addEventListener('click', tapEgg);
            hatchEgg.addEventListener('touchstart', function(e) {
                e.preventDefault();
                tapEgg();
            }, {passive: false});
        })();
    </script>
    
    <style>
        @keyframes titleBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
    
    <script>
        // Simple title screen logic - runs immediately
        (function() {
            const titleOverlay = document.getElementById('title-overlay');
            const hatchOverlay = document.getElementById('hatch-overlay');
            const hatchBtn = document.getElementById('final-hatch-btn');
            
            // Title screen click
            titleOverlay.addEventListener('click', function() {
                titleOverlay.style.display = 'none';
                hatchOverlay.style.display = 'flex';
            });
            
            titleOverlay.addEventListener('touchstart', function() {
                titleOverlay.style.display = 'none';
                hatchOverlay.style.display = 'flex';
            }, {passive: true});
            
            // Hatch button click
            function doHatch() {
                hatchOverlay.style.display = 'none';
                
                // Start background music
                const bgMusic = document.getElementById('bg-music');
                if (bgMusic) {
                    bgMusic.volume = 0.3;
                    bgMusic.play().catch(function(error) {
                        console.log('Music autoplay blocked:', error);
                    });
                }
                
                // Call the actual hatchSlime function after a short delay
                // to ensure all game code is loaded
                setTimeout(function() {
                    if (typeof window.hatchSlime === 'function') {
                        window.hatchSlime();
                    }
                }, 100);
            }
            
            hatchBtn.addEventListener('click', doHatch);
            hatchBtn.addEventListener('touchstart', doHatch, {passive: true});
        })();
    </script>
    
    <!-- Original Game (Untouched) -->
    <!-- Top UI Stats -->
    <div id="top-ui">
        <!-- Left: Slime Name -->
        <div class="stat-display" style="flex:1;text-align:left;padding-left:15px;">
            <div style="font-size:16px;font-weight:bold;color:#4dabf7;" id="slime-name-display">Slime</div>
        </div>
        
        <!-- Middle: Slime Level (Clickable) -->
        <div class="stat-display" style="flex:0.9;cursor:pointer;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:8px;padding:6px 10px;box-shadow:0 2px 8px rgba(0,0,0,0.2);" id="level-display-container">
            <div style="display:flex;align-items:baseline;justify-content:center;gap:5px;margin-bottom:3px;">
                <div style="font-size:20px;color:rgba(255,255,255,0.9);font-weight:bold;">LEVEL</div>
                <div id="level-display" style="font-size:20px;color:#fff;font-weight:bold;line-height:1;">1</div>
            </div>
            <div style="width:100%;height:5px;background:rgba(255,255,255,0.3);border-radius:2px;overflow:hidden;">
                <div id="slime-xp-bar" style="height:100%;width:0%;background:#fff;transition:width 0.3s;box-shadow:0 0 8px rgba(255,255,255,0.6);"></div>
            </div>
            <div style="font-size:7px;color:rgba(255,255,255,0.9);margin-top:1px;text-align:center;"><span id="slime-xp">0</span>/<span id="slime-xp-needed">100</span></div>
        </div>
        
        <!-- Right: Skills Button -->
        <div style="flex:1;text-align:right;padding-right:15px;">
            <button id="skills-btn" style="padding:8px 14px;font-size:13px;background:#9c27b0;color:#fff;border:3px solid #fff;border-radius:8px;font-weight:bold;box-shadow:0 2px 6px rgba(156,39,176,0.4);cursor:pointer;">üìä Skills</button>
        </div>
    </div>
    
    <!-- Main Game Area -->
    <div id="game-container">
        <div id="main-area">
            <!-- Home Room -->
            <div class="room active" id="home-room" style="background-image:url('./slimehearth-assets/images/home-background.png');background-size:cover;background-position:center -100px;">
                <div id="slime-square"></div>
                <div id="slime-mouth"></div>
            </div>
            
            <!-- Area Room - Activities Menu -->
            <div class="room" id="area-room">
                <h2>Activities</h2>
                <button id="goto-fishing-menu">üé£ Fishing</button>
                <button id="goto-farming-menu">üåæ Farming</button>
                <button id="goto-cooking-menu">üç≥ Cooking</button>
                <button id="goto-adventure">üóùÔ∏è Adventure</button>
            </div>
            
            <!-- Adventure Room -->
            <div class="room" id="adventure-room">
                <h2>üóùÔ∏è Adventure</h2>
                <p style="margin:20px;color:#666;">Use your keys to unlock doors and explore new areas!</p>
                
                <div id="adventure-doors" style="max-width:500px;margin:20px auto;">
                    <!-- Doors will be displayed here -->
                </div>
                
                <button id="back-to-area-adventure" style="background:#999;margin-top:20px;">‚Üê Back</button>
            </div>
            
            <!-- Fishing Menu - Select Area -->
            <div class="room" id="fishing-menu-room">
                <h2>üé£ Fishing Areas</h2>
                <button id="goto-pond">ü™∑ The Pond</button>
                <button id="goto-river">üåä The River</button>
                <button id="back-to-area" style="background:#999;">‚Üê Back</button>
            </div>
            
            <!-- Fishing Minigame - The Pond -->
            <div class="room" id="fishing-pond-room">
                <h2>ü™∑ The Pond</h2>
                <div id="fishing-game-pond">
                    <div id="fishing-progress-pond" style="width:200px;height:30px;background:#ddd;border:3px solid #333;border-radius:8px;position:relative;overflow:hidden;">
                        <div id="fishing-bar-pond" style="width:0%;height:100%;background:#4dd0e1;transition:width 0.1s;"></div>
                    </div>
                    <button id="fish-pond-btn">üé£ Fish (Hold)</button>
                    <div id="fishing-result-pond" style="min-height:30px;font-size:18px;font-weight:bold;"></div>
                </div>
                <button id="leave-pond" style="background:#999;">‚Üê Leave</button>
            </div>
            
            <!-- Fishing Minigame - The River -->
            <div class="room" id="fishing-river-room">
                <h2>üåä The River</h2>
                <div id="fishing-game-river">
                    <div id="fishing-bar-container-river">
                        <div id="fishing-bar-river"></div>
                        <div id="fishing-target-river"></div>
                    </div>
                    <button id="cast-river">üé£ Cast Line (Hold)</button>
                    <div id="fishing-timer-river"></div>
                </div>
                <button id="leave-river" style="background:#999;">‚Üê Leave</button>
            </div>
            
            
            <!-- Farming Menu - Select Area -->
            <div class="room" id="farming-menu-room">
                <h2>üåæ Farming Areas</h2>
                <button id="goto-garden">üåª The Garden</button>
                <button id="goto-field">üåæ The Field</button>
                <button id="back-to-area-farm" style="background:#999;">‚Üê Back</button>
            </div>
            
            <!-- Farming - The Garden (Rapid Tap) -->
            <div class="room" id="farming-garden-room">
                <h2>üåª The Garden</h2>
                
                <div style="text-align:center;max-width:500px;margin:0 auto;">
                    <p style="margin-bottom:20px;font-size:14px;color:#666;">Plant seeds, water them, and harvest crops!</p>
                    
                    <!-- 3x3 Garden Grid -->
                    <div style="display:grid;grid-template-columns:repeat(3,65px);gap:8px;justify-content:center;margin:15px auto;">
                        <!-- Plot 1 -->
                        <button id="garden-plot-slot-0" style="width:65px;height:65px;border:2px dashed #8bc34a;background:#fff;border-radius:8px;font-size:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                            <span id="garden-plot-icon-0">+</span>
                        </button>
                        
                        <!-- Plot 2 -->
                        <button id="garden-plot-slot-1" style="width:65px;height:65px;border:2px dashed #8bc34a;background:#fff;border-radius:8px;font-size:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                            <span id="garden-plot-icon-1">+</span>
                        </button>
                        
                        <!-- Plot 3 -->
                        <button id="garden-plot-slot-2" style="width:65px;height:65px;border:2px dashed #8bc34a;background:#fff;border-radius:8px;font-size:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                            <span id="garden-plot-icon-2">+</span>
                        </button>
                        
                        <!-- Plot 4 -->
                        <button id="garden-plot-slot-3" style="width:65px;height:65px;border:2px dashed #8bc34a;background:#fff;border-radius:8px;font-size:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                            <span id="garden-plot-icon-3">+</span>
                        </button>
                        
                        <!-- Plot 5 -->
                        <button id="garden-plot-slot-4" style="width:65px;height:65px;border:2px dashed #8bc34a;background:#fff;border-radius:8px;font-size:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                            <span id="garden-plot-icon-4">+</span>
                        </button>
                        
                        <!-- Plot 6 -->
                        <button id="garden-plot-slot-5" style="width:65px;height:65px;border:2px dashed #8bc34a;background:#fff;border-radius:8px;font-size:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                            <span id="garden-plot-icon-5">+</span>
                        </button>
                        
                        <!-- Plot 7 -->
                        <button id="garden-plot-slot-6" style="width:65px;height:65px;border:2px dashed #8bc34a;background:#fff;border-radius:8px;font-size:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                            <span id="garden-plot-icon-6">+</span>
                        </button>
                        
                        <!-- Plot 8 -->
                        <button id="garden-plot-slot-7" style="width:65px;height:65px;border:2px dashed #8bc34a;background:#fff;border-radius:8px;font-size:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                            <span id="garden-plot-icon-7">+</span>
                        </button>
                        
                        <!-- Plot 9 -->
                        <button id="garden-plot-slot-8" style="width:65px;height:65px;border:2px dashed #8bc34a;background:#fff;border-radius:8px;font-size:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                            <span id="garden-plot-icon-8">+</span>
                        </button>
                    </div>
                    
                    <!-- Water Button -->
                    <button id="water-garden-btn" style="width:130px;height:50px;font-size:20px;background:#4dd0e1;border:2px solid #333;border-radius:8px;cursor:pointer;font-weight:bold;margin:15px 0;padding:0;">
                        üíß Water
                    </button>
                    
                    <!-- Timer Display -->
                    <div id="garden-timer-display" style="font-size:24px;font-weight:bold;margin:15px 0;color:#8bc34a;min-height:30px;"></div>
                    
                    <!-- Result/Status -->
                    <div id="garden-result" style="min-height:30px;font-size:18px;font-weight:bold;margin:15px 0;"></div>
                    
                    <!-- Growing Info -->
                    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-top:20px;border:2px solid #f59e0b;">
                        <div style="font-size:13px;font-weight:bold;color:#92400e;margin-bottom:5px;">üìñ How to Garden:</div>
                        <div style="font-size:12px;color:#78716c;">1. Click slots to select seeds<br>2. Click üíß Water to start growing<br>3. Wait 1 minute<br>4. Harvest for 3x carrots per seed!</div>
                    </div>
                </div>
                
                <button id="leave-garden" style="background:#999;margin-top:20px;">‚Üê Leave</button>
            </div>
            
            <!-- Farming - The Field (Pattern Match) -->
            <div class="room" id="farming-field-room">
                <h2>üåæ The Field</h2>
                <div id="farming-game-field">
                    <div style="font-size:18px;margin-bottom:10px;">Plant in the correct order!</div>
                    <div id="field-pattern-display" style="font-size:32px;margin:15px;letter-spacing:10px;"></div>
                    <div id="field-input-display" style="font-size:32px;margin:15px;letter-spacing:10px;min-height:45px;"></div>
                    <div style="display:flex;gap:10px;margin:15px;">
                        <button class="plant-btn" data-plant="üåΩ" style="font-size:40px;width:70px;height:70px;">üåΩ</button>
                        <button class="plant-btn" data-plant="ü•ï" style="font-size:40px;width:70px;height:70px;">ü•ï</button>
                        <button class="plant-btn" data-plant="ü•î" style="font-size:40px;width:70px;height:70px;">ü•î</button>
                    </div>
                    <button id="reset-field-btn" style="background:#ff9800;">Reset</button>
                    <div id="field-result" style="min-height:30px;font-size:18px;font-weight:bold;margin-top:10px;"></div>
                </div>
                <button id="leave-field" style="background:#999;">‚Üê Leave</button>
            </div>
            
            <!-- Cooking Menu - Select Area -->
            <!-- The Hearth - Cooking Area (Mix 2 Items) -->
            <div class="room" id="cooking-menu-room">
                <h2>üî• The Hearth</h2>
                
                <div style="text-align:center;max-width:500px;margin:0 auto;">
                    <p style="margin-bottom:20px;color:#666;">Select two ingredients to cook together!</p>
                    
                    <!-- Two Ingredient Slots + Cook Button (Like Shack) -->
                    <div style="display:flex;gap:20px;align-items:center;justify-content:center;margin:20px 0;">
                        <!-- Slot 1 -->
                        <div style="text-align:center;">
                            <div style="font-size:11px;margin-bottom:3px;font-weight:bold;">Ingredient 1</div>
                            <button id="hearth-slot-1" style="width:80px;height:80px;border:3px dashed #f59e0b;background:#fff;border-radius:8px;font-size:40px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                                <span id="hearth-slot-1-icon">+</span>
                            </button>
                            <div id="hearth-slot-1-name" style="font-size:10px;margin-top:3px;color:#666;min-height:12px;"></div>
                        </div>
                        
                        <!-- Slot 2 -->
                        <div style="text-align:center;">
                            <div style="font-size:11px;margin-bottom:3px;font-weight:bold;">Ingredient 2</div>
                            <button id="hearth-slot-2" style="width:80px;height:80px;border:3px dashed #f59e0b;background:#fff;border-radius:8px;font-size:40px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                                <span id="hearth-slot-2-icon">+</span>
                            </button>
                            <div id="hearth-slot-2-name" style="font-size:10px;margin-top:3px;color:#666;min-height:12px;"></div>
                        </div>
                        
                        <!-- Cook Button -->
                        <div style="text-align:center;">
                            <div style="font-size:11px;margin-bottom:3px;font-weight:bold;">Cook!</div>
                            <button id="cook-hearth-btn" style="width:80px;height:80px;border:3px solid #ff6b6b;background:#ffe0e0;border-radius:8px;font-size:48px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                                <span>üî•</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Result -->
                    <div id="hearth-result" style="min-height:25px;font-size:16px;font-weight:bold;margin:15px 0;"></div>
                    
                    <!-- Recipe Hint -->
                    <div style="background:#fef3c7;padding:10px;border-radius:8px;margin-top:15px;border:2px solid #f59e0b;">
                        <div style="font-size:12px;font-weight:bold;color:#92400e;margin-bottom:4px;">üìñ Known Recipes:</div>
                        <div style="font-size:12px;color:#78716c;">üêü Fish + ü•ï Carrot = üçñ Cooked Food</div>
                    </div>
                </div>
                
                <button id="back-to-area-cook" style="background:#999;margin-top:20px;">‚Üê Back</button>
            </div>
            
            <!-- Skills Overlay (not a room) -->
            <div id="skills-overlay" style="display:none;">
                <h2 style="margin:0 0 4px 0;font-size:11px;">üìä Skills</h2>
                <div style="display:flex;flex-direction:column;gap:4px;">
                    <div class="skill-display">
                        <div style="font-size:10px;font-weight:bold;">üé£ Fishing</div>
                        <div style="font-size:8px;">Lv <span id="fishing-level">1</span> ‚Ä¢ <span id="fishing-xp">0</span>/<span id="fishing-xp-needed">100</span></div>
                        <div style="width:100%;height:6px;background:#ddd;border:1px solid #333;border-radius:2px;overflow:hidden;margin-top:1px;">
                            <div id="fishing-xp-bar" style="height:100%;width:0%;background:#4dd0e1;transition:width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <div class="skill-display">
                        <div style="font-size:10px;font-weight:bold;">üåæ Farming</div>
                        <div style="font-size:8px;">Lv <span id="farming-level">1</span> ‚Ä¢ <span id="farming-xp">0</span>/<span id="farming-xp-needed">100</span></div>
                        <div style="width:100%;height:6px;background:#ddd;border:1px solid #333;border-radius:2px;overflow:hidden;margin-top:1px;">
                            <div id="farming-xp-bar" style="height:100%;width:0%;background:#8bc34a;transition:width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <div class="skill-display">
                        <div style="font-size:10px;font-weight:bold;">üç≥ Cooking</div>
                        <div style="font-size:8px;">Lv <span id="cooking-level">1</span> ‚Ä¢ <span id="cooking-xp">0</span>/<span id="cooking-xp-needed">100</span></div>
                        <div style="width:100%;height:6px;background:#ddd;border:1px solid #333;border-radius:2px;overflow:hidden;margin-top:1px;">
                            <div id="cooking-xp-bar" style="height:100%;width:0%;background:#ff9800;transition:width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <div class="skill-display">
                        <div style="font-size:10px;font-weight:bold;">‚õèÔ∏è Prospecting</div>
                        <div style="font-size:8px;">Lv <span id="prospecting-level">1</span> ‚Ä¢ <span id="prospecting-xp">0</span>/<span id="prospecting-xp-needed">100</span></div>
                        <div style="width:100%;height:6px;background:#ddd;border:1px solid #333;border-radius:2px;overflow:hidden;margin-top:1px;">
                            <div id="prospecting-xp-bar" style="height:100%;width:0%;background:#78716c;transition:width 0.3s;"></div>
                        </div>
                    </div>
                </div>
                <button id="close-skills" style="margin-top:4px;background:#9c27b0;color:#fff;width:100%;padding:3px;font-size:9px;border:none;border-radius:3px;cursor:pointer;">Close</button>
            </div>
            
            <!-- Stats Overlay -->
            <div id="stats-overlay" style="display:none;position:fixed;top:70px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.98);border:3px solid #fbbf24;border-radius:10px;padding:10px;z-index:650;width:240px;box-shadow:0 4px 15px rgba(0,0,0,0.3);">
                <h2 style="margin:0 0 8px 0;font-size:14px;color:#f59e0b;text-align:center;">üìà Stats</h2>
                <div style="background:#fef3c7;padding:6px;border-radius:5px;margin-bottom:8px;font-size:10px;color:#92400e;font-weight:bold;text-align:center;">
                    üçñ <span id="foods-eaten-stat">0</span> Foods
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
                    <div style="background:#fff;padding:5px;border:2px solid #ddd;border-radius:5px;">
                        <div style="font-size:9px;font-weight:bold;color:#3b82f6;">‚ö° XP</div>
                        <div style="font-size:13px;color:#1d4ed8;font-weight:bold;"><span id="double-xp-stat">0</span>%</div>
                    </div>
                    <div style="background:#fff;padding:5px;border:2px solid #ddd;border-radius:5px;">
                        <div style="font-size:9px;font-weight:bold;color:#10b981;">üíé Loot</div>
                        <div style="font-size:13px;color:#059669;font-weight:bold;"><span id="double-loot-stat">0</span>%</div>
                    </div>
                    <div style="background:#fff;padding:5px;border:2px solid #ddd;border-radius:5px;">
                        <div style="font-size:9px;font-weight:bold;color:#a78bfa;">ü™® Geode</div>
                        <div style="font-size:13px;color:#7c3aed;font-weight:bold;">+<span id="bonus-geode-stat">0</span>%</div>
                    </div>
                    <div style="background:#fff;padding:5px;border:2px solid #ddd;border-radius:5px;">
                        <div style="font-size:9px;font-weight:bold;color:#f59e0b;">‚ú® Rare</div>
                        <div style="font-size:13px;color:#d97706;font-weight:bold;">+<span id="rare-find-stat">0</span>%</div>
                    </div>
                </div>
                <button id="close-stats" style="margin-top:8px;background:#f59e0b;color:#fff;width:100%;padding:5px;font-size:11px;font-weight:bold;border-radius:5px;">Close</button>
            </div>
            
            <!-- Shack Room -->
            <div class="room" id="shack-room">
                <!-- Prospecting Info Box -->
                <div style="background:rgba(222, 184, 135, 0.95);padding:15px 20px;border-radius:12px;border:3px solid #8b7355;max-width:350px;margin:20px auto 30px auto;box-shadow:0 4px 8px rgba(0,0,0,0.3);">
                    <h2 id="shack-title" style="color:#3e2723;margin:0 0 8px 0;text-shadow:1px 1px 2px rgba(255,255,255,0.3);">‚õèÔ∏è Prospecting Level 1</h2>
                    <p id="shack-levelup-info" style="margin:0;font-size:14px;color:#3e2723;font-weight:500;">90% chance to level up with Small Geode</p>
                </div>
                
                <div style="text-align:center;max-width:400px;margin:0 auto;">
                    
                    <!-- Geode Slot and Crack Button -->
                    <div style="display:flex;gap:20px;align-items:center;justify-content:center;margin:20px 0;">
                        <!-- Geode Slot (LEFT) -->
                        <div style="text-align:center;">
                            <div style="font-size:11px;margin-bottom:3px;font-weight:bold;">Geode</div>
                            <button id="shack-geode-slot" style="width:75px;height:75px;border:3px dashed #999;background:#fff;border-radius:8px;font-size:40px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                                <span id="shack-slot-icon">+</span>
                            </button>
                        </div>
                        
                        <!-- Crack Button (RIGHT) -->
                        <div style="text-align:center;">
                            <div style="font-size:11px;margin-bottom:3px;font-weight:bold;">Crack!</div>
                            <button id="crack-geode-btn" style="width:75px;height:75px;border:3px solid #8b7355;background:#f5e6d3;border-radius:8px;font-size:48px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin:0;">
                                <span>üî®</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Progress -->
                    <div id="shack-progress-display" style="font-size:16px;font-weight:bold;margin:12px 0;">Cracks: 0 / 20</div>
                    
                    <!-- Result -->
                    <div id="shack-result" style="min-height:25px;font-size:14px;font-weight:bold;margin:12px 0;"></div>
                </div>
                
                <button id="leave-shack" style="background:#999;margin-top:20px;">‚Üê Leave</button>
            </div>
            
            <!-- Shop Room -->
            <div class="room" id="shop-room">
                <h2 style="margin-top:10px;margin-bottom:5px;">üõí Shop</h2>
                
                <div id="shop-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(65px,1fr));gap:5px;max-width:500px;margin:10px auto 15px auto;padding:8px;position:relative;z-index:150;">
                    <!-- Shop items will be displayed here -->
                </div>
            </div>
            
            <!-- Room Room -->
            <div class="room" id="room-room">
                <h2>üö™ Room</h2>
                <button id="goto-wardrobe" style="padding:15px 30px;font-size:18px;margin:10px;background:#a78bfa;color:#fff;border:3px solid #7c3aed;border-radius:10px;cursor:pointer;min-width:200px;">
                    üëî Wardrobe
                </button>
                <button id="goto-trophies" style="padding:15px 30px;font-size:18px;margin:10px;background:#fbbf24;color:#fff;border:3px solid #f59e0b;border-radius:10px;cursor:pointer;min-width:200px;">
                    üì¶ Collection
                </button>
            </div>
            
            <!-- Wardrobe Room -->
            <div class="room" id="wardrobe-room">
                <h2>üëî Wardrobe</h2>
                
                <h3 style="margin-top:20px;">üé© Hats</h3>
                <div id="hats-display" style="max-width:500px;margin:10px auto;padding:15px;background:rgba(255,255,255,0.9);border:3px solid #333;border-radius:10px;max-height:400px;overflow-y:auto;">
                    <!-- Hats will be displayed here -->
                </div>
                
                <button id="leave-wardrobe" style="background:#999;margin-top:20px;">‚Üê Leave</button>
            </div>
            
            <!-- Collection Room (formerly Trophies) -->
            <div class="room" id="trophies-room">
                <h2>üì¶ Collection</h2>
                
                <h3 style="margin-top:20px;">üõ†Ô∏è Tools</h3>
                <div id="trophies-display" style="max-width:500px;margin:10px auto;padding:15px;background:rgba(255,255,255,0.9);border:3px solid #333;border-radius:10px;max-height:300px;overflow-y:auto;">
                    <!-- Tools will be displayed here -->
                </div>
                
                <h3 style="margin-top:20px;">üîë Keys</h3>
                <div id="keys-display" style="max-width:500px;margin:10px auto;padding:15px;background:rgba(255,255,255,0.9);border:3px solid #333;border-radius:10px;max-height:300px;overflow-y:auto;">
                    <!-- Keys will be displayed here -->
                </div>
                
                <button id="leave-trophies" style="background:#999;margin-top:20px;">‚Üê Leave</button>
            </div>
            
            <!-- Settings Overlay (not a room) -->
            <!-- Settings Backdrop -->
    <div id="settings-backdrop" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;"></div>
    
    <div id="settings-overlay" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.98);border:3px solid #333;border-radius:10px;padding:15px;z-index:10000;width:280px;max-height:80vh;overflow-y:auto;box-shadow:0 4px 30px rgba(0,0,0,0.5);">
                <h2 style="margin:0 0 10px 0;font-size:16px;">‚öôÔ∏è Settings</h2>
                
                <div style="width:100%;margin:0 auto;">
                    <!-- Music Toggle -->
                    <div style="text-align:center;margin-bottom:12px;">
                        <button id="music-toggle-btn" style="font-size:32px;width:60px;height:60px;border-radius:50%;background:#4caf50;border:3px solid #333;cursor:pointer;transition:all 0.2s;margin:0;">üîä</button>
                        <div id="music-status" style="margin-top:5px;font-size:11px;font-weight:bold;color:#666;">Music Playing</div>
                    </div>
                    
                    <hr style="margin:10px 0;border:1px solid #ddd;">
                    <!-- Music Volume -->
                    <div style="margin-bottom:12px;">
                        <label style="font-size:12px;font-weight:bold;display:block;margin-bottom:5px;">
                            üéµ Music: <span id="music-volume-display">30%</span>
                        </label>
                        <input type="range" id="music-volume-slider" min="0" max="100" value="30" 
                               style="width:100%;height:20px;cursor:pointer;">
                    </div>
                    
                    <!-- Sound Effects Volume -->
                    <div style="margin-bottom:12px;">
                        <label style="font-size:12px;font-weight:bold;display:block;margin-bottom:5px;">
                            üîî SFX: <span id="sfx-volume-display">50%</span>
                        </label>
                        <input type="range" id="sfx-volume-slider" min="0" max="100" value="50" 
                               style="width:100%;height:20px;cursor:pointer;">
                    </div>
                    
                    <hr style="margin:10px 0;border:1px solid #ddd;">
                    
                    <!-- Debug Tools -->
                    <div style="margin-top:10px;">
                        <h3 style="font-size:13px;margin-bottom:8px;">üîß Debug</h3>
                        <button id="toggle-debug-console" style="background:#9c27b0;color:#fff;font-size:12px;padding:8px 12px;margin:3px;">üêõ Console</button>
                        <button id="fill-bag" style="font-size:12px;padding:8px 12px;margin:3px;">Fill Inv</button>
                        <button id="clear-bag" style="font-size:12px;padding:8px 12px;margin:3px;">Clear Inv</button>
                        <button id="fill-geodes" style="font-size:12px;padding:8px 12px;margin:3px;">Geodes</button>
                        <button id="give-coins" style="font-size:12px;padding:8px 12px;margin:3px;">Coins</button>
                        <button id="reset-game" style="background:#f44336;color:#fff;font-size:12px;padding:8px 12px;margin:3px;font-weight:bold;">üîÑ RESET</button>
                    </div>
                    
                    <button id="close-settings" style="margin-top:12px;width:100%;background:#666;color:#fff;font-size:13px;padding:8px;">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Basket Physics Container -->
        <div class="basket-container" id="basket-container">
            <div id="basket-bg-image" style="position:absolute;bottom:-50px;left:0;width:300px;height:300px;z-index:1;pointer-events:none;"></div>
            <canvas id="basket-canvas" width="820" height="1200"></canvas>
            <button class="basket-close-btn" id="basket-close">√ó</button>
            <div id="inventory-counter">0/6</div>
            <div id="basket-coins-display" style="position:absolute;left:70px;bottom:6px;color:#ffd700;font-size:14px;font-weight:bold;z-index:201;pointer-events:none;text-shadow:2px 2px 4px rgba(0,0,0,0.9);">üí∞ <span id="basket-coins">0</span></div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div id="bottom-nav">
        <button class="nav-btn" id="nav-home">üè†</button>
        <button class="nav-btn" id="nav-area">üéÆ</button>
        <button class="nav-btn" id="nav-shop">üõí</button>
        <button class="nav-btn" id="nav-shack">üõñ</button>
        <button class="nav-btn" id="nav-room">üö™</button>
        <button class="nav-btn" id="nav-settings">‚öôÔ∏è</button>
    </div>
    
    <!-- Floating Bag Button - Above bottom nav, left corner -->
    <button id="floating-bag-btn" style="position: fixed; bottom: 75px; left: calc(50% - 350px); width: 50px; height: 50px; background: rgba(255,255,255,0.95); border: 3px solid #333; border-radius: 50%; font-size: 26px; cursor: pointer; z-index: 600; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.1s; touch-action: manipulation; -webkit-tap-highlight-color: transparent;">üéí</button>
    
    
        <!-- Sell Basket Container removed -->
    <!-- Background Music -->
    <!-- Available tracks in slimehearth-assets/music/:
         - fishing-lights.mp3 (main theme - currently playing)
         - hut-strings.mp3 (available for future use)
         - lakeside-bounce.mp3 (available for future use)
    -->
    <audio id="bg-music" loop>
        <source src="./slimehearth-assets/music/fishing-lights.mp3" type="audio/mpeg">
    </audio>
    <audio id="bg-music" loop>
        <source src="./slimehearth-assets/music/fishing-lights.mp3" type="audio/mpeg">
    </audio>
    <div id="debug-console" style="position:fixed;top:70px;left:10px;width:250px;height:400px;background:rgba(0,0,0,0.9);color:#0f0;font-family:monospace;font-size:11px;padding:10px;overflow-y:auto;z-index:500;border:2px solid #0f0;border-radius:5px;display:none;"><div style="color:#fff;font-weight:bold;margin-bottom:5px;">DEBUG CONSOLE</div><div id="debug-log"></div></div>
    <!-- Notifications -->
    <div id="notifications"></div>
    
    <!-- Level Up / Achievement Notifications (Top Center) -->
    <div id="special-notifications"></div>
    
    <!-- Mouse Coordinates -->
    <div id="mouse-coords">0, 0</div>
    
    <script>
        // ===== GAME STATE =====
        const gs = {
            hatched: false,
            slimeName: 'Slime', // Default name
            hunger: 100,
            level: 1,
            slimeXP: 0,
            slimeXPNeeded: 100,
            coins: 0,
            inventory: {}, // Format: { 'fish_0': 1, 'carrot_1': 1 }
            itemCounter: 0, // For unique item keys
            tools: {}, // Format: { 'fishing_rod': true, 'better_net': true }
            prospectingLevel: 1, // Prospecting skill (levels up by cracking geodes)
            hats: {}, // Format: { 'top_hat': true, 'party_hat': true }
            equippedHat: null, // Currently equipped hat (null = no hat)
            keys: {}, // Format: { 'bronze_key': true, 'silver_key': true }
            skills: { // Skill levels and XP
                fishing: { level: 1, xp: 0, xpNeeded: 100 },
                farming: { level: 1, xp: 0, xpNeeded: 100 },
                cooking: { level: 1, xp: 0, xpNeeded: 100 }
            },
            stats: { // Permanent buffs from eating food
                doubleXpChance: 0, // % chance for double XP (0-100)
                doubleLootChance: 0, // % chance for double loot drops (0-100)
                bonusGeodeChance: 0, // % bonus chance for geodes from cracking (0-100)
                rareFindChance: 0, // % bonus chance for rare item drops (0-100)
                foodsEaten: 0 // Total foods consumed
            }
        };
        
        // ===== CONSTANTS =====
        const BASKET_IMAGE = "";
        const MAX_INVENTORY = 6;
        
        const ITEM_COLORS = {
            'fish1': '#9ca3af',
            'fish2': '#4ade80',
            'fish3': '#fbbf24',
            'fish4': '#a855f7',
            'carrot': '#ffaa44',
            'carrot_seeds': '#8bc34a',
            'food': '#ff6b9d',
            'burnt_food': '#1a1a1a',
            'burnt': '#1a1a1a',
            'small_geode': '#8b7355',
            'rock': '#666666',
            'gem': '#9333ea',
            'basket': '#d97706'
        };
        
        const ITEM_IMAGES = {
            'fish1': './slimehearth-assets/images/fish1.png',
            'fish2': './slimehearth-assets/images/fish2.png',
            'fish3': './slimehearth-assets/images/fish3.png',
            'fish4': './slimehearth-assets/images/fish4.png'
        };
        
        const ITEM_DATA = {
            'fish1': {
                name: 'Common Fish',
                emoji: 'üêü',
                image: 'fish1.png',
                rarity: 'Common',
                rarityColor: '#9ca3af',
                description: 'A common fish from the pond.',
                foodValue: 8,
                sellValue: 3,
                cookable: true,
                feedable: true
            },
            'fish2': {
                name: 'Blue Fish',
                emoji: 'üê†',
                image: 'fish2.png',
                rarity: 'Uncommon',
                rarityColor: '#4ade80',
                description: 'A colorful blue fish.',
                foodValue: 10,
                sellValue: 5,
                cookable: true,
                feedable: true
            },
            'fish3': {
                name: 'Tropical Fish',
                emoji: 'üê°',
                image: 'fish3.png',
                rarity: 'Rare',
                rarityColor: '#fbbf24',
                description: 'A rare tropical fish!',
                foodValue: 15,
                sellValue: 10,
                cookable: true,
                feedable: true
            },
            'fish4': {
                name: 'Golden Fish',
                emoji: 'üé£',
                image: 'fish4.png',
                rarity: 'Epic',
                rarityColor: '#a855f7',
                description: 'A legendary golden fish!',
                foodValue: 20,
                sellValue: 20,
                cookable: true,
                feedable: true
            },
            'carrot': {
                name: 'Carrot',
                rarity: 'Common',
                rarityColor: '#9ca3af',
                description: 'A crunchy orange vegetable.',
                foodValue: 10,
                sellValue: 3,
                cookable: true,
                feedable: true
            },
            'carrot_seeds': {
                name: 'üå± Carrot Seeds',
                rarity: 'Common',
                rarityColor: '#8bc34a',
                description: 'Plant in the garden. Grows in 1 minute.',
                foodValue: 0,
                sellValue: 1,
                cookable: false,
                feedable: false,
                isPlantable: true
            },
            'food': {
                name: 'Cooked Food',
                rarity: 'Rare',
                rarityColor: '#a78bfa',
                description: 'A delicious prepared meal.',
                foodValue: 10,
                sellValue: 8,
                cookable: false,
                feedable: true
            },
            'burnt_food': {
                name: 'Burnt Food',
                rarity: 'Trash',
                rarityColor: '#78716c',
                description: 'Completely charred and inedible.',
                foodValue: 1,
                sellValue: 1,
                cookable: false,
                feedable: true
            },
            'burnt': {
                name: 'Burnt Food',
                rarity: 'Trash',
                rarityColor: '#78716c',
                description: 'Completely charred and inedible.',
                foodValue: 1,
                sellValue: 1,
                cookable: false,
                feedable: true
            },
            'small_geode': {
                name: 'Small Geode',
                rarity: 'Rare',
                rarityColor: '#a78bfa',
                description: 'A mysterious rocky shell.',
                foodValue: 0,
                sellValue: 2,
                cookable: false,
                feedable: false,
                crackable: true
            },
            'rock': {
                name: 'Rock',
                rarity: 'Common',
                rarityColor: '#9ca3af',
                description: 'A plain rock. Not very valuable.',
                foodValue: 0,
                sellValue: 1,
                cookable: false,
                feedable: false,
                crackable: false
            },
            'gem': {
                name: 'Gem',
                rarity: 'Legendary',
                rarityColor: '#fbbf24',
                description: 'A beautiful sparkling gem!',
                foodValue: 0,
                sellValue: 50,
                cookable: false,
                feedable: false,
                crackable: false
            },
            'basket': {
                name: 'üß∫ Basket',
                rarity: 'Uncommon',
                rarityColor: '#fbbf24',
                description: 'A mysterious basket. Feed to slime to open!',
                foodValue: 0,
                sellValue: 10,
                cookable: false,
                feedable: true,
                crackable: false,
                isBasket: true // Special flag for treasure basket
            }
        };
        
        const TOOLS_DATA = {
            'hammer': {
                name: 'üî® Hammer',
                description: 'Required to crack geodes in the Shack',
                cost: 50,
                icon: 'üî®'
            },
            'fishing_rod': {
                name: 'üé£ Fishing Rod',
                description: 'Catch fish faster at the pond',
                cost: 100,
                icon: 'üé£'
            },
            'better_net': {
                name: 'ü•Ö Better Net',
                description: 'Improved catch rate at the river',
                cost: 250,
                icon: 'ü•Ö'
            },
            'golden_hoe': {
                name: '‚öíÔ∏è Golden Hoe',
                description: 'Faster farming in the garden',
                cost: 500,
                icon: '‚öíÔ∏è'
            }
        };
        
        const HATS_DATA = {
            'top_hat': {
                name: 'üé© Top Hat',
                description: 'A classy black top hat',
                cost: 100,
                icon: 'üé©',
                unlockType: 'shop' // Can be purchased
            },
            'party_hat': {
                name: 'üéâ Party Hat',
                description: 'Celebrate in style!',
                cost: 150,
                icon: 'üéâ',
                unlockType: 'shop'
            },
            'crown': {
                name: 'üëë Crown',
                description: 'Fit for royalty',
                cost: 500,
                icon: 'üëë',
                unlockType: 'shop'
            },
            'cowboy_hat': {
                name: 'ü§† Cowboy Hat',
                description: 'Howdy partner!',
                cost: 200,
                icon: 'ü§†',
                unlockType: 'shop'
            }
        };
        
        const KEYS_DATA = {
            'water_key': {
                name: 'üíß Water Key',
                description: 'Opens the Water Door - Found while fishing',
                icon: 'üíß',
                unlockType: 'fishing' // 10% chance from fishing
            }
        };
        
        // ===== BASKET PHYSICS =====
        const { Engine, Render, Bodies, World, Mouse, MouseConstraint, Events, Runner } = Matter;
        
        let basketEngine = null;
        let basketRender = null;
        let basketRunner = null;
        let basketBodies = [];
        let sellWalls = [];
        
        // Sell basket
        let sellBasketEngine = null;
        let sellBasketRender = null;
        let sellBasketRunner = null;
        let sellBasketBodies = [];
        let sellBasketMouseConstraint = null;
        let mouseConstraint = null;
        
        // ===== UTILITY FUNCTIONS =====
        function showItemTooltip(itemId) {
            // Remove existing tooltip
            const existing = document.getElementById('item-tooltip');
            if (existing) existing.remove();
            
            console.log('Tooltip for itemId:', itemId);
            console.log('ITEM_DATA has this?', !!ITEM_DATA[itemId]);
            
            if (!itemId) return;
            
            // Check if data exists
            if (!ITEM_DATA[itemId]) {
                console.error('No ITEM_DATA for:', itemId);
                return;
            }
            
            const data = ITEM_DATA[itemId];
            
            const tooltip = document.createElement('div');
            tooltip.id = 'item-tooltip';
            tooltip.innerHTML = `
                <div style="color: ${data.rarityColor}; font-size: 11px; font-weight: bold; margin-bottom: 2px;">
                    ${data.name}
                </div>
                <div style="color: #666; font-size: 9px; font-style: italic; margin-bottom: 3px;">
                    ${data.description}
                </div>
                ${data.feedable ? `<div style="font-size: 10px; margin-bottom: 2px;">
                    +${data.foodValue} <span style="color: #ff6b9d; font-weight: bold;">Food</span>
                </div>` : ''}
                <div style="font-size: 10px;">
                    üí∞ ${data.sellValue}
                </div>
                ${data.crackable ? '<div style="font-size: 10px; color: #8b7355; font-weight: bold; margin-top: 2px;">üî® Crackable</div>' : ''}
            `;
            
            // Mobile-aware positioning
            const isMobile = window.innerWidth <= 700;
            
            tooltip.style.cssText = `
                position: fixed;
                top: ${isMobile ? '70px' : '50%'};
                left: ${isMobile ? '10px' : 'calc(50% - 300px)'};
                ${isMobile ? 'right: 10px;' : ''}
                transform: ${isMobile ? 'none' : 'translateY(-50%)'};
                background: rgba(255,255,255,0.95);
                color: #333;
                padding: 6px 10px;
                border-radius: 4px;
                z-index: 135;
                border: 2px solid ${data.rarityColor};
                box-shadow: 0 4px 15px rgba(0,0,0,0.5);
                min-width: ${isMobile ? 'auto' : '110px'};
                max-width: ${isMobile ? 'calc(100vw - 20px)' : 'none'};
                text-align: left;
                pointer-events: none;
            `;
            
            document.body.appendChild(tooltip);
        }
        
        function hideItemTooltip() {
            const tooltip = document.getElementById('item-tooltip');
            if (tooltip) tooltip.remove();
        }
        
        function openBasket() {
            notify('üß∫ Opening Basket!', 'achievement');
            
            // Get all possible item drops (exclude basket itself)
            const possibleItems = ['fish', 'carrot', 'food', 'small_geode', 'rock', 'gem'];
            
            // Random number of items (1-3)
            const numItems = Math.floor(Math.random() * 3) + 1;
            
            let itemsFound = [];
            for (let i = 0; i < numItems; i++) {
                const randomItem = possibleItems[Math.floor(Math.random() * possibleItems.length)];
                addItem(randomItem, 1);
                itemsFound.push(ITEM_DATA[randomItem].name);
            }
            
            notify('Found: ' + itemsFound.join(', ') + '!');
        }
        
        function notifyInventoryFull() {
            // Special notification for inventory full - bigger and centered at bottom
            const existing = document.getElementById('inventory-full-notif');
            if (existing) return; // Don't spam
            
            const notif = document.createElement('div');
            notif.id = 'inventory-full-notif';
            notif.textContent = 'üì¶ INVENTORY FULL (6/6)';
            notif.style.cssText = `
                position: fixed;
                bottom: 200px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(255,69,0,0.95);
                color: #fff;
                padding: 10px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: bold;
                z-index: 10000;
                border: 2px solid #fff;
                box-shadow: 0 4px 15px rgba(0,0,0,0.5);
                animation: fadeOut 0.3s 2.7s;
            `;
            
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }
        
        function notify(message, type = 'normal') {
            // Level-ups and achievements go to special top-center container
            if (type === 'levelup' || type === 'achievement') {
                const container = document.getElementById('special-notifications');
                
                const notif = document.createElement('div');
                notif.className = 'special-notification';
                
                if (type === 'achievement') {
                    notif.classList.add('achievement');
                }
                
                notif.textContent = message;
                container.appendChild(notif);
                setTimeout(() => notif.remove(), 3000);
                return;
            }
            
            // Normal and warning notifications go to regular left container
            const container = document.getElementById('notifications');
            
            // Limit to 5 notifications
            const existing = container.querySelectorAll('.notification');
            if (existing.length >= 5) {
                existing[0].remove(); // Remove oldest
            }
            
            const notif = document.createElement('div');
            notif.className = 'notification';
            
            // Add type-specific class
            if (type === 'warning') {
                notif.classList.add('warning');
            }
            
            notif.textContent = message;
            container.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }
        
        function save() {
            localStorage.setItem('slimeHearth', JSON.stringify(gs));
        }
        
        function load() {
            const saved = localStorage.getItem('slimeHearth');
            if (saved) {
                Object.assign(gs, JSON.parse(saved));
                
                // Initialize slime XP if it doesn't exist (old saves)
                if (gs.slimeXP === undefined) {
                    gs.slimeXP = 0;
                    gs.slimeXPNeeded = 100;
                }
                
                // Initialize skills if they don't exist (old saves)
                if (!gs.skills) {
                    gs.skills = {
                        fishing: { level: 1, xp: 0, xpNeeded: 100 },
                        farming: { level: 1, xp: 0, xpNeeded: 100 },
                        cooking: { level: 1, xp: 0, xpNeeded: 100 }
                    };
                }
                
                updateUI();
            }
        }
        
        function updateInventoryCounter() {
            const counter = document.getElementById('inventory-counter');
            if (counter) {
                const count = Object.keys(gs.inventory).length;
                counter.textContent = count + '/' + MAX_INVENTORY;
            }
        }
        
        function updateStatsDisplay() {
            if (!gs.stats) {
                gs.stats = {
                    doubleXpChance: 0,
                    doubleLootChance: 0,
                    bonusGeodeChance: 0,
                    rareFindChance: 0,
                    foodsEaten: 0
                };
            }
            
            document.getElementById('foods-eaten-stat').textContent = gs.stats.foodsEaten || 0;
            document.getElementById('double-xp-stat').textContent = (gs.stats.doubleXpChance || 0).toFixed(1);
            document.getElementById('double-loot-stat').textContent = (gs.stats.doubleLootChance || 0).toFixed(1);
            document.getElementById('bonus-geode-stat').textContent = (gs.stats.bonusGeodeChance || 0).toFixed(1);
            document.getElementById('rare-find-stat').textContent = (gs.stats.rareFindChance || 0).toFixed(1);
        }
        
        function updateUI() {
            // Update basket coins display
            const basketCoins = document.getElementById('basket-coins');
            if (basketCoins) {
                basketCoins.textContent = gs.coins;
            }
            updateSkillsUI();
            
            // Update slime name display
            const slimeNameDisplay = document.getElementById('slime-name-display');
            if (slimeNameDisplay && gs.slimeName) {
                slimeNameDisplay.textContent = gs.slimeName;
            }
            
            document.getElementById('level-display').textContent = gs.level;
            
            // Show slime if hatched
            const slimeSquare = document.getElementById('slime-square');
            if (slimeSquare) {
                if (gs.hatched) {
                    slimeSquare.classList.add('visible');
                    // Load the saved slime variant
                    if (gs.slimeVariant) {
                        slimeSquare.style.backgroundImage = `url('./slimehearth-assets/images/${gs.slimeVariant}')`;
                    }
                } else {
                    slimeSquare.classList.remove('visible');
                }
            }
            
            // Update slime XP bar
            const slimeXPBar = document.getElementById('slime-xp-bar');
            const slimeXPText = document.getElementById('slime-xp');
            const slimeXPNeededText = document.getElementById('slime-xp-needed');
            
            if (slimeXPBar) {
                const percent = (gs.slimeXP / gs.slimeXPNeeded) * 100;
                slimeXPBar.style.width = percent + '%';
            }
            if (slimeXPText) slimeXPText.textContent = gs.slimeXP;
            if (slimeXPNeededText) slimeXPNeededText.textContent = gs.slimeXPNeeded;
            
            // Show/hide hatch button
            const hatchBtn = document.getElementById('hatch-btn');
            hatchBtn.style.display = gs.hatched ? 'none' : 'block';
        }
        
        function addSkillXP(skillName, amount) {
            console.log('addSkillXP called:', skillName, amount);
            
            // Ensure skills exist
            if (!gs.skills) {
                console.error('gs.skills is undefined! Initializing...');
                gs.skills = {
                    fishing: { level: 1, xp: 0, xpNeeded: 100 },
                    farming: { level: 1, xp: 0, xpNeeded: 100 },
                    cooking: { level: 1, xp: 0, xpNeeded: 100 }
                };
            }
            
            const skill = gs.skills[skillName];
            if (!skill) {
                console.error('Skill not found:', skillName);
                return;
            }
            
            skill.xp += amount;
            console.log(skillName + ' XP:', skill.xp + '/' + skill.xpNeeded);
            
            // Level up check
            while (skill.xp >= skill.xpNeeded) {
                skill.xp -= skill.xpNeeded;
                skill.level++;
                skill.xpNeeded = Math.floor(skill.xpNeeded * 1.5);
                notify('üéâ ' + skillName.charAt(0).toUpperCase() + skillName.slice(1) + ' Level ' + skill.level + '!');
            }
            
            // Show XP gain notification (subtle)
            notify('+' + amount + ' ' + skillName + ' XP');
            
            save();
            updateSkillsUI();
        }
        
        function updateSkillsUI() {
            if (!gs.skills) return; // Safety check
            
            ['fishing', 'farming', 'cooking'].forEach(skillName => {
                const skill = gs.skills[skillName];
                if (!skill) return; // Safety check
                
                const levelEl = document.getElementById(skillName + '-level');
                const xpEl = document.getElementById(skillName + '-xp');
                const xpNeededEl = document.getElementById(skillName + '-xp-needed');
                const barEl = document.getElementById(skillName + '-xp-bar');
                
                if (levelEl) levelEl.textContent = skill.level;
                if (xpEl) xpEl.textContent = skill.xp;
                if (xpNeededEl) xpNeededEl.textContent = skill.xpNeeded;
                if (barEl) {
                    const percent = (skill.xp / skill.xpNeeded) * 100;
                    barEl.style.width = percent + '%';
                }
            });
        }
        
        function addItem(itemId, quantity = 1) {
            const currentCount = Object.keys(gs.inventory).length;
            const spaceLeft = MAX_INVENTORY - currentCount;
            
            if (spaceLeft <= 0) {
                notifyInventoryFull();
                return;
            }
            
            const toAdd = Math.min(quantity, spaceLeft);
            for (let i = 0; i < toAdd; i++) {
                const key = itemId + '_' + gs.itemCounter++;
                gs.inventory[key] = itemId; // Store the itemId string, not 1!
            }
            save();
            
            if (toAdd < quantity) {
                notify(`+${toAdd} ${itemId} (inventory full!)`);
            } else {
                notify(`+${toAdd} ${itemId}`);
            }
            
            updateInventoryCounter();
            
            // Only spawn new items in basket if basket is open
            const container = document.getElementById('basket-container');
            if (container && container.classList.contains('active') && basketEngine) {
                // Spawn only the newly added items
                for (let i = 0; i < toAdd; i++) {
                    const key = itemId + '_' + (gs.itemCounter - toAdd + i);
                    spawnSingleItem(key);
                }
            }
        }
        
        // ===== NAVIGATION =====
        function switchRoom(roomId) {
            document.querySelectorAll('.room').forEach(r => r.classList.remove('active'));
            document.getElementById(roomId).classList.add('active');
            
            // Show/hide sell basket walls based on room
            if (basketEngine && sellWalls.length > 0) {
                // Remove sell walls first
                sellWalls.forEach(wall => {
                    if (wall.isStatic) World.remove(basketEngine.world, wall);
                });
                
                // Add sell walls only if in shop
                if (roomId === 'shop-room') {
                    World.add(basketEngine.world, sellWalls);
                }
            }
        }
        
        document.getElementById('nav-home').onclick = () => switchRoom('home-room');
        document.getElementById('nav-area').onclick = () => switchRoom('area-room');
        document.getElementById('nav-shop').onclick = () => {
            switchRoom('shop-room');
            displayShopGrid();
        };
        document.getElementById('nav-shack').onclick = () => {
            switchRoom('shack-room');
            updateCrackButton();
            updateProspectingDisplay();
        };
        document.getElementById('nav-room').onclick = () => switchRoom('room-room');
        document.getElementById('nav-settings').onclick = () => {
            const overlay = document.getElementById('settings-overlay');
            const backdrop = document.getElementById('settings-backdrop');
            if (overlay.style.display === 'none') {
                overlay.style.display = 'block';
                backdrop.style.display = 'block';
            } else {
                overlay.style.display = 'none';
                backdrop.style.display = 'none';
            }
        };
        
        document.getElementById('close-settings').onclick = () => {
            document.getElementById('settings-overlay').style.display = 'none';
            document.getElementById('settings-backdrop').style.display = 'none';
        };
        
        // Click backdrop to close
        document.getElementById('settings-backdrop').onclick = () => {
            document.getElementById('settings-overlay').style.display = 'none';
            document.getElementById('settings-backdrop').style.display = 'none';
        };
        document.getElementById('skills-btn').onclick = () => {
            const overlay = document.getElementById('skills-overlay');
            if (overlay.style.display === 'none') {
                overlay.style.display = 'block';
            } else {
                overlay.style.display = 'none';
            }
        };
        document.getElementById('close-skills').onclick = () => {
            document.getElementById('skills-overlay').style.display = 'none';
        };
        
        // Stats overlay handlers
        document.getElementById('level-display-container').onclick = () => {
            const overlay = document.getElementById('stats-overlay');
            if (overlay.style.display === 'none') {
                updateStatsDisplay();
                overlay.style.display = 'block';
            } else {
                overlay.style.display = 'none';
            }
        };
        document.getElementById('close-stats').onclick = () => {
            document.getElementById('stats-overlay').style.display = 'none';
        };
        
        function toggleBasket() {
            console.log('Toggling basket');
            
            const container = document.getElementById('basket-container');
            if (container.classList.contains('active')) {
                console.log('Closing basket');
                container.classList.remove('active');
                stopBasket();
            } else {
                console.log('Opening basket');
                container.classList.add('active');
                
                if (!basketEngine) {
                    console.log('Initializing basket for first time');
                    initBasket();
                } else {
                    console.log('Basket already initialized, populating');
                    populateBasket();
                }
            }
        }
        
        const bagBtn = document.getElementById('floating-bag-btn');
        
        // Use mousedown for faster response
        bagBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleBasket();
        });
        
        // Use touchstart for mobile (faster than touchend)
        bagBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleBasket();
        }, { passive: false });
        
        // ===== BASKET SYSTEM =====
        function initBasket() {
            // Set basket background image
            const basketBg = document.getElementById('basket-bg-image');
            if (basketBg) {
                basketBg.style.backgroundImage = "url('data:image/png;base64," + BASKET_IMAGE + "')";
                basketBg.style.backgroundSize = 'contain';
                basketBg.style.backgroundRepeat = 'no-repeat';
                basketBg.style.backgroundPosition = 'left bottom';
                console.log('Basket background image set');
            }
            
            console.log('Basket opening...');
            const canvas = document.getElementById('basket-canvas');
            if (!canvas) return;
            
            // Create engine
            basketEngine = Engine.create();
            basketEngine.world.bounds = { min: { x: -1000, y: -1000 }, max: { x: 1820, y: 1700 } };
            basketEngine.gravity.y = 0.5;
            
            // Create renderer
            basketRender = Render.create({
                canvas: canvas,
                engine: basketEngine,
                options: {
                    width: 820,
                    height: 1200,
                    wireframes: false,
                    background: 'transparent'
                }
            });
            
            // Create basket walls (no top)
            const basketCenterX = 150;
            const basketBottom = 1194;
            const basketWidth = 180;
            const wallHeight = 112;
            const wallThickness = 6;
            
            const leftWall = Bodies.rectangle(
                basketCenterX - basketWidth/2 + wallThickness/2,
                basketBottom - wallHeight/2,
                wallThickness,
                wallHeight,
                { isStatic: true, render: { fillStyle: '#444' } }
            );
            
            const rightWall = Bodies.rectangle(
                basketCenterX + basketWidth/2 - wallThickness/2,
                basketBottom - wallHeight/2,
                wallThickness,
                wallHeight,
                { isStatic: true, render: { fillStyle: '#444' } }
            );
            
            const bottom = Bodies.rectangle(
                basketCenterX,
                basketBottom - 10,
                basketWidth,
                20,
                { isStatic: true, render: { fillStyle: '#444' } }
            );
            
            // Invisible floor at canvas bottom - sized for 820px canvas
            const invisibleFloor = Bodies.rectangle(
                410, 1230, 1100, 100,  // Centered at 410 (middle of 820)
                { isStatic: true, render: { visible: false } }
            );
            
            World.add(basketEngine.world, [leftWall, rightWall, bottom, invisibleFloor]);
            
            // Sell basket solid walls (responsive positioning)
            // Desktop: far right corner, Mobile: centered to be fully visible
            const isMobile = window.innerWidth <= 700;
            const sellBasketCenterX = isMobile ? 300 : 730; // Mobile: 300 (centered), Desktop: 730
            const sellBasketBottom = 1194;
            const sellBasketWidth = 180;
            const sellWallHeight = 112;
            const sellWallThickness = 6;
            
            const sellLeftWall = Bodies.rectangle(
                sellBasketCenterX - sellBasketWidth/2 + sellWallThickness/2,
                sellBasketBottom - sellWallHeight/2,
                sellWallThickness,
                sellWallHeight,
                { isStatic: true, render: { fillStyle: '#ffd700' } }
            );
            
            const sellRightWall = Bodies.rectangle(
                sellBasketCenterX + sellBasketWidth/2 - sellWallThickness/2,
                sellBasketBottom - sellWallHeight/2,
                sellWallThickness,
                sellWallHeight,
                { isStatic: true, render: { fillStyle: '#ffd700' } }
            );
            
            const sellBottom = Bodies.rectangle(
                sellBasketCenterX,
                sellBasketBottom - 10,
                sellBasketWidth,
                20,
                { isStatic: true, render: { fillStyle: '#ffd700' } }
            );
            
            // Store sell walls for later removal
            sellWalls = [sellLeftWall, sellRightWall, sellBottom];
            
            // Only add sell walls if we're in the shop
            const shopActive = document.getElementById('shop-room').classList.contains('active');
            if (shopActive) {
                World.add(basketEngine.world, sellWalls);
            }
            
            // Velocity limiter
            Events.on(basketEngine, 'beforeUpdate', () => {
                basketBodies.forEach(body => {
                    const maxSpeed = 21.5;
                    const speed = Math.sqrt(body.velocity.x ** 2 + body.velocity.y ** 2);
                    
                    if (speed > maxSpeed) {
                        const scale = maxSpeed / speed;
                        Matter.Body.setVelocity(body, {
                            x: body.velocity.x * scale,
                            y: body.velocity.y * scale
                        });
                    }
                });
            });
            
            // Return forces for items outside basket
            Events.on(basketEngine, 'afterUpdate', () => {
                const basketLeft = 65;
                const basketRight = 235;
                const basketTop = 1080;
                
                basketBodies.forEach(body => {
                    const nearFloor = body.position.y > 1150;
                    const aboveBasket = body.position.y < basketTop;
                    
                    if (body.position.x < basketLeft) {
                        const pullStrength = nearFloor ? 0.06 : 0.00002;
                        const upForce = nearFloor ? -0.07 : 0;
                        Matter.Body.applyForce(body, body.position, { x: pullStrength, y: upForce });
                    } else if (body.position.x > basketRight) {
                        const pullStrength = nearFloor ? 0.06 : 0.00002;
                        const upForce = nearFloor ? -0.07 : 0;
                        Matter.Body.applyForce(body, body.position, { x: -pullStrength, y: upForce });
                    }
                    
                    if (aboveBasket && body.position.x > basketLeft && body.position.x < basketRight) {
                        Matter.Body.applyForce(body, body.position, { x: 0, y: 0.01 });
                    }
                });
            });
            
            // Eating mechanic - only on home screen
            Events.on(basketEngine, 'beforeUpdate', () => {
                if (!gs.hatched) return;
                
                const homeRoom = document.getElementById('home-room');
                const isHome = homeRoom && homeRoom.classList.contains('active');
                
                if (!isHome) {
                    const mouth = document.getElementById('slime-mouth');
                    if (mouth) mouth.style.display = 'none';
                    return;
                }
                
                // Get actual slime position from the DOM
                const slimeElement = document.getElementById('slime-square');
                const basketCanvas = document.getElementById('basket-canvas');
                
                if (!slimeElement || !basketCanvas) return;
                
                const slimeRect = slimeElement.getBoundingClientRect();
                const canvasRect = basketCanvas.getBoundingClientRect();
                
                // Calculate slime center in canvas coordinates
                const slimeCenterX = slimeRect.left + slimeRect.width / 2;
                const slimeCenterY = slimeRect.top + slimeRect.height / 2;
                const canvasLeft = canvasRect.left;
                const canvasTop = canvasRect.top;
                
                // Convert to canvas coordinates and add offset
                // Offset: +100px right, +100px down to match visual slime position
                const slimeX = slimeCenterX - canvasLeft + 100;
                const slimeY = slimeCenterY - canvasTop + 100;
                
                const mouth = document.getElementById('slime-mouth');
                
                // Show/hide mouth based on screen
                if (mouth) {
                    mouth.style.display = isHome ? 'block' : 'none';
                }
                
                if (!isHome) return;
                
                let foodNearby = false;
                
                for (let i = basketBodies.length - 1; i >= 0; i--) {
                    const b = basketBodies[i];
                    if (!b || !b.itemId) continue;
                    
                    const itemData = ITEM_DATA[b.itemId];
                    if (!itemData || !itemData.feedable) continue;
                    
                    const dist = Math.sqrt((b.position.x - slimeX)**2 + (b.position.y - slimeY)**2);
                    
                    if (dist < 80) {
                        foodNearby = true;
                    }
                    
                    if (dist < 40) {
                        World.remove(basketEngine.world, b);
                        basketBodies.splice(i, 1);
                        delete gs.inventory[b.itemKey];
                        
                        // Check if it's a basket (treasure chest)
                        if (itemData.isBasket) {
                            // Open basket and give random items!
                            openBasket();
                        } else {
                            // Regular food - grant stats!
                            if (!gs.stats) {
                                gs.stats = {
                                    doubleXpChance: 0,
                                    doubleLootChance: 0,
                                    bonusGeodeChance: 0,
                                    rareFindChance: 0,
                                    foodsEaten: 0
                                };
                            }
                            
                            gs.stats.foodsEaten++;
                            
                            // Each food grants random stat boost (0.1-0.3%)
                            const statRoll = Math.random();
                            if (statRoll < 0.25) {
                                gs.stats.doubleXpChance += 0.1 + Math.random() * 0.2;
                                notify('üìà +Double XP Chance!', 'achievement');
                            } else if (statRoll < 0.5) {
                                gs.stats.doubleLootChance += 0.1 + Math.random() * 0.2;
                                notify('üìà +Double Loot Chance!', 'achievement');
                            } else if (statRoll < 0.75) {
                                gs.stats.bonusGeodeChance += 0.1 + Math.random() * 0.2;
                                notify('üìà +Bonus Geode Chance!', 'achievement');
                            } else {
                                gs.stats.rareFindChance += 0.1 + Math.random() * 0.2;
                                notify('üìà +Rare Find Chance!', 'achievement');
                            }
                            
                            gs.hunger = Math.min(100, gs.hunger + itemData.foodValue);
                            
                            // Add slime XP
                            const xpGain = itemData.foodValue * 2;
                            gs.slimeXP += xpGain;
                            
                            // Level up check
                            while (gs.slimeXP >= gs.slimeXPNeeded) {
                                gs.slimeXP -= gs.slimeXPNeeded;
                                gs.level++;
                                gs.slimeXPNeeded = Math.floor(gs.slimeXPNeeded * 1.5);
                                notify('üéâ Slime Level Up! Level ' + gs.level, 'levelup');
                                
                                // Create a small geode on level up
                                addItem('small_geode', 1);
                                notify('üíé Found a Small Geode!');
                            }
                            
                            notify('+' + itemData.foodValue + ' hunger! +' + xpGain + ' XP!');
                        }
                        
                        save();
                        updateUI();
                        updateInventoryCounter();
                    }
                }
                
                if (mouth) {
                    mouth.style.opacity = foodNearby ? '1' : '0';
                }
            });
            
            // Mouse control
            const mouse = Mouse.create(canvas);
            
            // Scale mouse coordinates to compensate for CSS scale(0.8)
            mouse.pixelRatio = 0.8;
            
            console.log('Creating mouse constraint...');
            mouseConstraint = MouseConstraint.create(basketEngine, {
                mouse: mouse,
                constraint: {
                    stiffness: 1.9,
                    render: { visible: false }
                }
            });
            World.add(basketEngine.world, mouseConstraint);
            
            console.log('Adding drag event listeners...');
            
            // Tooltip on drag
            Events.on(mouseConstraint, 'startdrag', function(event) {
                const body = event.body;
                console.log('Start drag event fired!', body);
                if (body && body.itemId) {
                    console.log('Showing tooltip for:', body.itemId);
                    showItemTooltip(body.itemId);
                }
            });
            
            Events.on(mouseConstraint, 'enddrag', function(event) {
                console.log('End drag event fired!');
                hideItemTooltip();
            });
            
            // Hover tooltip - check what's under mouse
            let lastHoveredBody = null;
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // Convert to world coordinates
                const bodies = basketBodies;
                let hoveredBody = null;
                
                for (const body of bodies) {
                    const bounds = body.bounds;
                    if (mouseX >= bounds.min.x && mouseX <= bounds.max.x &&
                        mouseY >= bounds.min.y && mouseY <= bounds.max.y) {
                        hoveredBody = body;
                        break;
                    }
                }
                
                // Show/hide tooltip based on hover
                if (hoveredBody && hoveredBody !== lastHoveredBody) {
                    if (hoveredBody.itemId) {
                        showItemTooltip(hoveredBody.itemId);
                    }
                } else if (!hoveredBody && lastHoveredBody) {
                    hideItemTooltip();
                }
                
                lastHoveredBody = hoveredBody;
            });
            
            // Mouse coordinates debug
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const coordsDiv = document.getElementById('mouse-coords');
                if (coordsDiv) {
                    coordsDiv.textContent = Math.round(x) + ', ' + Math.round(y);
                }
            });
            
            
            // SELL DETECTION - items in sell basket area get sold
            Events.on(basketEngine, 'beforeUpdate', () => {
                const shopActive = document.getElementById('shop-room').classList.contains('active');
                if (!shopActive) return;
                
                // Sell basket area: responsive positioning
                // Desktop: 640-820 (centered at 730), Mobile: 210-390 (centered at 300)
                const isMobile = window.innerWidth <= 700;
                const sellMinX = isMobile ? 210 : 640;
                const sellMaxX = isMobile ? 390 : 820;
                
                for (let i = basketBodies.length - 1; i >= 0; i--) {
                    const body = basketBodies[i];
                    if (!body || !body.itemKey) continue;
                    
                    const inSellX = body.position.x > sellMinX && body.position.x < sellMaxX;
                    const inSellY = body.position.y > 1082;
                    
                    if (inSellX && inSellY) {
                        // Get sell price from ITEM_DATA
                        const itemData = ITEM_DATA[body.itemId];
                        const sellPrice = itemData ? itemData.sellValue : 1;
                        
                        gs.coins += sellPrice;
                        notify('Sold ' + (itemData ? itemData.name : body.itemId) + ' for ' + sellPrice + ' coins! üí∞');
                        
                        // Remove
                        World.remove(basketEngine.world, body);
                        basketBodies.splice(i, 1);
                        delete gs.inventory[body.itemKey];
                        
                        save();
                        updateUI();
                        updateInventoryCounter();
                    }
                }
            });
            
// Populate with items
            populateBasket();
            
            // Run engine
            basketRunner = Runner.create();
            Runner.run(basketRunner, basketEngine);
            Render.run(basketRender);
        }
        
        function spawnSingleItem(key) {
            if (!basketEngine) return;
            const { Bodies, World } = Matter;
            
            const itemId = gs.inventory[key]; // Get itemId from inventory value, not by parsing key
            const color = ITEM_COLORS[itemId] || '#ff6b9d';
            
            // Spawn at top-center
            const x = 80 + Math.random() * 140;
            const y = -50;
            
            const renderOptions = { fillStyle: color };
            
            // Use image for fish types if available
            const itemData = ITEM_DATA[itemId];
            if (itemData && itemData.image && ITEM_IMAGES[itemId]) {
                console.log(`üêü Rendering ${itemId} with image:`, ITEM_IMAGES[itemId]);
                renderOptions.sprite = {
                    texture: ITEM_IMAGES[itemId],
                    xScale: 0.075,  // Half of 0.15
                    yScale: 0.075
                };
            } else {
                console.log(`üì¶ Rendering ${itemId} as colored box`);
            }
            
            const box = Bodies.rectangle(x, y, 40, 40, {
                restitution: 0.4,
                friction: 0.8,
                render: renderOptions,
                itemKey: key,
                itemId: itemId
            });
            
            World.add(basketEngine.world, box);
            basketBodies.push(box);
            
            // Add glow effect for rare items
            createItemGlow(box, itemId);
        }
        
        function createItemGlow(body, itemId) {
            const itemData = ITEM_DATA[itemId];
            if (!itemData) return;
            
            const canvas = document.getElementById('basket-canvas');
            if (!canvas) return;
            
            // Determine beam based on rarity
            let beamWidth = 0;
            let beamColor = '';
            let shouldBeam = false;
            
            switch(itemData.rarity) {
                case 'Uncommon':
                    beamWidth = 10; // Was 40, now 1/4
                    beamColor = '#4ade80'; // Green
                    shouldBeam = true;
                    break;
                case 'Rare':
                    beamWidth = 15; // Was 60, now 1/4
                    beamColor = '#a78bfa'; // Purple
                    shouldBeam = true;
                    break;
                case 'Epic':
                    beamWidth = 20; // Was 80, now 1/4
                    beamColor = '#f59e0b'; // Orange
                    shouldBeam = true;
                    break;
                case 'Legendary':
                    beamWidth = 25; // Was 100, now 1/4
                    beamColor = '#fbbf24'; // Gold
                    shouldBeam = true;
                    break;
            }
            
            if (!shouldBeam) return;
            
            // Create beam element that shoots UP from bottom
            const beam = document.createElement('div');
            beam.className = 'item-beam';
            beam.style.width = beamWidth + 'px';
            beam.style.height = '0%';
            beam.style.left = (body.position.x - beamWidth/2) + 'px';
            beam.style.bottom = '0px'; // Start from bottom
            beam.style.background = `linear-gradient(to top, ${beamColor}00 0%, ${beamColor}ff 20%, ${beamColor}ff 80%, ${beamColor}00 100%)`;
            beam.style.boxShadow = `0 0 ${beamWidth*2}px ${beamColor}, inset 0 0 ${beamWidth}px ${beamColor}`;
            
            canvas.parentElement.appendChild(beam);
            
            // Remove beam after animation completes (0.8s)
            setTimeout(() => {
                beam.remove();
            }, 800);
        }
        
        function populateBasket() {
            if (!basketEngine) return;
            
            // Clear existing items
            basketBodies.forEach(body => World.remove(basketEngine.world, body));
            basketBodies = [];
            
            // Add items from inventory
            const items = Object.keys(gs.inventory);
            items.forEach((key, idx) => {
                const itemId = gs.inventory[key]; // Get itemId from inventory value, not by parsing key
                const color = ITEM_COLORS[itemId] || '#ff6b9d';
                
                const x = 80 + Math.random() * 140;
                const y = -50 - (idx * 45);
                
                const renderOptions = { fillStyle: color };
                
                // Use image for fish types if available
                const itemData = ITEM_DATA[itemId];
                if (itemData && itemData.image && ITEM_IMAGES[itemId]) {
                    renderOptions.sprite = {
                        texture: ITEM_IMAGES[itemId],
                        xScale: 0.075,
                        yScale: 0.075
                    };
                }
                
                const box = Bodies.rectangle(x, y, 40, 40, {
                    restitution: 0.4,
                    friction: 0.8,
                    render: renderOptions,
                    itemKey: key,
                    itemId: itemId
                });
                
                World.add(basketEngine.world, box);
                basketBodies.push(box);
                
                // Add glow effect for rare items
                createItemGlow(box, itemId);
            });
            
            updateInventoryCounter();
        }
        
        
        function initSellBasket() {
            const canvas = document.getElementById('sell-basket-canvas');
            if (!canvas) return;
            
            // Create engine
            sellBasketEngine = Engine.create();
            sellBasketEngine.world.bounds = { min: { x: -500, y: -500 }, max: { x: 850, y: 1100 } };
            sellBasketEngine.gravity.y = 0.5;
            
            // Create renderer
            sellBasketRender = Render.create({
                canvas: canvas,
                engine: sellBasketEngine,
                options: {
                    width: 350,
                    height: 600,
                    wireframes: false,
                    background: 'transparent'
                }
            });
            
            // Create sell basket walls (centered in 350px width)
            const basketCenterX = 175;
            const basketBottom = 580;
            const basketWidth = 180;
            const wallHeight = 112;
            const wallThickness = 6;
            
            const leftWall = Bodies.rectangle(
                basketCenterX - basketWidth/2 + wallThickness/2,
                basketBottom - wallHeight/2,
                wallThickness,
                wallHeight,
                { isStatic: true, render: { fillStyle: '#888' } }
            );
            
            const rightWall = Bodies.rectangle(
                basketCenterX + basketWidth/2 - wallThickness/2,
                basketBottom - wallHeight/2,
                wallThickness,
                wallHeight,
                { isStatic: true, render: { fillStyle: '#888' } }
            );
            
            const bottom = Bodies.rectangle(
                basketCenterX,
                basketBottom - 10,
                basketWidth,
                20,
                { isStatic: true, render: { fillStyle: '#888' } }
            );
            
            const invisibleFloor = Bodies.rectangle(
                175, 620, 400, 100,
                { isStatic: true, render: { visible: false } }
            );
            
            World.add(sellBasketEngine.world, [leftWall, rightWall, bottom, invisibleFloor]);
            
            // Velocity limiter
            Events.on(sellBasketEngine, 'beforeUpdate', () => {
                sellBasketBodies.forEach(body => {
                    const maxSpeed = 21.5;
                    const speed = Math.sqrt(body.velocity.x ** 2 + body.velocity.y ** 2);
                    
                    if (speed > maxSpeed) {
                        const scale = maxSpeed / speed;
                        Matter.Body.setVelocity(body, {
                            x: body.velocity.x * scale,
                            y: body.velocity.y * scale
                        });
                    }
                });
            });
            
            // Return forces
            Events.on(sellBasketEngine, 'afterUpdate', () => {
                const basketLeft = 90;
                const basketRight = 260;
                const basketTop = 468;
                
                sellBasketBodies.forEach(body => {
                    const nearFloor = body.position.y > 540;
                    const aboveBasket = body.position.y < basketTop;
                    
                    if (body.position.x < basketLeft) {
                        const pullStrength = nearFloor ? 0.06 : 0.00002;
                        const upForce = nearFloor ? -0.07 : 0;
                        Matter.Body.applyForce(body, body.position, { x: pullStrength, y: upForce });
                    } else if (body.position.x > basketRight) {
                        const pullStrength = nearFloor ? 0.06 : 0.00002;
                        const upForce = nearFloor ? -0.07 : 0;
                        Matter.Body.applyForce(body, body.position, { x: -pullStrength, y: upForce });
                    }
                    
                    if (aboveBasket && body.position.x > basketLeft && body.position.x < basketRight) {
                        Matter.Body.applyForce(body, body.position, { x: 0, y: 0.01 });
                    }
                });
            });
            
            // Selling detection - items touching bottom bar get sold instantly
            Events.on(sellBasketEngine, 'beforeUpdate', () => {
                for (let i = sellBasketBodies.length - 1; i >= 0; i--) {
                    const body = sellBasketBodies[i];
                    if (!body || !body.itemId) continue;
                    
                    // If item touches bottom bar (y > 560)
                    if (body.position.y > 560) {
                        // Sell the item
                        const sellPrice = getSellPrice(body.itemId);
                        gs.coins += sellPrice;
                        
                        notify(`Sold ${body.itemId} for ${sellPrice} coins!`);
                        
                        // Remove from physics and inventory
                        World.remove(sellBasketEngine.world, body);
                        sellBasketBodies.splice(i, 1);
                        
                        // Remove from main inventory too
                        delete gs.inventory[body.itemKey];
                        
                        // Remove from main basket if it exists
                        const mainIdx = basketBodies.findIndex(b => b.itemKey === body.itemKey);
                        if (mainIdx !== -1) {
                            if (basketEngine) World.remove(basketEngine.world, basketBodies[mainIdx]);
                            basketBodies.splice(mainIdx, 1);
                        }
                        
                        save();
                        updateUI();
                        updateInventoryCounter();
                    }
                }
            });
            
            // Mouse control
            const mouse = Mouse.create(canvas);
            sellBasketMouseConstraint = MouseConstraint.create(sellBasketEngine, {
                mouse: mouse,
                constraint: {
                    stiffness: 1.9,
                    render: { visible: false }
                }
            });
            World.add(sellBasketEngine.world, sellBasketMouseConstraint);
            
            // Don't populate - items come from dragging from main basket
            
            // Run engine
            sellBasketRunner = Runner.create();
            Runner.run(sellBasketRunner, sellBasketEngine);
            Render.run(sellBasketRender);
        }
        
        function populateSellBasket() {
            if (!sellBasketEngine) return;
            
            // Clear existing
            sellBasketBodies.forEach(body => World.remove(sellBasketEngine.world, body));
            sellBasketBodies = [];
            
            // Add items from inventory
            const items = Object.keys(gs.inventory);
            items.forEach((key, idx) => {
                const itemId = gs.inventory[key]; // Get itemId from inventory value, not by parsing key
                const color = ITEM_COLORS[itemId] || '#ff6b9d';
                
                const x = 105 + Math.random() * 140;
                const y = -50 - (idx * 45);
                
                const box = Bodies.rectangle(x, y, 40, 40, {
                    restitution: 0.4,
                    friction: 0.8,
                    render: { fillStyle: color },
                    itemKey: key,
                    itemId: itemId
                });
                
                World.add(sellBasketEngine.world, box);
                sellBasketBodies.push(box);
            });
        }
        
        function stopSellBasket() {
            if (sellBasketEngine) {
                Runner.stop(sellBasketRunner);
                Render.stop(sellBasketRender);
                Engine.clear(sellBasketEngine);
                sellBasketEngine = null;
                sellBasketRender = null;
                sellBasketRunner = null;
                sellBasketBodies = [];
            }
        }
        
        function getSellPrice(itemId) {
            // Use ITEM_DATA if available
            if (ITEM_DATA[itemId] && ITEM_DATA[itemId].sellValue !== undefined) {
                return ITEM_DATA[itemId].sellValue;
            }
            // Fallback to 1 if not found
            return 1;
        }
        
function stopBasket() {
            if (basketEngine) {
                Runner.stop(basketRunner);
                Render.stop(basketRender);
                Engine.clear(basketEngine);
                basketEngine = null;
                basketRender = null;
                basketRunner = null;
                basketBodies = [];
                sellWalls = [];
            }
        }
        
        // Close basket button
        document.getElementById('basket-close').onclick = () => {
            document.getElementById('basket-container').classList.remove('active');
            stopBasket();
        };
        
        
        // ===== FISHING MINIGAME =====
        // Pond: Click-and-hold
        let fishingProgress = 0;
        let fishingInterval = null;
        let fishingArea = 'pond';
        
        function startFishing(area) {
            fishingArea = area;
            fishingProgress = 0;
            updateFishingBar();
            
            const btn = document.getElementById('fish-' + area + '-btn');
            const result = document.getElementById('fishing-result-' + area);
            
            result.textContent = '';
            
            fishingInterval = setInterval(() => {
                fishingProgress += 2;
                updateFishingBar();
                
                if (fishingProgress >= 100) {
                    completeFishing(true);
                }
            }, 50);
        }
        
        function stopFishing() {
            if (fishingInterval) {
                clearInterval(fishingInterval);
                fishingInterval = null;
                
                if (fishingProgress < 100) {
                    completeFishing(false);
                }
            }
        }
        
        function updateFishingBar() {
            const bar = document.getElementById('fishing-bar-' + fishingArea);
            if (bar) {
                bar.style.width = fishingProgress + '%';
            }
        }
        
        // River: Timing minigame
        let riverFishingInterval = null;
        let riverBarPos = 0;
        let riverTargetPos = 150;
        let riverActive = false;
        
        function startRiverFishing() {
            if (riverActive) return;
            
            const bar = document.getElementById('fishing-bar-river');
            const target = document.getElementById('fishing-target-river');
            const timer = document.getElementById('fishing-timer-river');
            const castBtn = document.getElementById('cast-river');
            
            riverActive = true;
            riverBarPos = 0;
            riverTargetPos = Math.random() * 200 + 20;
            
            target.style.left = riverTargetPos + 'px';
            timer.textContent = 'Release in green!';
            
            // Start bar movement immediately
            riverFishingInterval = setInterval(() => {
                riverBarPos += 5;
                bar.style.left = riverBarPos + 'px';
                
                if (riverBarPos >= 270) {
                    endRiverFishing(false);
                }
            }, 30);
        }
        
        function stopRiverBar() {
            if (!riverActive) return;
            
            const bar = document.getElementById('fishing-bar-river');
            clearInterval(riverFishingInterval);
            
            const barLeft = parseInt(bar.style.left) || 0;
            const targetLeft = riverTargetPos;
            const targetRight = targetLeft + 80;
            
            const hit = barLeft >= targetLeft && barLeft <= targetRight;
            endRiverFishing(hit);
        }
        
        function endRiverFishing(success) {
            riverActive = false;
            clearInterval(riverFishingInterval);
            
            const bar = document.getElementById('fishing-bar-river');
            const timer = document.getElementById('fishing-timer-river');
            const castBtn = document.getElementById('cast-river');
            
            if (success) {
                timer.textContent = 'üéâ Success!';
                addItem('fish', 1);
                addSkillXP('fishing', 15);
            } else {
                timer.textContent = '‚ùå Missed!';
            }
            
            setTimeout(() => {
                riverBarPos = 0;
                bar.style.left = '0px';
                timer.textContent = '';
            }, 1500);
        }
        
        function completeFishing(success) {
            clearInterval(fishingInterval);
            fishingInterval = null;
            
            const result = document.getElementById('fishing-result-' + fishingArea);
            
            if (success) {
                // Random fish based on rarity
                const rand = Math.random();
                let caughtFish;
                
                if (rand < 0.50) {
                    caughtFish = 'fish1'; // Common - 50%
                } else if (rand < 0.80) {
                    caughtFish = 'fish2'; // Uncommon - 30%
                } else if (rand < 0.95) {
                    caughtFish = 'fish3'; // Rare - 15%
                } else {
                    caughtFish = 'fish4'; // Epic - 5%
                }
                
                const fishName = ITEM_DATA[caughtFish].name;
                result.textContent = `üé£ Caught a ${fishName}!`;
                addItem(caughtFish, 1);
                addSkillXP('fishing', 10);
                
                // 10% chance to find Water Key (only if not already obtained)
                if (!gs.keys.water_key && Math.random() < 0.10) {
                    gs.keys.water_key = true;
                    save();
                    notify('üíß Found a Water Key!', 'achievement');
                }
                
                // 5% chance to find a Basket
                if (Math.random() < 0.05) {
                    addItem('basket', 1);
                    notify('üß∫ Found a Basket!');
                }
            } else {
                result.textContent = '‚ùå It got away!';
            }
            
            setTimeout(() => {
                fishingProgress = 0;
                updateFishingBar();
                result.textContent = '';
            }, 1500);
        }
        
        
        // ===== GARDEN PLOT SYSTEM (WATER BUTTON LIKE SHACK) =====
        let gardenSlots = [null, null, null, null, null, null, null, null, null]; // 9 slots for seeds
        let gardenGrowing = false;
        let gardenStartTime = null;
        let gardenReadyTime = null;
        let gardenUpdateInterval = null;
        let harvestHoldTimer = null;
        let harvestHoldStartTime = 0;
        let harvestHoldProgress = 0;
        let harvestHoldSlotIndex = -1; // Track which slot is being harvested
        
        function initGardenPlots() {
            console.log('initGardenPlots called');
            
            // Only reset if not already set in game state
            if (!gs.gardenSlots) {
                gs.gardenSlots = [null, null, null, null, null, null, null, null, null];
            }
            if (gs.gardenGrowing === undefined) {
                gs.gardenGrowing = false;
            }
            
            // Use game state variables
            gardenSlots = gs.gardenSlots;
            gardenGrowing = gs.gardenGrowing;
            gardenStartTime = gs.gardenStartTime;
            gardenReadyTime = gs.gardenReadyTime;
            
            console.log('Garden state loaded:', {
                slots: gardenSlots,
                growing: gardenGrowing,
                readyTime: gardenReadyTime
            });
            
            // Set up click handlers for all 9 slots
            for (let i = 0; i < 9; i++) {
                const slot = document.getElementById(`garden-plot-slot-${i}`);
                if (slot) {
                    slot.onclick = () => showGardenSeedMenu(i);
                }
            }
            
            // Water button handler
            const waterBtn = document.getElementById('water-garden-btn');
            if (waterBtn) {
                waterBtn.onclick = waterGarden;
                console.log('Water button handler attached');
            } else {
                console.error('Water button not found!');
            }
            
            updateGardenDisplay();
        }
        
        function showGardenSeedMenu(slotIndex) {
            // Don't allow selecting if already growing
            if (gardenGrowing) {
                notify('‚ùå Plants are growing! Wait to harvest first.', 'warning');
                return;
            }
            
            // Count plantable items (seeds) in inventory
            const itemCounts = {};
            for (const key in gs.inventory) {
                const itemId = gs.inventory[key];
                if (ITEM_DATA[itemId] && ITEM_DATA[itemId].isPlantable) {
                    itemCounts[itemId] = (itemCounts[itemId] || 0) + 1;
                }
            }
            
            // Subtract seeds already placed in slots
            const alreadyPlaced = {};
            for (let i = 0; i < 9; i++) {
                if (gardenSlots[i]) {
                    alreadyPlaced[gardenSlots[i]] = (alreadyPlaced[gardenSlots[i]] || 0) + 1;
                }
            }
            
            // Calculate available (not yet placed)
            const availableCounts = {};
            for (const itemId in itemCounts) {
                const total = itemCounts[itemId];
                const placed = alreadyPlaced[itemId] || 0;
                const available = total - placed;
                if (available > 0) {
                    availableCounts[itemId] = available;
                }
            }
            
            console.log('Item counts:', itemCounts);
            console.log('Already placed:', alreadyPlaced);
            console.log('Available to place:', availableCounts);
            
            // Close existing menu if any
            const existingMenu = document.getElementById('garden-seed-menu');
            if (existingMenu) {
                existingMenu.remove();
                return;
            }
            
            const menu = document.createElement('div');
            menu.id = 'garden-seed-menu';
            menu.style.cssText = 'position:fixed;bottom:300px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.98);border:3px solid #8bc34a;border-radius:10px;padding:15px;z-index:10002;min-width:200px;box-shadow:0 4px 20px rgba(0,0,0,0.5);pointer-events:auto;';
            
            const header = document.createElement('div');
            header.style.cssText = 'font-weight:bold;margin-bottom:10px;color:#333;font-size:16px;';
            header.textContent = 'Select Seeds:';
            menu.appendChild(header);
            
            if (Object.keys(availableCounts).length === 0) {
                const empty = document.createElement('div');
                empty.style.cssText = 'color:#999;font-style:italic;padding:10px;';
                empty.textContent = 'No seeds available (check if already placed)';
                menu.appendChild(empty);
            } else {
                for (const itemId in availableCounts) {
                    const count = availableCounts[itemId];
                    const name = ITEM_DATA[itemId].name;
                    
                    const btn = document.createElement('div');
                    btn.style.cssText = 'width:100%;padding:12px;margin:5px 0;font-size:16px;border:2px solid #8bc34a;border-radius:8px;background:#fff;cursor:pointer;display:flex;justify-content:space-between;pointer-events:auto;';
                    btn.innerHTML = '<span>' + name + '</span><span style="color:#666;font-weight:bold;">x ' + count + '</span>';
                    btn.onclick = function(e) { 
                        e.stopPropagation(); 
                        selectGardenSeed(slotIndex, itemId); 
                    };
                    menu.appendChild(btn);
                }
            }
            
            const cancelBtn = document.createElement('div');
            cancelBtn.style.cssText = 'width:100%;padding:10px;margin-top:10px;background:#999;color:#fff;border:2px solid #666;border-radius:8px;cursor:pointer;text-align:center;pointer-events:auto;';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = function(e) {
                e.stopPropagation();
                closeGardenSeedMenu();
            };
            menu.appendChild(cancelBtn);
            
            document.body.appendChild(menu);
        }
        
        function selectGardenSeed(slotIndex, itemId) {
            console.log('selectGardenSeed called - slotIndex:', slotIndex, 'itemId:', itemId);
            
            // Count how many of this seed type are already placed in slots
            let alreadyPlaced = 0;
            for (let i = 0; i < 9; i++) {
                if (gardenSlots[i] === itemId) {
                    alreadyPlaced++;
                }
            }
            
            // Count how many of this seed type are in inventory
            let inInventory = 0;
            for (const key in gs.inventory) {
                if (gs.inventory[key] === itemId) {
                    inInventory++;
                }
            }
            
            console.log(`Seeds check: ${alreadyPlaced} already placed, ${inInventory} in inventory`);
            
            // Check if we have enough seeds
            if (alreadyPlaced >= inInventory) {
                notify('‚ùå Not enough seeds in inventory!', 'warning');
                closeGardenSeedMenu();
                return;
            }
            
            // Place seed in slot (don't remove from inventory yet)
            gardenSlots[slotIndex] = itemId;
            gs.gardenSlots[slotIndex] = itemId; // Save to game state
            console.log('gardenSlots after select:', gardenSlots);
            save(); // Save immediately
            updateGardenDisplay();
            closeGardenSeedMenu();
        }
        
        function closeGardenSeedMenu() {
            const menu = document.getElementById('garden-seed-menu');
            if (menu) menu.remove();
        }
        
        function waterGarden() {
            console.log('waterGarden called');
            console.log('Current gardenSlots:', gardenSlots);
            console.log('Current inventory:', gs.inventory);
            
            // Check if any seeds are placed
            const hasSeeds = gardenSlots.some(slot => slot !== null);
            if (!hasSeeds) {
                notify('‚ùå Place some seeds first!', 'warning');
                return;
            }
            
            // Check if already growing
            if (gardenGrowing) {
                notify('‚ùå Plants are already growing!', 'warning');
                return;
            }
            
            // Remove seeds from inventory - count how many we need to remove
            const seedsToRemove = {};
            for (let i = 0; i < 9; i++) {
                if (gardenSlots[i]) {
                    seedsToRemove[gardenSlots[i]] = (seedsToRemove[gardenSlots[i]] || 0) + 1;
                }
            }
            
            console.log('Seeds to remove:', seedsToRemove);
            
            // Remove the required amount of each seed type
            for (const seedType in seedsToRemove) {
                let countToRemove = seedsToRemove[seedType];
                for (const key in gs.inventory) {
                    if (countToRemove > 0 && gs.inventory[key] === seedType) {
                        console.log('Removing seed:', key, gs.inventory[key]);
                        delete gs.inventory[key];
                        countToRemove--;
                    }
                }
            }
            
            console.log('Inventory after removal:', gs.inventory);
            
            // Start growing
            gardenGrowing = true;
            gardenStartTime = Date.now();
            gardenReadyTime = gardenStartTime + 60000; // 1 minute
            
            // Save to game state
            gs.gardenGrowing = true;
            gs.gardenStartTime = gardenStartTime;
            gs.gardenReadyTime = gardenReadyTime;
            
            save();
            populateBasket(); // Re-populate basket with updated inventory
            updateGardenDisplay();
            notify('üíß Garden watered! Plants growing...');
            startGardenUpdateInterval();
        }
        
        function startHarvestHold(slotIndex) {
            if (harvestHoldTimer) return; // Already holding
            if (!gardenSlots[slotIndex]) return; // No crop in this slot
            
            // Check if inventory has space for 3 carrots
            const currentInventoryCount = Object.keys(gs.inventory).length;
            
            if (currentInventoryCount + 3 > MAX_INVENTORY) {
                notify('‚ùå Inventory full! Make space for 3 carrots before harvesting.', 'warning');
                console.log('Cannot harvest - inventory full:', currentInventoryCount, '/', MAX_INVENTORY, '(need space for 3)');
                return;
            }
            
            console.log('Starting harvest hold for slot:', slotIndex, '- Inventory:', currentInventoryCount, '/', MAX_INVENTORY);
            harvestHoldSlotIndex = slotIndex;
            harvestHoldStartTime = Date.now();
            harvestHoldProgress = 0;
            
            // Update progress every 100ms
            harvestHoldTimer = setInterval(() => {
                const elapsed = Date.now() - harvestHoldStartTime;
                harvestHoldProgress = Math.min(elapsed / 5000, 1); // 5 seconds = 100%
                
                updateHarvestProgressDisplay();
                updateSlotHarvestVisual(slotIndex);
                
                if (harvestHoldProgress >= 1) {
                    completeHarvest(slotIndex);
                }
            }, 100);
        }
        
        function stopHarvestHold() {
            if (harvestHoldTimer) {
                console.log('Stopping harvest hold');
                clearInterval(harvestHoldTimer);
                harvestHoldTimer = null;
                harvestHoldProgress = 0;
                harvestHoldSlotIndex = -1;
                updateHarvestProgressDisplay();
                updateGardenDisplay(); // Reset slot visuals
            }
        }
        
        function updateHarvestProgressDisplay() {
            const timerDisplay = document.getElementById('garden-timer-display');
            
            if (harvestHoldProgress > 0 && harvestHoldProgress < 1) {
                const percent = Math.floor(harvestHoldProgress * 100);
                timerDisplay.textContent = `ü•ï Harvesting... ${percent}%`;
                timerDisplay.style.color = '#ff9800';
            } else if (harvestHoldProgress >= 1) {
                timerDisplay.textContent = '‚úÖ Harvested!';
                timerDisplay.style.color = '#4caf50';
            } else {
                // Count remaining crops
                const remaining = gardenSlots.filter(s => s !== null).length;
                if (remaining > 0) {
                    timerDisplay.textContent = `‚úÖ Hold slot to harvest! (${remaining} left)`;
                    timerDisplay.style.color = '#4caf50';
                } else {
                    timerDisplay.textContent = '';
                }
            }
        }
        
        function updateSlotHarvestVisual(slotIndex) {
            const slot = document.getElementById(`garden-plot-slot-${slotIndex}`);
            if (!slot) return;
            
            // Pulse effect based on progress
            const scale = 1 + (Math.sin(harvestHoldProgress * Math.PI * 4) * 0.1);
            slot.style.transform = `scale(${scale})`;
            
            // Change background based on progress
            const greenIntensity = Math.floor(232 + (harvestHoldProgress * 23)); // 232 to 255
            slot.style.background = `rgb(${greenIntensity - 80}, ${greenIntensity}, ${greenIntensity - 80})`;
        }
        
        function completeHarvest(slotIndex) {
            stopHarvestHold();
            harvestSingleSlot(slotIndex);
        }
        
        function harvestSingleSlot(slotIndex) {
            if (!gardenSlots[slotIndex]) return;
            
            console.log('Harvesting slot:', slotIndex);
            
            // Double-check inventory space (safety check)
            const currentInventoryCount = Object.keys(gs.inventory).length;
            
            if (currentInventoryCount + 3 > MAX_INVENTORY) {
                notify('‚ùå Inventory full! Cannot harvest.', 'warning');
                console.log('Harvest blocked - inventory full:', currentInventoryCount, '/', MAX_INVENTORY);
                return;
            }
            
            console.log('Inventory check passed:', currentInventoryCount, '+ 3 <=', MAX_INVENTORY);
            
            // Give 3 carrots for this slot
            addItem('carrot', 3);
            addSkillXP('farming', 15);
            
            // Clear this slot
            gardenSlots[slotIndex] = null;
            gs.gardenSlots[slotIndex] = null;
            
            // Check if all slots are harvested
            const remaining = gardenSlots.filter(s => s !== null).length;
            console.log('Slots remaining:', remaining);
            
            if (remaining === 0) {
                // All harvested - reset garden
                console.log('All slots harvested - resetting garden');
                gardenGrowing = false;
                gardenStartTime = null;
                gardenReadyTime = null;
                gs.gardenGrowing = false;
                gs.gardenStartTime = null;
                gs.gardenReadyTime = null;
                stopGardenUpdateInterval();
            }
            
            save();
            updateGardenDisplay();
            
            const result = document.getElementById('garden-result');
            if (result) {
                result.textContent = `ü•ï Harvested 3 Carrots! ${remaining > 0 ? `(${remaining} left)` : ''}`;
                result.style.color = '#4caf50';
                setTimeout(() => result.textContent = '', 2000);
            }
            
            notify(`ü•ï Harvested 3 Carrots! +15 Farming XP${remaining > 0 ? ` (${remaining} slots left)` : ''}`);
        }
        
        // OLD harvestGarden - now using harvestSingleSlot per slot
        /*
        function harvestGarden() {
            if (!gardenGrowing || Date.now() < gardenReadyTime) return;
            
            // Count how many seeds were planted
            let harvestedCount = 0;
            for (let i = 0; i < 9; i++) {
                if (gardenSlots[i]) {
                    // Give 3 carrots per seed
                    addItem('carrot', 3);
                    harvestedCount++;
                }
            }
            
            // Reset garden
            gardenSlots = [null, null, null, null, null, null, null, null, null];
            gardenGrowing = false;
            gardenStartTime = null;
            gardenReadyTime = null;
            
            // Reset harvest hold state
            stopHarvestHold();
            harvestHoldProgress = 0;
            
            // Save to game state
            gs.gardenSlots = [null, null, null, null, null, null, null, null, null];
            gs.gardenGrowing = false;
            gs.gardenStartTime = null;
            gs.gardenReadyTime = null;
            
            // Give XP
            addSkillXP('farming', harvestedCount * 15);
            
            save();
            updateGardenDisplay();
            stopGardenUpdateInterval();
            
            const result = document.getElementById('garden-result');
            if (result) {
                result.textContent = `üéâ Harvested ${harvestedCount * 3} Carrots!`;
                result.style.color = '#4caf50';
                setTimeout(() => result.textContent = '', 3000);
            }
            
            notify(`ü•ï Harvested ${harvestedCount * 3} Carrots! +${harvestedCount * 15} Farming XP`);
        }
        */
        
        function updateGardenDisplay() {
            console.log('updateGardenDisplay called - gardenGrowing:', gardenGrowing, 'gardenSlots:', gardenSlots);
            // Update all 9 slots
            for (let i = 0; i < 9; i++) {
                const icon = document.getElementById(`garden-plot-icon-${i}`);
                const slot = document.getElementById(`garden-plot-slot-${i}`);
                
                if (!icon || !slot) continue;
                
                if (gardenGrowing) {
                    // Growing state - show seedling
                    if (gardenSlots[i]) {
                        icon.textContent = 'üå±';
                        slot.style.background = '#f1f8e9';
                        slot.style.borderColor = '#8bc34a';
                    } else {
                        icon.textContent = '';
                        slot.style.background = '#f5f5f5';
                        slot.style.borderColor = '#ccc';
                    }
                    slot.style.cursor = 'not-allowed';
                    slot.onclick = null;
                } else {
                    // Not growing - show selected or empty
                    if (gardenSlots[i]) {
                        icon.textContent = 'üå±';
                        slot.style.background = '#fef3c7';
                        slot.style.borderColor = '#f59e0b';
                    } else {
                        icon.textContent = '+';
                        slot.style.background = '#fff';
                        slot.style.borderColor = '#8bc34a';
                    }
                    slot.style.cursor = 'pointer';
                    slot.onclick = () => showGardenSeedMenu(i);
                }
            }
            
            // Update timer display
            const timerDisplay = document.getElementById('garden-timer-display');
            const waterBtn = document.getElementById('water-garden-btn');
            
            if (gardenGrowing) {
                const now = Date.now();
                const timeLeft = Math.ceil((gardenReadyTime - now) / 1000);
                
                if (timeLeft > 0) {
                    if (timerDisplay) timerDisplay.textContent = `‚è±Ô∏è Growing: ${timeLeft}s`;
                    if (waterBtn) {
                        waterBtn.textContent = 'üå± Growing...';
                        waterBtn.style.background = '#ccc';
                        waterBtn.style.cursor = 'not-allowed';
                        waterBtn.onclick = null;
                    }
                } else {
                    // Ready to harvest!
                    if (timerDisplay) updateHarvestProgressDisplay();
                    if (waterBtn) {
                        waterBtn.textContent = 'üíß Water';
                        waterBtn.style.background = '#ccc';
                        waterBtn.style.cursor = 'not-allowed';
                        waterBtn.onclick = null;
                    }
                    
                    // Update icons to carrots and add hold-to-harvest
                    for (let i = 0; i < 9; i++) {
                        if (gardenSlots[i]) {
                            const icon = document.getElementById(`garden-plot-icon-${i}`);
                            const slot = document.getElementById(`garden-plot-slot-${i}`);
                            if (icon) icon.textContent = 'ü•ï';
                            if (slot) {
                                slot.style.background = '#e8f5e9';
                                slot.style.borderColor = '#4caf50';
                                slot.style.cursor = 'pointer';
                                slot.style.transform = 'scale(1)'; // Reset transform
                                
                                // Add press-and-hold handlers with slot index
                                const slotIndex = i; // Capture in closure
                                slot.onmousedown = () => startHarvestHold(slotIndex);
                                slot.onmouseup = stopHarvestHold;
                                slot.onmouseleave = stopHarvestHold;
                                slot.ontouchstart = (e) => {
                                    e.preventDefault();
                                    startHarvestHold(slotIndex);
                                };
                                slot.ontouchend = (e) => {
                                    e.preventDefault();
                                    stopHarvestHold();
                                };
                                slot.ontouchcancel = stopHarvestHold;
                            }
                        } else {
                            // Empty slot - reset visual
                            const slot = document.getElementById(`garden-plot-slot-${i}`);
                            if (slot) {
                                slot.style.transform = 'scale(1)';
                            }
                        }
                    }
                }
            } else {
                if (timerDisplay) timerDisplay.textContent = '';
                if (waterBtn) {
                    waterBtn.textContent = 'üíß Water';
                    waterBtn.style.background = '#4dd0e1';
                    waterBtn.style.cursor = 'pointer';
                    waterBtn.onclick = waterGarden;
                }
            }
        }
        
        function startGardenUpdateInterval() {
            if (gardenUpdateInterval) return;
            
            gardenUpdateInterval = setInterval(() => {
                updateGardenDisplay();
                
                // Stop if not growing
                if (!gardenGrowing) {
                    stopGardenUpdateInterval();
                }
            }, 1000); // Update every second
        }
        
        function stopGardenUpdateInterval() {
            if (gardenUpdateInterval) {
                clearInterval(gardenUpdateInterval);
                gardenUpdateInterval = null;
            }
        }

        // ===== FARMING MINIGAMES =====
        let gardenTaps = 0;
        let gardenActive = false;
        let gardenTimer = null;
        let gardenTimeLeft = 5.0;
        
        function initGardenGame() {
            gardenTaps = 0;
            gardenTimeLeft = 5.0;
            gardenActive = false;
            document.getElementById('garden-taps-display').textContent = 'Taps: 0 / 20';
            document.getElementById('garden-timer-display').textContent = 'Time: 5.0s';
            document.getElementById('garden-result').textContent = '';
        }
        
        function startGardenGame() {
            if (gardenActive) return;
            gardenActive = true;
            gardenTaps = 0;
            gardenTimeLeft = 5.0;
            document.getElementById('garden-result').textContent = '';
            
            gardenTimer = setInterval(() => {
                gardenTimeLeft -= 0.1;
                document.getElementById('garden-timer-display').textContent = 'Time: ' + gardenTimeLeft.toFixed(1) + 's';
                if (gardenTimeLeft <= 0) endGardenGame();
            }, 100);
        }
        
        function tapGarden() {
            if (!gardenActive) startGardenGame();
            if (gardenActive) {
                gardenTaps++;
                document.getElementById('garden-taps-display').textContent = 'Taps: ' + gardenTaps + ' / 20';
                if (gardenTaps >= 20) endGardenGame();
            }
        }
        
        function endGardenGame() {
            clearInterval(gardenTimer);
            gardenActive = false;
            const result = document.getElementById('garden-result');
            if (gardenTaps >= 20) {
                result.textContent = 'üéâ Garden cleared! +1 Carrot';
                addItem('carrot', 1);
                addSkillXP('farming', 10);
                
                // 5% chance to find a Basket
                if (Math.random() < 0.05) {
                    addItem('basket', 1);
                    notify('üß∫ Found a Basket!');
                }
            } else {
                result.textContent = '‚ùå Not enough taps! (' + gardenTaps + '/20)';
            }
            setTimeout(() => initGardenGame(), 2000);
        }
        
        function stopGardenGame() {
            clearInterval(gardenTimer);
            gardenActive = false;
        }
        
        let fieldPattern = [];
        let fieldInput = [];
        let fieldActive = false;
        
        function initFieldGame() {
            fieldActive = true;
            fieldPattern = generateFieldPattern();
            fieldInput = [];
            document.getElementById('field-pattern-display').textContent = fieldPattern.join(' ');
            document.getElementById('field-input-display').textContent = '';
            document.getElementById('field-result').textContent = '';
        }
        
        function generateFieldPattern() {
            const plants = ['üåΩ', 'ü•ï', 'ü•î'];
            const pattern = [];
            for (let i = 0; i < 4; i++) {
                pattern.push(plants[Math.floor(Math.random() * plants.length)]);
            }
            return pattern;
        }
        
        function plantInField(plant) {
            if (!fieldActive) return;
            fieldInput.push(plant);
            document.getElementById('field-input-display').textContent = fieldInput.join(' ');
            
            for (let i = 0; i < fieldInput.length; i++) {
                if (fieldInput[i] !== fieldPattern[i]) {
                    const result = document.getElementById('field-result');
                    result.textContent = '‚ùå Wrong order! Try again';
                    setTimeout(() => {
                        fieldInput = [];
                        document.getElementById('field-input-display').textContent = '';
                        result.textContent = '';
                    }, 1500);
                    return;
                }
            }
            
            if (fieldInput.length === fieldPattern.length) {
                const result = document.getElementById('field-result');
                result.textContent = 'üéâ Perfect planting! +1 Carrot';
                addItem('carrot', 1);
                addSkillXP('farming', 15);
                setTimeout(() => initFieldGame(), 2000);
            }
        }
        
        function resetField() {
            fieldInput = [];
            document.getElementById('field-input-display').textContent = '';
            document.getElementById('field-result').textContent = '';
        }
        
        function stopFieldGame() {
            fieldActive = false;
        }
        

        // ===== THE HEARTH (DROPDOWN MENU SYSTEM) =====
        let hearthSlot1ItemId = null;
        let hearthSlot2ItemId = null;
        
        const RECIPES = {
            'fish+carrot': { result: 'food', name: 'üçñ Cooked Food' },
            'carrot+fish': { result: 'food', name: 'üçñ Cooked Food' }
        };
        
        function initHearth() {
            hearthSlot1ItemId = null;
            hearthSlot2ItemId = null;
            updateHearthDisplay();
            
            const slot1 = document.getElementById('hearth-slot-1');
            const slot2 = document.getElementById('hearth-slot-2');
            const cookBtn = document.getElementById('cook-hearth-btn');
            
            if (slot1) slot1.onclick = () => showHearthFoodMenu(1);
            if (slot2) slot2.onclick = () => showHearthFoodMenu(2);
            if (cookBtn) cookBtn.onclick = cookHearth;
        }
        
        function showHearthFoodMenu(slotNumber) {
            // Count feedable/cookable items
            const itemCounts = {};
            for (const key in gs.inventory) {
                const itemId = gs.inventory[key];
                if (ITEM_DATA[itemId] && (ITEM_DATA[itemId].feedable || ITEM_DATA[itemId].cookable)) {
                    itemCounts[itemId] = (itemCounts[itemId] || 0) + 1;
                }
            }
            
            // Close existing menu if any
            const existingMenu = document.getElementById('hearth-food-menu');
            if (existingMenu) {
                existingMenu.remove();
                return;
            }
            
            const menu = document.createElement('div');
            menu.id = 'hearth-food-menu';
            menu.style.cssText = 'position:fixed;bottom:300px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.98);border:3px solid #f59e0b;border-radius:10px;padding:15px;z-index:10001;min-width:200px;box-shadow:0 4px 20px rgba(0,0,0,0.5);';
            
            const header = document.createElement('div');
            header.style.cssText = 'font-weight:bold;margin-bottom:10px;color:#333;font-size:16px;';
            header.textContent = 'Select Ingredient:';
            menu.appendChild(header);
            
            if (Object.keys(itemCounts).length === 0) {
                const empty = document.createElement('div');
                empty.style.cssText = 'color:#999;font-style:italic;padding:10px;';
                empty.textContent = 'No ingredients in inventory';
                menu.appendChild(empty);
            } else {
                for (const itemId in itemCounts) {
                    const count = itemCounts[itemId];
                    const name = ITEM_DATA[itemId].name;
                    
                    const btn = document.createElement('div');
                    btn.style.cssText = 'width:100%;padding:12px;margin:5px 0;font-size:16px;border:2px solid #f59e0b;border-radius:8px;background:#fff;cursor:pointer;display:flex;justify-content:space-between;';
                    btn.innerHTML = '<span>' + name + '</span><span style="color:#666;font-weight:bold;">x ' + count + '</span>';
                    btn.onclick = function() { selectHearthFood(slotNumber, itemId); };
                    menu.appendChild(btn);
                }
            }
            
            const cancelBtn = document.createElement('div');
            cancelBtn.style.cssText = 'width:100%;padding:10px;margin-top:10px;background:#999;color:#fff;border:2px solid #666;border-radius:8px;cursor:pointer;text-align:center;';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = closeHearthFoodMenu;
            menu.appendChild(cancelBtn);
            
            document.body.appendChild(menu);
        }
        
        function selectHearthFood(slotNumber, itemId) {
            if (slotNumber === 1) {
                hearthSlot1ItemId = itemId;
            } else {
                hearthSlot2ItemId = itemId;
            }
            
            updateHearthDisplay();
            closeHearthFoodMenu();
        }
        
        function closeHearthFoodMenu() {
            const menu = document.getElementById('hearth-food-menu');
            if (menu) menu.remove();
        }
        
        function updateHearthDisplay() {
            const slot1Icon = document.getElementById('hearth-slot-1-icon');
            const slot1Name = document.getElementById('hearth-slot-1-name');
            const slot2Icon = document.getElementById('hearth-slot-2-icon');
            const slot2Name = document.getElementById('hearth-slot-2-name');
            
            if (slot1Icon && slot1Name) {
                if (hearthSlot1ItemId) {
                    const item = ITEM_DATA[hearthSlot1ItemId];
                    slot1Icon.textContent = item.name.includes('Fish') ? 'üêü' : (item.name.includes('Carrot') ? 'ü•ï' : 'üì¶');
                    slot1Name.textContent = item.name;
                } else {
                    slot1Icon.textContent = '+';
                    slot1Name.textContent = '';
                }
            }
            
            if (slot2Icon && slot2Name) {
                if (hearthSlot2ItemId) {
                    const item = ITEM_DATA[hearthSlot2ItemId];
                    slot2Icon.textContent = item.name.includes('Fish') ? 'üêü' : (item.name.includes('Carrot') ? 'ü•ï' : 'üì¶');
                    slot2Name.textContent = item.name;
                } else {
                    slot2Icon.textContent = '+';
                    slot2Name.textContent = '';
                }
            }
        }
        
        function cookHearth() {
            if (!hearthSlot1ItemId || !hearthSlot2ItemId) {
                notify('‚ùå Select two ingredients first!', 'warning');
                return;
            }
            
            const recipeKey = hearthSlot1ItemId + '+' + hearthSlot2ItemId;
            const recipe = RECIPES[recipeKey];
            
            const resultDiv = document.getElementById('hearth-result');
            
            if (recipe) {
                // Valid recipe! Find and remove one of each item
                let removed1 = false, removed2 = false;
                
                for (const key in gs.inventory) {
                    if (!removed1 && gs.inventory[key] === hearthSlot1ItemId) {
                        delete gs.inventory[key];
                        removed1 = true;
                    } else if (!removed2 && gs.inventory[key] === hearthSlot2ItemId) {
                        delete gs.inventory[key];
                        removed2 = true;
                    }
                    if (removed1 && removed2) break;
                }
                
                addItem(recipe.result, 1);
                addSkillXP('cooking', 15);
                
                if (resultDiv) {
                    resultDiv.textContent = '‚ú® Cooked ' + recipe.name + '!';
                    resultDiv.style.color = '#4caf50';
                    setTimeout(() => resultDiv.textContent = '', 3000);
                }
                
                notify('‚ú® Cooked ' + recipe.name + '!');
                
                hearthSlot1ItemId = null;
                hearthSlot2ItemId = null;
                updateHearthDisplay();
                save();
            } else {
                // Invalid recipe
                if (resultDiv) {
                    resultDiv.textContent = '‚ùå These ingredients don\'t make anything!';
                    resultDiv.style.color = '#f44336';
                    setTimeout(() => resultDiv.textContent = '', 3000);
                }
            }
        }

        // ===== COOKING MINIGAMES =====
        // Kitchen: Rhythm game - click when spoon flashes
        let kitchenScore = 0;
        let kitchenActive = false;
        let kitchenInterval = null;
        let kitchenFlashing = false;
        
        
        // Shack geode cracking functions
        let shackGeodeSlot = null;
        let shackCrackCount = 0;
        
        function showShackInventoryMenu() {
            console.log('showShackInventoryMenu called');
            
            const itemCounts = {};
            for (const key in gs.inventory) {
                const itemId = gs.inventory[key];
                if (ITEM_DATA[itemId] && ITEM_DATA[itemId].crackable) {
                    itemCounts[itemId] = (itemCounts[itemId] || 0) + 1;
                }
            }
            
            console.log('Crackable items:', itemCounts);
            
            const existingMenu = document.getElementById('shack-inventory-menu');
            if (existingMenu) {
                existingMenu.remove();
                return;
            }
            
            const menu = document.createElement('div');
            menu.id = 'shack-inventory-menu';
            menu.style.cssText = 'position:fixed;bottom:300px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.98);border:3px solid #333;border-radius:10px;padding:15px;z-index:10001;min-width:200px;box-shadow:0 4px 20px rgba(0,0,0,0.5);';
            
            const header = document.createElement('div');
            header.style.cssText = 'font-weight:bold;margin-bottom:10px;color:#333;font-size:16px;';
            header.textContent = 'Select Geode:';
            menu.appendChild(header);
            
            if (Object.keys(itemCounts).length === 0) {
                const empty = document.createElement('div');
                empty.style.cssText = 'color:#999;font-style:italic;padding:10px;';
                empty.textContent = 'No geodes in inventory';
                menu.appendChild(empty);
            } else {
                for (const itemId in itemCounts) {
                    const count = itemCounts[itemId];
                    const name = ITEM_DATA[itemId].name;
                    
                    const btn = document.createElement('div');
                    btn.style.cssText = 'width:100%;padding:12px;margin:5px 0;font-size:16px;border:2px solid #333;border-radius:8px;background:#fff;cursor:pointer;display:flex;justify-content:space-between;';
                    btn.innerHTML = '<span>üíé ' + name + '</span><span style="color:#666;font-weight:bold;">x ' + count + '</span>';
                    btn.onclick = function() { selectShackGeode(itemId); };
                    menu.appendChild(btn);
                }
            }
            
            const cancelBtn = document.createElement('div');
            cancelBtn.style.cssText = 'width:100%;padding:10px;margin-top:10px;background:#999;color:#fff;border:2px solid #666;border-radius:8px;cursor:pointer;text-align:center;';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = closeShackInventoryMenu;
            menu.appendChild(cancelBtn);
            
            document.body.appendChild(menu);
        }
        
        function selectShackGeode(itemId) {
            console.log('Selected geode:', itemId);
            shackGeodeSlot = itemId;
            
            const icon = document.getElementById('shack-slot-icon');
            if (icon) icon.textContent = 'üíé';
            
            const crackBtn = document.getElementById('crack-geode-btn');
            if (crackBtn) {
                crackBtn.style.background = '#4ade80';
                crackBtn.style.borderColor = '#22c55e';
            }
            
            shackCrackCount = 0;
            updateShackProgress();
            
            closeShackInventoryMenu();
            
            // Check if player has hammer
            if (!gs.tools.hammer) {
                notify('‚ö†Ô∏è You need a üî® Hammer to crack! (Shop)');
            } else {
                notify('Ready to crack! Tap 20 times!');
            }
        }
        
        function closeShackInventoryMenu() {
            const menu = document.getElementById('shack-inventory-menu');
            if (menu) menu.remove();
        }
        
        function updateShackProgress() {
            const display = document.getElementById('shack-progress-display');
            if (display) {
                display.textContent = 'Cracks: ' + shackCrackCount + ' / 20';
            }
        }
        
        function updateCrackButton() {
            const crackBtn = document.getElementById('crack-geode-btn');
            if (!crackBtn) return;
            
            const hasHammer = gs.tools.hammer || false;
            
            if (hasHammer) {
                // Unlocked appearance
                crackBtn.style.background = '#f5e6d3';
                crackBtn.style.borderColor = '#8b7355';
                crackBtn.style.opacity = '1';
                crackBtn.style.cursor = 'pointer';
            } else {
                // Locked appearance
                crackBtn.style.background = '#d1d5db';
                crackBtn.style.borderColor = '#9ca3af';
                crackBtn.style.opacity = '0.5';
                crackBtn.style.cursor = 'not-allowed';
            }
        }
        
        function crackGeode() {
            console.log('Crack clicked, geode:', shackGeodeSlot, 'count:', shackCrackCount);
            
            // Check if player has hammer
            if (!gs.tools.hammer) {
                notify('‚ùå You need a üî® Hammer! Buy one from the Shop.', 'warning');
                return;
            }
            
            if (!shackGeodeSlot) {
                notify('‚ùå Select a geode first!', 'warning');
                return;
            }
            
            shackCrackCount++;
            updateShackProgress();
            
            if (shackCrackCount >= 20) {
                finishCracking();
            }
        }
        
        function finishCracking() {
            console.log('Cracking complete!');
            
            const roll = Math.random();
            const isGem = roll < 0.10;
            console.log('Gem roll:', roll, 'Is gem:', isGem);
            
            const result = document.getElementById('shack-result');
            
            // FIRST: Remove geode from inventory
            let removedKey = null;
            for (const key in gs.inventory) {
                if (gs.inventory[key] === shackGeodeSlot) {
                    delete gs.inventory[key];
                    removedKey = key;
                    console.log('Removed geode from inventory:', key);
                    break;
                }
            }
            
            if (removedKey && basketEngine) {
                const bodyIndex = basketBodies.findIndex(b => b.itemKey === removedKey);
                if (bodyIndex !== -1) {
                    const body = basketBodies[bodyIndex];
                    World.remove(basketEngine.world, body);
                    basketBodies.splice(bodyIndex, 1);
                }
            }
            
            save();
            updateInventoryCounter();
            
            // THEN: Add rock or gem
            if (isGem) {
                result.textContent = 'üíé GEM! +1 Gem (50 coins!)';
                addItem('gem', 1);
                notify('‚ú® Found a GEM!');
            } else {
                result.textContent = 'ü™® Rock... +1 Rock (1 coin)';
                addItem('rock', 1);
                notify('üòê Just a rock...');
            }
            
            // Reset shack
            shackGeodeSlot = null;
            shackCrackCount = 0;
            
            const icon = document.getElementById('shack-slot-icon');
            if (icon) icon.textContent = '+';
            
            const crackBtn = document.getElementById('crack-geode-btn');
            if (crackBtn) {
                crackBtn.style.background = '#f5e6d3';
                crackBtn.style.borderColor = '#8b7355';
            }
            
            updateShackProgress();
            
            // Prospecting level-up check
            checkProspectingLevelUp();
            
            setTimeout(() => {
                result.textContent = '';
            }, 3000);
        }
        
        function updateProspectingDisplay() {
            const title = document.getElementById('shack-title');
            if (title) {
                title.textContent = `‚õèÔ∏è Prospecting Level ${gs.prospectingLevel}`;
            }
            
            // Update level-up chance info
            const info = document.getElementById('shack-levelup-info');
            if (info) {
                let chance = 0;
                switch(gs.prospectingLevel) {
                    case 1: chance = 90; break;
                    case 2: chance = 75; break;
                    case 3: chance = 50; break;
                    case 4: chance = 25; break;
                    default: chance = 10; break;
                }
                
                if (gs.prospectingLevel >= 10) {
                    info.textContent = 'Max Level Reached!';
                    info.style.color = '#2e7d32'; // Dark green for max level
                } else {
                    info.textContent = `${chance}% chance to level up with Small Geode`;
                    info.style.color = '#3e2723'; // Dark brown to match the box
                }
            }
        }
        
        function checkProspectingLevelUp() {
            // Max level is 10
            if (gs.prospectingLevel >= 10) return;
            
            // Determine level-up chance based on current level
            let levelUpChance = 0;
            switch(gs.prospectingLevel) {
                case 1: levelUpChance = 0.90; break; // 90%
                case 2: levelUpChance = 0.75; break; // 75%
                case 3: levelUpChance = 0.50; break; // 50%
                case 4: levelUpChance = 0.25; break; // 25%
                default: levelUpChance = 0.10; break; // 10% for level 5+
            }
            
            const roll = Math.random();
            console.log(`Prospecting roll: ${roll} vs ${levelUpChance} (Level ${gs.prospectingLevel})`);
            
            if (roll < levelUpChance) {
                gs.prospectingLevel++;
                save();
                updateProspectingDisplay();
                notify(`‚õèÔ∏è Prospecting Level UP! Now Level ${gs.prospectingLevel}!`, 'levelup');
            }
        }
        
        // Kitchen ingredient slot functions
        let kitchenIngredientSlot = null;
        let burnChance = 0.10; // 10% chance to burn
                
        function showKitchenInventoryMenu() {
            console.log('showKitchenInventoryMenu called');
            
            console.log('Full inventory:', gs.inventory);
            
            const itemCounts = {};
            for (const key in gs.inventory) {
                const itemId = gs.inventory[key];
                console.log('Checking item:', key, '=', itemId);
                console.log('  ITEM_DATA exists:', !!ITEM_DATA[itemId]);
                if (ITEM_DATA[itemId]) {
                    console.log('  cookable:', ITEM_DATA[itemId].cookable);
                }
                
                // Count items that are cookable
                if (ITEM_DATA[itemId] && ITEM_DATA[itemId].cookable) {
                    itemCounts[itemId] = (itemCounts[itemId] || 0) + 1;
                    console.log('  Added to menu!');
                }
            }
            
            console.log('Final item counts:', itemCounts);
            
            const existingMenu = document.getElementById('kitchen-inventory-menu');
            if (existingMenu) {
                existingMenu.remove();
                return;
            }
            
            const menu = document.createElement('div');
            menu.id = 'kitchen-inventory-menu';
            menu.style.cssText = 'position:fixed;bottom:300px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.98);border:3px solid #333;border-radius:10px;padding:15px;z-index:10001;min-width:200px;box-shadow:0 4px 20px rgba(0,0,0,0.5);';
            
            const header = document.createElement('div');
            header.style.cssText = 'font-weight:bold;margin-bottom:10px;color:#333;font-size:16px;';
            header.textContent = 'Select Ingredient:';
            menu.appendChild(header);
            
            if (Object.keys(itemCounts).length === 0) {
                const empty = document.createElement('div');
                empty.style.cssText = 'color:#999;font-style:italic;padding:10px;';
                empty.textContent = 'No cookable items';
                menu.appendChild(empty);
            } else {
                for (const itemId in itemCounts) {
                    const count = itemCounts[itemId];
                    const emoji = itemId === 'fish' ? 'üêü' : 'ü•ï';
                    const name = itemId === 'fish' ? 'Fish' : 'Carrot';
                    
                    const btn = document.createElement('div');
                    btn.style.cssText = 'width:100%;padding:12px;margin:5px 0;font-size:16px;border:2px solid #333;border-radius:8px;background:#fff;cursor:pointer;display:flex;justify-content:space-between;';
                    btn.innerHTML = '<span>' + emoji + ' ' + name + '</span><span style="color:#666;font-weight:bold;">x ' + count + '</span>';
                    btn.onclick = function() { selectKitchenIngredient(itemId); };
                    menu.appendChild(btn);
                }
            }
            
            const cancelBtn = document.createElement('div');
            cancelBtn.style.cssText = 'width:100%;padding:10px;margin-top:10px;background:#999;color:#fff;border:2px solid #666;border-radius:8px;cursor:pointer;text-align:center;';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = closeKitchenInventoryMenu;
            menu.appendChild(cancelBtn);
            
            document.body.appendChild(menu);
            console.log('Menu added to DOM');
        }
        
        function updateKitchenScore() {
            const display = document.getElementById('kitchen-score-display');
            if (display) {
                display.textContent = 'Score: ' + kitchenScore + ' / 5';
            }
        }
        
        function finishCooking() {
            console.log('Cooking complete!');
            
            // Roll for burn chance
            const roll = Math.random();
            const isBurnt = roll < burnChance;
            console.log('Burn roll:', roll, 'Burnt:', isBurnt);
            
            const result = document.getElementById('kitchen-result');
            
            // FIRST: Remove ingredient from inventory AND basket physics
            let removedKey = null;
            for (const key in gs.inventory) {
                if (gs.inventory[key] === kitchenIngredientSlot) {
                    delete gs.inventory[key];
                    removedKey = key;
                    console.log('Removed from inventory:', key);
                    break;
                }
            }
            
            // Also remove from basket physics if basket is open
            if (removedKey && basketEngine) {
                const bodyIndex = basketBodies.findIndex(b => b.itemKey === removedKey);
                if (bodyIndex !== -1) {
                    const body = basketBodies[bodyIndex];
                    World.remove(basketEngine.world, body);
                    basketBodies.splice(bodyIndex, 1);
                    console.log('Removed from basket physics:', removedKey);
                }
            }
            
            save();
            updateInventoryCounter();
            
            // THEN: Add food item (or burnt food) and XP
            if (isBurnt) {
                result.textContent = 'üî• OH NO! Food burnt! +1 Burnt Food';
                addItem('burnt_food', 1); // Note: itemId is 'burnt_food'
                addSkillXP('cooking', 5); // Half XP for burnt food
                notify('üíÄ Burnt the food!');
            } else {
                result.textContent = 'üéâ Cooked into food! +1 Food';
                addItem('food', 1);
                addSkillXP('cooking', 10);
                notify('‚úÖ Perfectly cooked!');
            }
            
            // Reset kitchen
            kitchenIngredientSlot = null;
            kitchenScore = 0;
            
            const icon = document.getElementById('kitchen-slot-icon');
            if (icon) icon.textContent = '+';
            
            const stirBtn = document.getElementById('stir-kitchen-btn');
            if (stirBtn) {
                stirBtn.style.background = '#ffe0e0';
                stirBtn.style.borderColor = '#ff6b6b';
            }
            
            updateKitchenScore();
            
            setTimeout(() => {
                result.textContent = '';
            }, 3000);
        }
        
        function selectKitchenIngredient(itemId) {
            console.log('Selected:', itemId);
            kitchenIngredientSlot = itemId;
            
            // Update slot icon
            const icon = document.getElementById('kitchen-slot-icon');
            if (icon) {
                icon.textContent = itemId === 'fish' ? 'üêü' : 'ü•ï';
            }
            
            // Make stir button green (ready to cook)
            const stirBtn = document.getElementById('stir-kitchen-btn');
            if (stirBtn) {
                stirBtn.style.background = '#4ade80';
                stirBtn.style.borderColor = '#22c55e';
            }
            
            // Reset score
            kitchenScore = 0;
            updateKitchenScore();
            
            closeKitchenInventoryMenu();
            notify('Ready to cook! Click STIR 5 times!');
        }
        
        function closeKitchenInventoryMenu() {
            const menu = document.getElementById('kitchen-inventory-menu');
            if (menu) menu.remove();
        }
        
function initKitchenGame() {
            kitchenScore = 0;
            kitchenActive = false;
            kitchenFlashing = false;
            document.getElementById('kitchen-score-display').textContent = 'Score: 0 / 5';
            document.getElementById('kitchen-result').textContent = '';
            document.getElementById('kitchen-spoon').style.transform = 'scale(1)';
            startKitchenGame();
        }
        
        function startKitchenGame() {
            kitchenActive = true;
            kitchenScore = 0;
            scheduleKitchenFlash();
        }
        
        function scheduleKitchenFlash() {
            if (!kitchenActive) return;
            
            const delay = 1000 + Math.random() * 2000; // 1-3 seconds
            setTimeout(() => {
                if (!kitchenActive) return;
                kitchenFlashing = true;
                const spoon = document.getElementById('kitchen-spoon');
                spoon.style.transform = 'scale(1.5)';
                spoon.style.filter = 'brightness(1.5)';
                
                setTimeout(() => {
                    kitchenFlashing = false;
                    spoon.style.transform = 'scale(1)';
                    spoon.style.filter = 'brightness(1)';
                    
                    if (kitchenActive && kitchenScore < 5) {
                        scheduleKitchenFlash();
                    }
                }, 800);
            }, delay);
        }
        
        function stirKitchen() {
            console.log('Stir clicked, ingredient:', kitchenIngredientSlot, 'score:', kitchenScore);
            
            // Check if ingredient is selected
            if (!kitchenIngredientSlot) {
                notify('‚ùå Select an ingredient first!');
                return;
            }
            
            // Increment score
            kitchenScore++;
            updateKitchenScore();
            
            // Check if done (5 clicks)
            if (kitchenScore >= 5) {
                finishCooking();
            }
            if (!kitchenActive) return;
            
            if (kitchenFlashing) {
                kitchenScore++;
                document.getElementById('kitchen-score-display').textContent = 'Score: ' + kitchenScore + ' / 5';
                
                if (kitchenScore >= 5) {
                    endKitchenGame(true);
                }
            } else {
                endKitchenGame(false);
            }
        }
        
        function endKitchenGame(success) {
            kitchenActive = false;
            kitchenFlashing = false;
            const result = document.getElementById('kitchen-result');
            
            if (success) {
                result.textContent = 'üéâ Perfect dish! +1 Food';
                addItem('food', 1);
                addSkillXP('cooking', 10);
                clearKitchenIngredient();
                notify('‚úÖ Cooked ' + kitchenIngredientSlot + ' into food!');
            } else {
                result.textContent = '‚ùå Burned! Wrong timing!';
                clearKitchenIngredient();
            }
            
            setTimeout(() => initKitchenGame(), 2000);
        }
        
        function stopKitchenGame() {
            kitchenActive = false;
            kitchenFlashing = false;
        }
        
        // Grill: Temperature control - keep temp in green zone
        let grillTemp = 50;
        let grillActive = false;
        let grillTimer = null;
        let grillTimeLeft = 10.0;
        let grillGoodTime = 0;
        
        function initGrillGame() {
            grillTemp = 50;
            grillActive = false;
            grillTimeLeft = 10.0;
            grillGoodTime = 0;
            updateGrillDisplay();
            document.getElementById('grill-result').textContent = '';
            document.getElementById('grill-timer-display').textContent = 'Time: 10.0s';
            startGrillGame();
        }
        
        function startGrillGame() {
            grillActive = true;
            grillTimeLeft = 10.0;
            grillGoodTime = 0;
            
            grillTimer = setInterval(() => {
                grillTimeLeft -= 0.1;
                document.getElementById('grill-timer-display').textContent = 'Time: ' + grillTimeLeft.toFixed(1) + 's';
                
                // Temperature naturally drops
                grillTemp = Math.max(0, grillTemp - 0.5);
                updateGrillDisplay();
                
                // Check if in green zone (40-60%)
                if (grillTemp >= 40 && grillTemp <= 60) {
                    grillGoodTime += 0.1;
                }
                
                if (grillTimeLeft <= 0) {
                    endGrillGame();
                }
            }, 100);
        }
        
        function grillHeatUp() {
            if (!grillActive) return;
            grillTemp = Math.min(100, grillTemp + 5);
            updateGrillDisplay();
        }
        
        function grillCoolDown() {
            if (!grillActive) return;
            grillTemp = Math.max(0, grillTemp - 5);
            updateGrillDisplay();
        }
        
        function updateGrillDisplay() {
            const bar = document.getElementById('grill-temp-bar');
            const display = document.getElementById('grill-temp-display');
            bar.style.width = grillTemp + '%';
            display.textContent = 'Temp: ' + Math.round(grillTemp) + '%';
            
            // Color based on temp
            if (grillTemp >= 40 && grillTemp <= 60) {
                bar.style.background = '#4caf50';
            } else if (grillTemp > 60) {
                bar.style.background = '#ff6b6b';
            } else {
                bar.style.background = '#2196f3';
            }
        }
        
        function endGrillGame() {
            clearInterval(grillTimer);
            grillActive = false;
            const result = document.getElementById('grill-result');
            
            if (grillGoodTime >= 7.0) {
                result.textContent = 'üéâ Perfectly grilled! +1 Food';
                addItem('food', 1);
                addSkillXP('cooking', 15);
            } else {
                result.textContent = '‚ùå Over/undercooked! (' + grillGoodTime.toFixed(1) + 's/7s in zone)';
            }
            
            setTimeout(() => initGrillGame(), 2500);
        }
        
        function stopGrillGame() {
            clearInterval(grillTimer);
            grillActive = false;
        }
        
// ===== GAME ACTIONS =====
        function hatchSlime() {
            console.log('Hatching slime');
            
            // Randomly select one of 5 slimes (equal chances)
            const slimeVariants = [
                'slime1.png',    // Blue slime
                'slime2.png',    // Orange/red slime
                'slime3.png',    // Green slime
                'slime4.png',    // Yellow slime
                'slime5.png'     // Pink slime
            ];
            
            const randomIndex = Math.floor(Math.random() * slimeVariants.length);
            const chosenSlime = slimeVariants[randomIndex];
            
            // Save which slime was chosen
            gs.hatched = true;
            gs.slimeVariant = chosenSlime;
            
            // Set the slime image
            const slimeElement = document.getElementById('slime-square');
            const imagePath = `./slimehearth-assets/images/${chosenSlime}`;
            console.log('Trying to load slime image from:', imagePath);
            slimeElement.style.backgroundImage = `url('${imagePath}')`;
            slimeElement.classList.add('visible');
            
            // Check if image loaded
            setTimeout(() => {
                const img = new Image();
                img.onload = () => {
                    console.log('‚úÖ Slime image loaded successfully!');
                };
                img.onerror = () => {
                    console.error('‚ùå Failed to load slime image!');
                    notify('‚ö†Ô∏è Can\'t load slime images. Files may be missing or browser blocking local files.');
                };
                img.src = imagePath;
            }, 500);
            
            // Prompt for slime name
            setTimeout(() => {
                const name = prompt('üéâ Your slime has hatched!\n\nWhat would you like to name your slime?', 'Slime');
                if (name && name.trim() !== '') {
                    gs.slimeName = name.trim();
                    notify(`Meet ${gs.slimeName}! üéâ`);
                } else {
                    gs.slimeName = 'Slime';
                    notify('üéâ Your slime has hatched!');
                }
                save();
                updateUI();
            }, 600);
            
            save();
            updateUI();
        }
        
        // Make hatchSlime globally accessible
        window.hatchSlime = hatchSlime;
        
        // Navigation - Fishing menu
        document.getElementById('goto-fishing-menu').onclick = () => switchRoom('fishing-menu-room');
        document.getElementById('back-to-area').onclick = () => switchRoom('area-room');
        document.getElementById('goto-pond').onclick = () => switchRoom('fishing-pond-room');
        document.getElementById('goto-river').onclick = () => switchRoom('fishing-river-room');
        document.getElementById('leave-pond').onclick = () => {
            stopFishing();
            switchRoom('fishing-menu-room');
        };
        document.getElementById('leave-river').onclick = () => {
            stopFishing();
            riverActive = false;
            clearInterval(riverFishingInterval);
            switchRoom('fishing-menu-room');
        };
        
        // Fishing buttons
        // Pond: hold to fish
        const pondBtn = document.getElementById('fish-pond-btn');
        pondBtn.addEventListener('mousedown', () => startFishing('pond'));
        pondBtn.addEventListener('mouseup', stopFishing);
        pondBtn.addEventListener('mouseleave', stopFishing);
        pondBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startFishing('pond'); });
        pondBtn.addEventListener('touchend', stopFishing);
        
        // River: hold to start, release to stop
        const riverBtn = document.getElementById('cast-river');
        
        riverBtn.addEventListener('mousedown', startRiverFishing);
        riverBtn.addEventListener('mouseup', stopRiverBar);
        riverBtn.addEventListener('mouseleave', () => {
            if (riverActive) stopRiverBar();
        });
        
        riverBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startRiverFishing();
        });
        riverBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            stopRiverBar();
        });
        
        
        document.getElementById('goto-adventure').onclick = () => {
            switchRoom('adventure-room');
            displayAdventureDoors();
        };
        document.getElementById('back-to-area-adventure').onclick = () => switchRoom('area-room');
        
        document.getElementById('goto-farming-menu').onclick = () => switchRoom('farming-menu-room');
        document.getElementById('back-to-area-farm').onclick = () => switchRoom('area-room');
        document.getElementById('goto-garden').onclick = () => {
            switchRoom('farming-garden-room');
            setTimeout(() => initGardenPlots(), 0);
        };
        document.getElementById('goto-field').onclick = () => {
            switchRoom('farming-field-room');
            initFieldGame();
        };
        document.getElementById('leave-garden').onclick = () => {
            stopGardenGame();
            switchRoom('farming-menu-room');
        };
        document.getElementById('leave-field').onclick = () => {
            stopFieldGame();
            switchRoom('farming-menu-room');
        };
        
        // OLD SHOP BUTTONS (replaced by grid)
        /*
        document.getElementById('buy-fish').onclick = () => {
            if (gs.coins >= 10) {
                gs.coins -= 10;
                addItem('fish', 1);
                save();
            } else {
                notify('Not enough coins!');
            }
        };
        
        document.getElementById('buy-carrot').onclick = () => {
            if (gs.coins >= 5) {
                gs.coins -= 5;
                addItem('carrot', 1);
                save();
            } else {
                notify('Not enough coins!');
            }
        };
        */
        
        // Debug functions
        document.getElementById('fill-bag').onclick = () => {
            addItem('fish', 5);
            addItem('carrot', 5);
            addItem('food', 5);
        };
        
        document.getElementById('toggle-debug-console').onclick = () => {
            const debugConsole = document.getElementById('debug-console');
            if (debugConsole.style.display === 'none') {
                debugConsole.style.display = 'block';
                notify('Debug console shown');
            } else {
                debugConsole.style.display = 'none';
                notify('Debug console hidden');
            }
        };
        
        document.getElementById('clear-bag').onclick = () => {
            gs.inventory = {};
            save();
            notify('Inventory cleared');
            updateInventoryCounter();
            if (basketEngine) populateBasket();
        };
        
        document.getElementById('fill-geodes').onclick = () => {
            addItem('small_geode', 6);
            notify('Added 6 Small Geodes!');
        };
        
        document.getElementById('give-coins').onclick = () => {
            gs.coins += 1000;
            save();
            updateUI();
            notify('Added 1000 coins!');
        };
        
        const resetBtn = document.getElementById('reset-game');
        if (resetBtn) {
            resetBtn.onclick = () => {
                const confirmed1 = confirm('‚ö†Ô∏è RESET ENTIRE GAME? This will delete all progress and return to the hatch screen. Are you sure?');
                if (confirmed1) {
                    const confirmed2 = confirm('üö® FINAL WARNING: All your progress will be lost! Continue?');
                    if (confirmed2) {
                        // Clear ALL localStorage (safer than targeting specific keys)
                        localStorage.clear();
                        notify('üîÑ Game Reset! Reloading...', 'achievement');
                        setTimeout(() => location.reload(), 1000);
                    }
                }
            };
            resetBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                resetBtn.click();
            });
        }
        
        
        // document.getElementById('tap-garden-btn').onclick = tapGarden; // OLD - button doesn't exist anymore
        document.querySelectorAll('.plant-btn').forEach(btn => {
            btn.onclick = () => plantInField(btn.dataset.plant);
        });
        document.getElementById('reset-field-btn').onclick = resetField;
        

        document.getElementById('goto-cooking-menu').onclick = () => {
            switchRoom('cooking-menu-room');
            setTimeout(() => initHearth(), 0);
        };
        document.getElementById('back-to-area-cook').onclick = () => switchRoom('area-room');
        
        
        document.getElementById('stir-kitchen-btn').onclick = stirKitchen;
        document.getElementById('grill-heat-up').onclick = grillHeatUp;
        document.getElementById('grill-cool-down').onclick = grillCoolDown;
        */
        
        // Shack button handlers
        document.getElementById('shack-geode-slot').onclick = showShackInventoryMenu;
        document.getElementById('crack-geode-btn').onclick = crackGeode;
        document.getElementById('leave-shack').onclick = () => switchRoom('area-room');
        
        // Room button handlers
        document.getElementById('goto-wardrobe').onclick = () => {
            switchRoom('wardrobe-room');
            displayHats();
        };
        document.getElementById('goto-trophies').onclick = () => {
            switchRoom('trophies-room');
            displayTrophies();
            displayKeys();
        };
        document.getElementById('leave-wardrobe').onclick = () => switchRoom('room-room');
        document.getElementById('leave-trophies').onclick = () => switchRoom('room-room');

        // Music control
        const bgMusic = document.getElementById('bg-music');
        const musicBtn = document.getElementById('music-btn');
        let musicPlaying = false;
        
        bgMusic.volume = 0.3;
        
        function startMusic() {
            bgMusic.play().then(() => {
                musicPlaying = true;
                updateMusicButton();
            }).catch(() => {
                musicPlaying = false;
                updateMusicButton();
            });
        }
        
        const musicToggleBtn = document.getElementById('music-toggle-btn');
        const musicStatus = document.getElementById('music-status');
        
        function updateMusicButton() {
            if (musicPlaying) {
                musicToggleBtn.textContent = 'üîä';
                musicToggleBtn.style.background = '#4caf50';
                musicStatus.textContent = 'Music Playing';
                musicStatus.style.color = '#4caf50';
            } else {
                musicToggleBtn.textContent = 'üîá';
                musicToggleBtn.style.background = '#f44336';
                musicStatus.textContent = 'Music Muted';
                musicStatus.style.color = '#f44336';
            }
        }
        
        musicToggleBtn.onclick = () => {
            if (musicPlaying) {
                bgMusic.pause();
                musicPlaying = false;
            } else {
                bgMusic.play();
                musicPlaying = true;
            }
            updateMusicButton();
        };
        
        startMusic();
        document.addEventListener('click', function() {
            if (!musicPlaying) startMusic();
        }, { once: true });
        

        // Volume controls
        const musicVolumeSlider = document.getElementById('music-volume-slider');
        const musicVolumeDisplay = document.getElementById('music-volume-display');
        const sfxVolumeSlider = document.getElementById('sfx-volume-slider');
        const sfxVolumeDisplay = document.getElementById('sfx-volume-display');
        
        musicVolumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            bgMusic.volume = volume;
            musicVolumeDisplay.textContent = e.target.value + '%';
            
            // Auto-play if volume increased from 0
            if (volume > 0 && !musicPlaying) {
                bgMusic.play();
                musicPlaying = true;
                updateMusicButton();
            }
            // Auto-pause if volume set to 0
            if (volume === 0 && musicPlaying) {
                bgMusic.pause();
                musicPlaying = false;
                updateMusicButton();
            }
        });
        
        sfxVolumeSlider.addEventListener('input', (e) => {
            sfxVolumeDisplay.textContent = e.target.value + '%';
            // SFX volume stored for future use
            gs.sfxVolume = e.target.value / 100;
            save();
        });
        

        // Debug console
        const debugLog = document.getElementById('debug-log');
        const originalLog = console.log;
        const originalError = console.error;
        
        function addDebugLine(msg, color) {
            const line = document.createElement('div');
            line.style.color = color || '#0f0';
            line.style.marginBottom = '3px';
            line.textContent = msg;
            debugLog.appendChild(line);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            while (debugLog.children.length > 50) {
                debugLog.removeChild(debugLog.firstChild);
            }
        }
        
        console.log = function() {
            const msg = Array.from(arguments).join(' ');
            originalLog.apply(console, arguments);
            addDebugLine(msg, '#0f0');
        };
        
        console.error = function() {
            const msg = 'ERROR: ' + Array.from(arguments).join(' ');
            originalError.apply(console, arguments);
            addDebugLine(msg, '#f00');
        };
        
        console.log('Debug console initialized');
        console.log('Game version: v0.388');
        
        // ===== TROPHIES (TOOLS) =====
        function displayTrophies() {
            const display = document.getElementById('trophies-display');
            if (!display) return;
            
            display.innerHTML = '';
            
            for (const toolId in TOOLS_DATA) {
                const tool = TOOLS_DATA[toolId];
                const owned = gs.tools[toolId] || false;
                
                const toolDiv = document.createElement('div');
                toolDiv.style.cssText = 'padding:15px;margin:10px 0;border:3px solid ' + (owned ? '#4ade80' : '#d1d5db') + ';border-radius:10px;background:' + (owned ? '#f0fdf4' : '#f3f4f6') + ';' + (owned ? '' : 'opacity:0.5;');
                
                toolDiv.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="font-size:20px;font-weight:bold;margin-bottom:5px;color:${owned ? '#000' : '#9ca3af'};">
                                ${tool.icon} ${tool.name}
                            </div>
                            <div style="color:#666;font-size:14px;margin-bottom:8px;">
                                ${tool.description}
                            </div>
                        </div>
                        <div style="margin-left:15px;">
                            ${owned ? 
                                '<div style="background:#4ade80;color:#fff;padding:10px 20px;border-radius:8px;font-weight:bold;font-size:16px;">‚úì UNLOCKED</div>' :
                                '<div style="background:#9ca3af;color:#fff;padding:10px 20px;border-radius:8px;font-weight:bold;font-size:16px;">üîí LOCKED</div>'
                            }
                        </div>
                    </div>
                `;
                
                display.appendChild(toolDiv);
            }
            
            if (Object.keys(TOOLS_DATA).length === 0) {
                display.innerHTML = '<p style="color:#999;text-align:center;padding:40px;">No tools available yet...</p>';
            }
        }
        
        // ===== SHOP GRID DISPLAY =====
        function displayShopGrid() {
            const grid = document.getElementById('shop-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // Define shop items with icons
            const shopItems = [
                { id: 'carrot_seeds', name: 'üå± Carrot Seeds', icon: 'üå±', price: 3, type: 'item' },
                { id: 'hammer', name: 'Hammer', icon: 'üî®', price: 50, type: 'tool', data: TOOLS_DATA.hammer },
                { id: 'fishing_rod', name: 'Fishing Rod', icon: 'üé£', price: 100, type: 'tool', data: TOOLS_DATA.fishing_rod },
                { id: 'better_net', name: 'Better Net', icon: 'ü•Ö', price: 250, type: 'tool', data: TOOLS_DATA.better_net },
                { id: 'golden_hoe', name: 'Golden Hoe', icon: '‚öíÔ∏è', price: 500, type: 'tool', data: TOOLS_DATA.golden_hoe },
                { id: 'top_hat', name: 'Top Hat', icon: 'üé©', price: 100, type: 'hat', data: HATS_DATA.top_hat },
                { id: 'party_hat', name: 'Party Hat', icon: 'üéâ', price: 150, type: 'hat', data: HATS_DATA.party_hat },
                { id: 'cowboy_hat', name: 'Cowboy Hat', icon: 'ü§†', price: 200, type: 'hat', data: HATS_DATA.cowboy_hat },
                { id: 'crown', name: 'Crown', icon: 'üëë', price: 500, type: 'hat', data: HATS_DATA.crown }
            ];
            
            shopItems.forEach(item => {
                const isOwned = (item.type === 'tool' && gs.tools[item.id]) || (item.type === 'hat' && gs.hats[item.id]);
                
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = `
                    background: ${isOwned ? '#d1fae5' : '#fff'};
                    border: 2px solid ${isOwned ? '#10b981' : '#fbbf24'};
                    border-radius: 8px;
                    padding: 6px;
                    text-align: center;
                    cursor: ${isOwned ? 'default' : 'pointer'};
                    transition: all 0.2s;
                    position: relative;
                `;
                
                if (!isOwned) {
                    itemDiv.onmouseenter = () => itemDiv.style.transform = 'scale(1.05)';
                    itemDiv.onmouseleave = () => itemDiv.style.transform = 'scale(1)';
                }
                
                itemDiv.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 2px;">${item.icon}</div>
                    <div style="font-size: 8px; font-weight: bold; margin-bottom: 1px; color: #333; line-height: 1.1;">${item.name}</div>
                    <div style="font-size: 9px; font-weight: bold; color: #f59e0b;">üí∞ ${item.price}</div>
                    ${isOwned ? '<div style="margin-top:2px;font-size:8px;color:#10b981;font-weight:bold;">‚úì</div>' : ''}
                `;
                
                if (!isOwned) {
                    itemDiv.onclick = () => buyShopItem(item);
                }
                
                grid.appendChild(itemDiv);
            });
        }
        
        function buyShopItem(item) {
            if (gs.coins < item.price) {
                notify('‚ùå Not enough coins!', 'warning');
                return;
            }
            
            if (item.type === 'item') {
                // Buy regular item
                gs.coins -= item.price;
                addItem(item.id, 1);
                save();
                updateUI();
                notify(`‚úì Bought ${item.name}!`);
            } else if (item.type === 'tool') {
                // Buy tool
                if (gs.tools[item.id]) {
                    notify('‚ùå You already own this!', 'warning');
                    return;
                }
                gs.coins -= item.price;
                gs.tools[item.id] = true;
                save();
                updateUI();
                displayShopGrid();
                notify(`‚úì Purchased ${item.icon} ${item.name}!`);
                
                // Update crack button if hammer purchased
                if (item.id === 'hammer') {
                    updateCrackButton();
                }
            } else if (item.type === 'hat') {
                // Buy hat
                if (gs.hats[item.id]) {
                    notify('‚ùå You already own this!', 'warning');
                    return;
                }
                gs.coins -= item.price;
                gs.hats[item.id] = true;
                save();
                updateUI();
                displayShopGrid();
                notify(`‚úì Purchased ${item.icon} ${item.name}!`);
            }
        }
        
        function displayShopTools() {
            const display = document.getElementById('shop-tools-display');
            if (!display) return;
            
            display.innerHTML = '';
            
            for (const toolId in TOOLS_DATA) {
                const tool = TOOLS_DATA[toolId];
                const owned = gs.tools[toolId] || false;
                
                const toolDiv = document.createElement('div');
                toolDiv.style.cssText = 'padding:15px;margin:10px 0;border:3px solid ' + (owned ? '#4ade80' : '#fbbf24') + ';border-radius:10px;background:#fff;';
                
                toolDiv.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="font-size:18px;font-weight:bold;margin-bottom:5px;">
                                ${tool.icon} ${tool.name}
                            </div>
                            <div style="color:#666;font-size:13px;margin-bottom:8px;">
                                ${tool.description}
                            </div>
                            <div style="color:#f59e0b;font-weight:bold;font-size:15px;">
                                üí∞ ${tool.cost} coins
                            </div>
                        </div>
                        <div style="margin-left:15px;">
                            ${owned ? 
                                '<div style="background:#4ade80;color:#fff;padding:8px 16px;border-radius:8px;font-weight:bold;font-size:14px;">‚úì OWNED</div>' :
                                '<button onclick="buyTool(\'' + toolId + '\')" style="background:#fbbf24;color:#fff;padding:8px 16px;border:2px solid #f59e0b;border-radius:8px;cursor:pointer;font-weight:bold;font-size:14px;">BUY</button>'
                            }
                        </div>
                    </div>
                `;
                
                display.appendChild(toolDiv);
            }
        }
        
        function buyTool(toolId) {
            const tool = TOOLS_DATA[toolId];
            if (!tool) return;
            
            if (gs.tools[toolId]) {
                notify('‚ùå You already own this!', 'warning');
                return;
            }
            
            if (gs.coins < tool.cost) {
                notify('‚ùå Not enough coins!', 'warning');
                return;
            }
            
            gs.coins -= tool.cost;
            gs.tools[toolId] = true;
            save();
            updateUI();
            displayShopTools(); // Update shop display
            
            // If hammer was purchased, update the crack button
            if (toolId === 'hammer') {
                updateCrackButton();
            }
            
            notify('‚úì Purchased ' + tool.name + '!');
        }
        
        // ===== HATS (COSMETICS) =====
        function displayHats() {
            const display = document.getElementById('hats-display');
            if (!display) return;
            
            display.innerHTML = '';
            
            for (const hatId in HATS_DATA) {
                const hat = HATS_DATA[hatId];
                const owned = gs.hats[hatId] || false;
                const equipped = gs.equippedHat === hatId;
                
                const hatDiv = document.createElement('div');
                hatDiv.style.cssText = 'padding:12px;margin:8px 0;border:3px solid ' + (equipped ? '#fbbf24' : (owned ? '#4ade80' : '#d1d5db')) + ';border-radius:10px;background:' + (equipped ? '#fef3c7' : (owned ? '#f0fdf4' : '#f3f4f6')) + ';' + (owned ? '' : 'opacity:0.5;');
                
                hatDiv.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="font-size:18px;font-weight:bold;margin-bottom:3px;color:${owned ? '#000' : '#9ca3af'};">
                                ${hat.icon} ${hat.name}
                            </div>
                            <div style="color:#666;font-size:13px;">
                                ${hat.description}
                            </div>
                        </div>
                        <div style="margin-left:15px;">
                            ${equipped ? 
                                '<div style="background:#fbbf24;color:#fff;padding:8px 16px;border-radius:8px;font-weight:bold;font-size:14px;">‚úì EQUIPPED</div>' :
                                (owned ?
                                    '<button onclick="equipHat(\'' + hatId + '\')" style="background:#4ade80;color:#fff;padding:8px 16px;border:2px solid #22c55e;border-radius:8px;cursor:pointer;font-weight:bold;font-size:14px;">EQUIP</button>' :
                                    '<div style="background:#9ca3af;color:#fff;padding:8px 16px;border-radius:8px;font-weight:bold;font-size:14px;">üîí LOCKED</div>')
                            }
                        </div>
                    </div>
                `;
                
                display.appendChild(hatDiv);
            }
            
            if (Object.keys(HATS_DATA).length === 0) {
                display.innerHTML = '<p style="color:#999;text-align:center;padding:40px;">No hats available yet...</p>';
            }
        }
        
        function equipHat(hatId) {
            if (!gs.hats[hatId]) {
                notify('‚ùå You don\'t own this hat!', 'warning');
                return;
            }
            
            gs.equippedHat = hatId;
            save();
            displayHats();
            notify(`Equipped ${HATS_DATA[hatId].icon} ${HATS_DATA[hatId].name}!`);
        }
        
        function unequipHat() {
            gs.equippedHat = null;
            save();
            displayHats();
            notify('Hat removed!');
        }
        
        // ===== KEYS =====
        function displayKeys() {
            const display = document.getElementById('keys-display');
            if (!display) return;
            
            display.innerHTML = '';
            
            if (Object.keys(KEYS_DATA).length === 0) {
                display.innerHTML = '<p style="color:#999;text-align:center;padding:40px;">No keys yet... More areas coming soon!</p>';
                return;
            }
            
            for (const keyId in KEYS_DATA) {
                const key = KEYS_DATA[keyId];
                const owned = gs.keys[keyId] || false;
                
                const keyDiv = document.createElement('div');
                keyDiv.style.cssText = 'padding:15px;margin:10px 0;border:3px solid ' + (owned ? '#fbbf24' : '#d1d5db') + ';border-radius:10px;background:' + (owned ? '#fef3c7' : '#f3f4f6') + ';' + (owned ? '' : 'opacity:0.5;');
                
                keyDiv.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="font-size:20px;font-weight:bold;margin-bottom:5px;color:${owned ? '#000' : '#9ca3af'};">
                                ${key.icon} ${key.name}
                            </div>
                            <div style="color:#666;font-size:14px;margin-bottom:8px;">
                                ${key.description}
                            </div>
                        </div>
                        <div style="margin-left:15px;">
                            ${owned ? 
                                '<div style="background:#fbbf24;color:#fff;padding:10px 20px;border-radius:8px;font-weight:bold;font-size:16px;">‚úì OBTAINED</div>' :
                                '<div style="background:#9ca3af;color:#fff;padding:10px 20px;border-radius:8px;font-weight:bold;font-size:16px;">üîí LOCKED</div>'
                            }
                        </div>
                    </div>
                `;
                
                display.appendChild(keyDiv);
            }
        }
        
        function displayShopHats() {
            const display = document.getElementById('shop-hats-display');
            if (!display) return;
            
            display.innerHTML = '';
            
            for (const hatId in HATS_DATA) {
                const hat = HATS_DATA[hatId];
                const owned = gs.hats[hatId] || false;
                
                const hatDiv = document.createElement('div');
                hatDiv.style.cssText = 'padding:15px;margin:10px 0;border:3px solid ' + (owned ? '#4ade80' : '#a78bfa') + ';border-radius:10px;background:#fff;';
                
                hatDiv.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="font-size:18px;font-weight:bold;margin-bottom:5px;">
                                ${hat.icon} ${hat.name}
                            </div>
                            <div style="color:#666;font-size:13px;margin-bottom:8px;">
                                ${hat.description}
                            </div>
                            <div style="color:#f59e0b;font-weight:bold;font-size:15px;">
                                üí∞ ${hat.cost} coins
                            </div>
                        </div>
                        <div style="margin-left:15px;">
                            ${owned ? 
                                '<div style="background:#4ade80;color:#fff;padding:8px 16px;border-radius:8px;font-weight:bold;font-size:14px;">‚úì OWNED</div>' :
                                '<button onclick="buyHat(\'' + hatId + '\')" style="background:#a78bfa;color:#fff;padding:8px 16px;border:2px solid #7c3aed;border-radius:8px;cursor:pointer;font-weight:bold;font-size:14px;">BUY</button>'
                            }
                        </div>
                    </div>
                `;
                
                display.appendChild(hatDiv);
            }
        }
        
        function buyHat(hatId) {
            const hat = HATS_DATA[hatId];
            if (!hat) return;
            
            if (gs.hats[hatId]) {
                notify('‚ùå You already own this!', 'warning');
                return;
            }
            
            if (gs.coins < hat.cost) {
                notify('‚ùå Not enough coins!', 'warning');
                return;
            }
            
            gs.coins -= hat.cost;
            gs.hats[hatId] = true;
            save();
            updateUI();
            displayShopHats();
            notify(`‚úì Purchased ${hat.icon} ${hat.name}!`);
        }
        
        // ===== ADVENTURE (DOORS & KEYS) =====
        function displayAdventureDoors() {
            const display = document.getElementById('adventure-doors');
            if (!display) return;
            
            display.innerHTML = '';
            
            // Water Door - requires Water Key
            const hasWaterKey = gs.keys.water_key || false;
            
            const waterDoor = document.createElement('div');
            waterDoor.style.cssText = 'padding:20px;margin:15px 0;border:4px solid ' + (hasWaterKey ? '#3b82f6' : '#9ca3af') + ';border-radius:12px;background:' + (hasWaterKey ? '#dbeafe' : '#f3f4f6') + ';cursor:' + (hasWaterKey ? 'pointer' : 'not-allowed') + ';' + (hasWaterKey ? '' : 'opacity:0.6;');
            
            waterDoor.innerHTML = `
                <div style="text-align:center;">
                    <div style="font-size:48px;margin-bottom:10px;">üö™</div>
                    <div style="font-size:24px;font-weight:bold;margin-bottom:8px;color:${hasWaterKey ? '#1e40af' : '#6b7280'};">
                        üíß Water Door
                    </div>
                    <div style="color:#666;font-size:14px;margin-bottom:12px;">
                        ${hasWaterKey ? 'Click to enter!' : 'üîí Requires Water Key (10% from fishing)'}
                    </div>
                    ${hasWaterKey ? '<div style="background:#3b82f6;color:#fff;padding:10px 20px;border-radius:8px;display:inline-block;font-weight:bold;">ENTER ‚Üí</div>' : ''}
                </div>
            `;
            
            if (hasWaterKey) {
                waterDoor.onclick = () => {
                    notify('üö™ Water Door coming soon!');
                    // TODO: Open water door area
                };
            }
            
            display.appendChild(waterDoor);
        }
        
        
        // ===== PRELOAD FISH IMAGES FOR MATTER.JS =====
        // Matter.js sprite textures just need the image URL/path, not the Image object
        // The images will be loaded by Matter's renderer when needed
        
        function preloadFishImages() {
            // Just verify the images exist by attempting to load them
            const fishImagesToLoad = ['fish1', 'fish2', 'fish3', 'fish4'];
            
            fishImagesToLoad.forEach(fishId => {
                const img = new Image();
                img.onload = () => {
                    console.log(`‚úÖ Fish image verified: ${fishId}.png`);
                };
                img.onerror = () => {
                    console.error(`‚ùå Failed to load ${fishId}.png - check file path!`);
                };
                img.src = ITEM_IMAGES[fishId];
            });
        }
        
        // Verify images on page load
        preloadFishImages();
        
// ===== INIT =====
        load();
        updateUI();
    </script>
</body>
</html>